<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueRiot Syndicate - TL Dashboard</title>
    <style>
/* ===== BLUERIOT CYBERPUNK THEME ===== */
:root {
    --primary-blue: #00F0FF;
    --secondary-blue: #0A7AFF;
    --dark-bg: #0A0E27;
    --card-bg: #13182E;
    --text-primary: #FFFFFF;
    --text-secondary: #8B9DC3;
    --error: #FF4757;
    --border-color: #1E2749;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #000000;
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

/* ===== SCREENS ===== */
.screen {
    display: none;
}

.screen.active {
    display: block;
}

/* ===== LOGIN ===== */
.login-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-header {
    text-align: center;
    margin-bottom: 40px;
}

.logo {
    width: 140px;
    height: auto;
    margin-bottom: 24px;
    filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.3));
}

.login-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 12px;
    text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
}

.login-header p {
    font-size: 15px;
    color: var(--text-secondary);
}

/* Language Selector */
.language-selector {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 1000;
}

.language-selector button {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.language-selector button:hover {
    border-color: var(--primary-blue);
    background: var(--dark-bg);
}

.language-selector button.active {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: #000;
    font-weight: 600;
}

.login-form {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 14px 16px;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 15px;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
}

.form-group input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

.login-footer {
    margin-top: 24px;
    text-align: center;
}

.login-footer p {
    font-size: 14px;
    color: var(--text-secondary);
}

.login-footer a {
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
}

/* ===== BUTTONS ===== */
.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
    color: var(--dark-bg);
    width: 100%;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 240, 255, 0.4);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
}

.btn-google {
    background: white;
    color: #333;
    border: 1px solid #ddd;
    width: 100%;
}

.btn-google:hover {
    background: #f8f8f8;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-google:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* ===== NAVBAR ===== */
.navbar {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.navbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-blue);
}

.navbar-logo {
    width: 40px;
    height: auto;
}

.navbar-menu {
    display: flex;
    align-items: center;
    gap: 20px;
}

.user-email {
    font-size: 14px;
    color: var(--text-secondary);
}

/* ===== DASHBOARD ===== */
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 24px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.dashboard-header h1 {
    font-size: 32px;
    font-weight: 700;
}

.dashboard-header .btn {
    width: auto;
}

/* ===== TOURS GRID ===== */
.tours-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
}

.tour-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.tour-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 240, 255, 0.2);
}

.tour-code {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-blue);
    background: rgba(0, 240, 255, 0.1);
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 12px;
}

.tour-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 12px;
}

.tour-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    color: var(--text-secondary);
    font-size: 14px;
}

.loading {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px;
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 14, 39, 0.95);
    backdrop-filter: blur(10px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 90vw;
    max-width: 500px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.modal-content form {
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    padding: 24px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--dark-bg);
    color: var(--text-primary);
}

.modal-content form {
    padding: 24px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

.modal-actions .btn {
    flex: 1;
    width: auto;
}

/* ===== ERROR MESSAGE ===== */
.error-message {
    display: none;
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid var(--error);
    color: var(--error);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 16px;
}

.error-message.show {
    display: block;
}

/* ===== TABS ===== */
.tabs {
    display: flex;
    gap: 8px;
    border-bottom: 1px solid var(--border-color);
    padding: 0 24px;
    overflow-x: auto;
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
    white-space: nowrap;
    font-size: 14px;
}

.tab-btn.active {
    color: var(--primary-blue);
    border-bottom-color: var(--primary-blue);
}

.tab-btn:hover {
    color: var(--text-primary);
}

.tab-content {
    padding: 24px;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

/* ===== CARDS FOR DATA ===== */
.data-card {
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
}

.data-card:hover {
    border-color: var(--primary-blue);
}

.data-card h4 {
    color: var(--primary-blue);
    margin-bottom: 8px;
}

.data-card .meta {
    color: var(--text-secondary);
    font-size: 13px;
    margin-bottom: 8px;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-right: 4px;
}

.badge-green {
    background: rgba(0, 255, 136, 0.1);
    color: #00FF88;
    border: 1px solid #00FF88;
}

.badge-blue {
    background: rgba(0, 240, 255, 0.1);
    color: var(--primary-blue);
    border: 1px solid var(--primary-blue);
}

.badge-yellow {
    background: rgba(255, 200, 0, 0.1);
    color: #FFC800;
    border: 1px solid #FFC800;
}

/* ===== WIDE MODAL ===== */
.modal-content.wide {
    max-width: 1000px;
}

/* Form modals for databases (TASTES, ROUTES, STAY) */
.modal-content.form-wide {
    max-width: 900px;
}

/* Form grids - responsive columns */
.form-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

/* Compact inline fields for checkboxes with values */
.inline-field-group {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.inline-field-group input[type="number"] {
    width: 120px;
    padding: 8px 12px;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
}

/* ===== RATING STARS ===== */
.star-rating {
    cursor: pointer;
    opacity: 0.3;
    transition: opacity 0.2s;
}

.star-rating:hover,
.star-rating.selected {
    opacity: 1;
}

/* ===== FORM IMPROVEMENTS ===== */
/* Larger, more readable form inputs */
.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="url"],
.form-group input[type="tel"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
    padding: 16px !important;
    font-size: 16px !important;
}

/* Better label styling */
.form-group label:not([style*="display: flex"]) {
    font-size: 15px !important;
    font-weight: 600 !important;
    margin-bottom: 8px !important;
    display: block;
}

/* Section headers with visual separation */
#sharedRestaurantForm h3 {
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
    margin-top: 20px;
}

#sharedRestaurantForm h3:first-of-type {
    border-top: none;
    padding-top: 0;
    margin-top: 0;
}

/* Larger checkbox labels */
.form-group label[style*="display: flex"] span,
.form-group label input[type="checkbox"] + span {
    font-size: 15px !important;
}

/* Full-width primary save button */
#sharedRestaurantForm button[type="submit"] {
    width: 100% !important;
    padding: 18px !important;
    font-size: 17px !important;
    font-weight: 700 !important;
    flex: none !important;
}

/* Better spacing for form sections */
#sharedRestaurantForm .form-group {
    margin-bottom: 24px;
}

/* ===== RESPONSIVE ===== */

/* iPad Pro 12.9" and smaller tablets (1024px and below) */
@media (max-width: 1024px) {
    .modal-content.wide {
        max-width: 90vw;
    }

    .modal-content.form-wide {
        max-width: 90vw;
    }

    .ecosystem-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Mobile and small tablets (768px and below) */
@media (max-width: 768px) {
    .login-form {
        padding: 32px 24px;
    }

    .dashboard-container {
        padding: 24px 16px;
    }

    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .tours-grid {
        grid-template-columns: 1fr;
    }

    .navbar {
        flex-direction: column;
        gap: 16px;
    }

    .navbar-menu {
        width: 100%;
        justify-content: space-between;
    }

    .tabs {
        padding: 0 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .modal-content.wide,
    .modal-content.form-wide {
        max-width: 95vw;
    }

    .modal-content {
        max-height: 85vh;
    }

    .ecosystem-grid {
        grid-template-columns: 1fr;
    }

    /* Form grids become single column on mobile */
    .form-grid-2 {
        grid-template-columns: 1fr;
    }

    /* Inline fields stack on mobile */
    .inline-field-group {
        flex-direction: column;
        align-items: flex-start;
    }

    .inline-field-group input[type="number"] {
        width: 100%;
    }
}

/* ===== ECOSYSTEM HOME ===== */
.ecosystem-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #000000 0%, #0A0E27 100%);
    padding: 40px 20px;
}

.ecosystem-header {
    text-align: center;
    margin-bottom: 60px;
}

.ecosystem-header h1 {
    font-size: 36px;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 16px;
    text-shadow: 0 0 30px rgba(0, 240, 255, 0.6);
}

.ecosystem-header p {
    font-size: 16px;
    color: var(--text-secondary);
}

.ecosystem-nav {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.ecosystem-cards {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 24px;
}

.ecosystem-card-wide {
    grid-column: 1 / -1;
}

.ecosystem-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 20px;
    padding: 40px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ecosystem-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 240, 255, 0.05) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.ecosystem-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-8px);
    box-shadow: 0 20px 60px rgba(0, 240, 255, 0.3);
}

.ecosystem-card:hover::before {
    opacity: 1;
}

.ecosystem-card-icon {
    font-size: 48px;
    margin-bottom: 20px;
    display: block;
}

.ecosystem-card h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
}

.ecosystem-card p {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
}

@media (max-width: 768px) {
    .ecosystem-cards {
        grid-template-columns: 1fr;
    }

    .ecosystem-card-wide {
        grid-column: 1;
    }

    .ecosystem-header h1 {
        font-size: 28px;
    }

    .ecosystem-nav {
        position: relative;
        top: auto;
        right: auto;
        justify-content: center;
        margin-bottom: 40px;
    }
}

/* ===== TICKET SYSTEM STYLES ===== */
.ticket-section {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    background: rgba(19, 24, 46, 0.5);
}

.ticket-section h3 {
    font-size: 20px;
    margin-bottom: 12px;
    color: var(--primary-blue);
}

.passenger-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    align-items: center;
    padding: 12px;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.passenger-row input {
    flex: 1;
    padding: 10px 12px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 14px;
}

.passenger-row button {
    padding: 8px 16px;
    font-size: 14px;
}

.ticket-card {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    background: var(--card-bg);
}

.ticket-card h4 {
    margin-bottom: 12px;
    color: var(--primary-blue);
    font-size: 18px;
}

.ticket-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.ticket-preview {
    max-width: 300px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    margin-bottom: 12px;
}

#templatePreview img {
    cursor: crosshair;
}

#templatePreview img.selecting {
    cursor: crosshair;
    box-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
}

/* ===== LOADING SPINNER ===== */
.save-spinner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10000;
    background: rgba(0, 0, 0, 0.95);
    padding: 40px;
    border-radius: 16px;
    border: 2px solid var(--primary-blue);
    box-shadow: 0 0 40px rgba(0, 240, 255, 0.3);
    text-align: center;
}

.spinner-ring {
    border: 4px solid var(--border-color);
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.save-spinner p {
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 500;
    margin: 0;
}

/* ===== MODAL SCROLL LOCK ===== */
body.modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
}

/* ===== ENHANCED MODAL BACKDROP ===== */
.modal::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(10, 14, 39, 0.98);
    backdrop-filter: blur(12px);
    z-index: -1;
}

/* ===== TASTES PICKER STYLES ===== */
.tastes-restaurant-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    background: var(--card-bg);
    transition: all 0.2s ease;
}

.tastes-restaurant-card:hover {
    border-color: var(--primary-blue);
    box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
}

.restaurant-info h3 {
    margin: 0 0 8px 0;
    color: var(--primary-blue);
    font-size: 18px;
}

.restaurant-info p {
    margin: 4px 0;
    font-size: 14px;
    color: var(--text-secondary);
}

.restaurant-info .location {
    font-weight: 500;
    color: var(--text-primary);
}

.restaurant-info .rating {
    color: #FFD700;
}

.restaurant-info .notes {
    font-style: italic;
    margin-top: 8px;
}

.badges {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.badge-success {
    background: rgba(0, 255, 136, 0.2);
    color: #00FF88;
    border: 1px solid #00FF88;
}

.badge-info {
    background: rgba(0, 240, 255, 0.2);
    color: var(--primary-blue);
    border: 1px solid var(--primary-blue);
}

.badge-warning {
    background: rgba(255, 193, 7, 0.2);
    color: #FFC107;
    border: 1px solid #FFC107;
}

/* ===== AUTO-FILLED FIELD STYLING ===== */
input.auto-filled {
    border-color: #00FF88 !important;
    background: rgba(0, 255, 136, 0.05) !important;
}

input[readonly] {
    background: rgba(26, 31, 58, 0.5) !important;
    cursor: not-allowed;
    opacity: 0.8;
}

/* ===== PDF PROGRESS BAR ===== */
.progress-bar {
    height: 24px;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
    transition: width 0.3s ease;
    position: relative;
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.extraction-results {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
}

.extraction-results h4 {
    color: var(--primary-blue);
    margin-bottom: 16px;
}

.extraction-results h5 {
    color: var(--text-primary);
    margin: 16px 0 8px 0;
}

.extraction-results ul {
    list-style: none;
    padding-left: 0;
}

.extraction-results li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.extraction-results li:last-child {
    border-bottom: none;
}
    </style>

    <!-- PDF.js Library for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="screen active">
        <!-- Language Selector -->
        <div class="language-selector">
            <button onclick="setLanguage('it')" id="langBtnIt" class="active">
                üáÆüáπ IT
            </button>
            <button onclick="setLanguage('en')" id="langBtnEn">
                üá¨üáß EN
            </button>
            <button onclick="setLanguage('de')" id="langBtnDe">
                üá©üá™ DE
            </button>
            <button onclick="setLanguage('fr')" id="langBtnFr">
                üá´üá∑ FR
            </button>
            <button onclick="setLanguage('es')" id="langBtnEs">
                üá™üá∏ ES
            </button>
        </div>

        <div class="login-container">
            <div class="login-header">
                <img src="blueriot-logo.png" alt="BlueRiot Syndicate" class="logo">
                <h1 data-i18n="login.title">Tour Leader Dashboard</h1>
                <p data-i18n="login.subtitle">Accedi con le tue credenziali BlueRiot Syndicate</p>
            </div>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email" data-i18n="login.email">Email</label>
                    <input type="email" id="email" data-i18n-placeholder="login.emailPlaceholder">
                </div>

                <div class="form-group">
                    <label for="password" data-i18n="login.password">Password</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span class="btn-text" data-i18n="login.loginButton">Accedi con Email</span>
                </button>

                <div style="text-align: center; margin: 20px 0; color: #666; font-size: 14px;">
                    <span>oppure</span>
                </div>

                <button type="button" class="btn btn-google" id="googleLoginBtn">
                    <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 8px;">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    <span class="btn-text">Accedi con Google</span>
                </button>

                <div id="loginError" class="error-message"></div>
            </form>

            <div class="login-footer">
                <p data-i18n="login.footer">Problemi di accesso? Contatta <a href="https://t.me/blueriot">@blueriot</a></p>
            </div>
        </div>
    </div>

    <!-- ECOSYSTEM HOME SCREEN -->
    <div id="ecosystemHomeScreen" class="screen">
        <div class="ecosystem-container">
            <div class="ecosystem-nav">
                <span id="ecosystemUserEmail" class="user-email"></span>
                <button id="ecosystemLogoutBtn" class="btn btn-secondary" data-i18n="common.logout">Logout</button>
            </div>

            <div class="ecosystem-header">
                <img src="blueriot-logo.png" alt="BlueRiot Syndicate" class="logo" style="width: 160px; margin-bottom: 30px; filter: drop-shadow(0 0 30px rgba(0, 240, 255, 0.4));">
                <h1>blueriot mŒ±trŒπœá</h1>
                <p data-i18n="ecosystem.subtitle">Seleziona un servizio per iniziare</p>
            </div>

            <div class="ecosystem-cards">
                <div class="ecosystem-card" onclick="navigateToSection('tastes')">
                    <span class="ecosystem-card-icon">üçΩÔ∏è</span>
                    <h2>Œ§ŒîSŒ§Œû5</h2>
                    <p data-i18n="ecosystem.tastesDesc">Database completo di ristoranti, bar, gelaterie e locali testati. Gestisci recensioni, vantaggi TL e info utili.</p>
                </div>

                <div class="ecosystem-card" onclick="navigateToSection('routes')">
                    <span class="ecosystem-card-icon">üöå</span>
                    <h2>R0UT35</h2>
                    <p data-i18n="ecosystem.routesDesc">Database trasporti: bus, treni (AV, IC, R), ferry, taxi, NCC. Info su orari, prezzi e affidabilit√†.</p>
                </div>

                <div class="ecosystem-card" onclick="navigateToSection('stay')">
                    <span class="ecosystem-card-icon">üè®</span>
                    <h2>SŒ§ŒîŒ•</h2>
                    <p data-i18n="ecosystem.stayDesc">Database hotel alternativi, B&B e strutture consigliate. Prezzi, contatti e recensioni personali.</p>
                </div>

                <div class="ecosystem-card ecosystem-card-wide" onclick="navigateToSection('hub')">
                    <span class="ecosystem-card-icon">‚ö°</span>
                    <h2>NODŒû</h2>
                    <p data-i18n="ecosystem.hubDesc">Gestione tour completa: programma, ristoranti, hotel, emergenze, documenti, templates, eTickets e mini-site builder.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>BlueRiot Syndicate</span>
            </div>
            <div class="navbar-menu">
                <button id="backToEcosystemBtn" class="btn btn-secondary" data-i18n="common.backToEcosystem">‚Üê mŒ±trŒπœá</button>
                <span id="userEmail" class="user-email"></span>
                <button id="logoutBtn" class="btn btn-secondary" data-i18n="common.logout">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>I Miei Tour</h1>
                <button id="newTourBtn" class="btn btn-primary">+ Nuovo Tour</button>
            </div>

            <div id="toursGrid" class="tours-grid">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- TASTES SCREEN (Restaurant Database) -->
    <div id="restaurantDatabaseScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>blueriot Œ§ŒîSŒ§Œû5</span>
            </div>
            <div class="navbar-menu">
                <button id="backToEcosystemBtn2" class="btn btn-secondary" data-i18n="common.backToEcosystem">‚Üê mŒ±trŒπœá</button>
                <span id="userEmail2" class="user-email"></span>
                <button id="logoutBtn2" class="btn btn-secondary" data-i18n="common.logout">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>üçΩÔ∏è Œ§ŒîSŒ§Œû5 - Database Locali</h1>
                <button id="addSharedRestaurantBtn" class="btn btn-primary">+ Aggiungi Locale</button>
            </div>

            <!-- FILTERS -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">Filtri</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group" style="margin: 0;">
                        <label for="filterCity">Citt√†</label>
                        <input type="text" id="filterCity" placeholder="es. Roma">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="filterCuisine">Tipo Cucina</label>
                        <input type="text" id="filterCuisine" placeholder="es. Italiana">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="filterAdvantages">Vantaggi</label>
                        <select id="filterAdvantages">
                            <option value="">Tutti</option>
                            <option value="tl_free">TL Free</option>
                            <option value="commission">Commission</option>
                            <option value="discount">Discount</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button id="applyFiltersBtn" class="btn btn-primary" style="width: 100%;">üîç Cerca</button>
                    </div>
                </div>
            </div>

            <!-- SHARED RESTAURANTS LIST -->
            <div id="sharedRestaurantsList">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- ROUTES SCREEN (Transport Database) -->
    <div id="routesScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>blueriot R0UT35</span>
            </div>
            <div class="navbar-menu">
                <button id="backToEcosystemBtn3" class="btn btn-secondary" data-i18n="common.backToEcosystem">‚Üê mŒ±trŒπœá</button>
                <span id="userEmail3" class="user-email"></span>
                <button id="logoutBtn3" class="btn btn-secondary" data-i18n="common.logout">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>üöå R0UT35 - Database Trasporti</h1>
                <button id="addRouteBtn" class="btn btn-primary">+ Aggiungi Trasporto</button>
            </div>

            <!-- FILTERS -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">Filtri</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group" style="margin: 0;">
                        <label for="filterTransportType">Tipo Trasporto</label>
                        <select id="filterTransportType">
                            <option value="">Tutti</option>
                            <option value="bus">Bus</option>
                            <option value="ferry">Ferry</option>
                            <option value="taxi">Taxi</option>
                            <option value="ncc">NCC</option>
                            <option value="train_av">Treno AV</option>
                            <option value="train_ic">Treno IC</option>
                            <option value="train_ec">Treno EC</option>
                            <option value="train_r">Treno R</option>
                            <option value="train_rv">Treno RV</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="filterRouteArea">Area</label>
                        <input type="text" id="filterRouteArea" placeholder="es. Toscana">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button id="applyRouteFiltersBtn" class="btn btn-primary" style="width: 100%;">üîç Cerca</button>
                    </div>
                </div>
            </div>

            <!-- ROUTES LIST -->
            <div id="routesList">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- STAY SCREEN (Alternative Hotels Database) -->
    <div id="stayScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>blueriot SŒ§ŒîŒ•</span>
            </div>
            <div class="navbar-menu">
                <button id="backToEcosystemBtn4" class="btn btn-secondary" data-i18n="common.backToEcosystem">‚Üê mŒ±trŒπœá</button>
                <span id="userEmail4" class="user-email"></span>
                <button id="logoutBtn4" class="btn btn-secondary" data-i18n="common.logout">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>üè® SŒ§ŒîŒ• - Database Hotel Alternativi</h1>
                <button id="addStayBtn" class="btn btn-primary">+ Aggiungi Struttura</button>
            </div>

            <!-- FILTERS -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">Filtri</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group" style="margin: 0;">
                        <label for="filterStayCity">Citt√†</label>
                        <input type="text" id="filterStayCity" placeholder="es. Firenze">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="filterStayType">Tipo</label>
                        <select id="filterStayType">
                            <option value="">Tutti</option>
                            <option value="hotel">Hotel</option>
                            <option value="bb">B&B</option>
                            <option value="guesthouse">Guesthouse</option>
                            <option value="boutique">Boutique Hotel</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button id="applyStayFiltersBtn" class="btn btn-primary" style="width: 100%;">üîç Cerca</button>
                    </div>
                </div>
            </div>

            <!-- STAY LIST -->
            <div id="stayList">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- NEW TOUR MODAL -->
    <div id="newTourModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Tour</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>

            <form id="newTourForm">
                <div class="form-group">
                    <label for="tourCode">Codice Tour</label>
                    <input type="text" id="tourCode" required placeholder="es. ITALY001">
                </div>

                <div class="form-group">
                    <label for="tourName">Nome Tour</label>
                    <input type="text" id="tourName" required placeholder="es. Italia Classica">
                </div>

                <div class="form-group">
                    <label for="tourOperator">Operatore</label>
                    <select id="tourOperator" required>
                        <option value="">Seleziona operatore...</option>
                        <option value="Intrepid Travel">Intrepid Travel</option>
                        <option value="G Adventures">G Adventures</option>
                        <option value="OAT">OAT</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="startDate">Data Inizio</label>
                    <input type="date" id="startDate" required>
                </div>

                <div class="form-group">
                    <label for="endDate">Data Fine</label>
                    <input type="date" id="endDate" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelTour">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Tour</button>
                </div>

                <div id="tourError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- TOUR DETAIL MODAL WITH 8 TABS -->
    <div id="tourDetailModal" class="modal">
        <div class="modal-content wide">
            <div class="modal-header">
                <div>
                    <h2 id="modalTourName">Tour</h2>
                    <span id="modalTourCode" class="tour-code" style="margin-left: 12px;"></span>
                </div>
                <button class="modal-close" id="closeTourDetail">&times;</button>
            </div>

            <!-- TABS NAVIGATION -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="ristoranti">üçΩÔ∏è Ristoranti</button>
                <button class="tab-btn" data-tab="hotel">üè® Hotel</button>
                <button class="tab-btn" data-tab="programma">üìÖ Programma</button>
                <button class="tab-btn" data-tab="biglietti">üé´ Biglietti</button>
                <button class="tab-btn" data-tab="emergenze">üö® Emergenze</button>
                <button class="tab-btn" data-tab="file">üìÑ File</button>
                <button class="tab-btn" data-tab="link">üîó Link</button>
                <button class="tab-btn" data-tab="templates">üìã Templates</button>
            </div>

            <!-- TAB CONTENTS -->
            <div class="tab-content">
                <!-- DASHBOARD TAB -->
                <div id="tabDashboard" class="tab-pane active">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="data-card">
                            <h4>üìä Feedback Ricevuti</h4>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 20px; width: 40px;" onclick="decrementFeedback()">‚àí</button>
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary-blue);" id="feedbackCount">0</div>
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 20px; width: 40px;" onclick="incrementFeedback()">+</button>
                            </div>
                            <div class="meta">di <span id="totalPassengers">0</span> passeggeri</div>
                        </div>
                        <div class="data-card">
                            <h4>üìà Percentuale</h4>
                            <div style="font-size: 32px; font-weight: 700; color: #00FF88;" id="feedbackPercentage">0%</div>
                            <div class="meta">feedback ricevuti</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="totalPassengersInput">Totale Passeggeri</label>
                        <input type="number" id="totalPassengersInput" min="1" placeholder="Inserisci numero passeggeri">
                        <button class="btn btn-primary" style="margin-top: 8px; width: 100%;" onclick="saveDashboardData()">üíæ Salva Dati</button>
                    </div>

                    <div style="margin: 24px 0; padding: 24px; background: var(--dark-bg); border-radius: 8px;">
                        <canvas id="feedbackChart" style="max-height: 200px;"></canvas>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="editTourInfoBtn">‚úèÔ∏è Modifica Info Tour</button>
                        <button type="button" class="btn btn-secondary" id="uploadPdfBtn">üìÑ Carica PDF</button>
                        <button type="button" class="btn btn-secondary" id="publishSiteBtn">üåê Pubblica Mini-Site</button>
                        <button type="button" class="btn btn-secondary" style="background: var(--error); border-color: var(--error);" id="deleteTourBtn">üóëÔ∏è Cancella Tour</button>
                    </div>
                </div>

                <!-- RISTORANTI TAB -->
                <div id="tabRistoranti" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h3>Ristoranti del Tour</h3>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" id="addFromTastesBtn" style="white-space: nowrap;">üçΩ Scegli da TASTES</button>
                            <button class="btn btn-primary" id="addRestaurantBtn">+ Nuovo</button>
                        </div>
                    </div>
                    <div id="restaurantsList">
                        <p class="loading">Nessun ristorante ancora</p>
                    </div>
                </div>

                <!-- HOTEL TAB -->
                <div id="tabHotel" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Hotel del Tour</h3>
                        <button class="btn btn-primary" id="addHotelBtn">+ Aggiungi</button>
                    </div>
                    <div id="hotelsList">
                        <p class="loading">Nessun hotel ancora</p>
                    </div>
                </div>

                <!-- PROGRAMMA TAB -->
                <div id="tabProgramma" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Programma Giornaliero</h3>
                        <button class="btn btn-secondary" id="generateDaysBtn">üîÑ Genera Giorni</button>
                    </div>
                    <div id="daysList">
                        <p class="loading">Clicca "Genera Giorni" per creare il programma</p>
                    </div>
                </div>

                <!-- BIGLIETTI TAB -->
                <div id="tabBiglietti" class="tab-pane">
                    <!-- Step 1: Upload Template -->
                    <div class="ticket-section">
                        <h3>üìÑ Template Biglietto</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">Carica un biglietto vuoto (PDF o immagine). Il sistema aggiunger√† automaticamente il nome di ogni passeggero.</p>

                        <input type="file" id="ticketTemplateInput" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
                        <button class="btn btn-primary" onclick="document.getElementById('ticketTemplateInput').click()">
                            üì§ Carica Template Biglietto
                        </button>

                        <div id="templatePreview" style="display:none; margin-top: 16px;">
                            <div style="position: relative; display: inline-block;">
                                <img id="templateImage" style="max-width: 100%; border: 2px solid var(--primary-blue); border-radius: 8px;">
                                <div id="namePositionMarker" style="position: absolute; width: 10px; height: 10px; background: red; border-radius: 50%; display: none;"></div>
                            </div>
                            <div style="margin-top: 12px; display: flex; gap: 12px;">
                                <button class="btn btn-secondary" id="setNamePositionBtn">üìç Scegli Posizione Nome</button>
                                <button class="btn btn-secondary" id="removeTemplateBtn">‚ùå Rimuovi Template</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Upload Logo (Optional) -->
                    <div class="ticket-section">
                        <h3>üé® Logo Aggiuntivo (Opzionale)</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">Carica un logo da aggiungere su tutti i biglietti</p>

                        <input type="file" id="logoInput" accept=".png,.jpg,.jpeg,.svg" style="display:none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('logoInput').click()">
                            üì§ Carica Logo
                        </button>

                        <div id="logoPreview" style="display:none; margin-top: 12px;">
                            <img id="logoImage" style="max-height: 80px; border: 1px solid var(--border-color); border-radius: 4px;">
                            <button class="btn btn-secondary" id="removeLogoBtn" style="margin-left: 12px;">‚ùå Rimuovi</button>
                        </div>
                    </div>

                    <!-- Step 3: Passenger List -->
                    <div class="ticket-section">
                        <h3>üë• Lista Passeggeri</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">Inserisci i nomi dei passeggeri. Il sistema generer√† automaticamente un biglietto personalizzato per ciascuno.</p>

                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <button class="btn btn-primary" id="addPassengerBtn">+ Aggiungi Passeggero</button>
                            <button class="btn btn-secondary" id="bulkAddPassengersBtn">üìã Inserimento Multiplo</button>
                        </div>

                        <div id="passengersList">
                            <p style="color: var(--text-secondary);">Nessun passeggero ancora. Clicca "+ Aggiungi Passeggero" per iniziare.</p>
                        </div>

                        <button class="btn btn-success" id="generateTicketsBtn" style="margin-top: 20px; width: 100%; font-size: 18px; padding: 16px;">
                            ‚ö° Genera Biglietti Personalizzati
                        </button>
                    </div>

                    <!-- Step 4: Generated Tickets -->
                    <div class="ticket-section">
                        <h3>‚úÖ Biglietti Generati</h3>
                        <div id="generatedTicketsList">
                            <p style="color: var(--text-secondary);">I biglietti generati appariranno qui.</p>
                        </div>
                    </div>
                </div>

                <!-- EMERGENZE TAB -->
                <div id="tabEmergenze" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Contatti di Emergenza</h3>
                        <button class="btn btn-primary" id="addEmergencyBtn">+ Aggiungi</button>
                    </div>
                    <div id="emergencyList">
                        <p class="loading">Nessun contatto ancora</p>
                    </div>
                </div>

                <!-- FILE TAB -->
                <div id="tabFile" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Documenti del Tour</h3>
                        <button class="btn btn-primary" id="addFileBtn">+ Aggiungi</button>
                    </div>
                    <div id="filesList">
                        <p class="loading">Nessun file ancora</p>
                    </div>
                </div>

                <!-- LINK TAB -->
                <div id="tabLink" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Link Utili</h3>
                        <button class="btn btn-primary" id="addLinkBtn">+ Aggiungi</button>
                    </div>
                    <div id="linksList">
                        <p class="loading">Nessun link ancora</p>
                    </div>
                </div>

                <!-- TEMPLATES TAB -->
                <div id="tabTemplates" class="tab-pane">
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px;">üíæ Salva come Template</h3>
                        <div class="form-group">
                            <label for="templateName">Nome Template</label>
                            <input type="text" id="templateName" placeholder="es. Tour Italia Classica">
                        </div>
                        <button class="btn btn-primary" id="saveTemplateBtn">üíæ Salva Template</button>
                    </div>

                    <hr style="border: 1px solid var(--border-color); margin: 24px 0;">

                    <div>
                        <h3 style="margin-bottom: 16px;">üìã Carica da Template</h3>
                        <div id="templatesList">
                            <p class="loading">Nessun template disponibile</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESTAURANT FORM MODAL -->
    <div id="restaurantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="restaurantModalTitle">Aggiungi Ristorante</h2>
                <button class="modal-close" id="closeRestaurantModal">&times;</button>
            </div>

            <div style="padding: 16px 24px 0; border-bottom: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" id="searchDatabaseBtn" style="width: 100%; margin-bottom: 16px;">üîç Cerca nel Database Condiviso</button>
            </div>

            <form id="restaurantForm">
                <div class="form-group">
                    <label for="restaurantDay">Giorno Tour *</label>
                    <input type="number" id="restaurantDay" required min="1" max="30" placeholder="es. 3">
                </div>

                <div class="form-group">
                    <label for="restaurantName">Nome Ristorante *</label>
                    <input type="text" id="restaurantName" required placeholder="es. Trattoria da Mario">
                </div>

                <div class="form-group">
                    <label for="restaurantCity">Citt√† *</label>
                    <input type="text" id="restaurantCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="restaurantAddress">Indirizzo</label>
                    <input type="text" id="restaurantAddress" placeholder="es. Via Roma 123">
                </div>

                <div class="form-group">
                    <label for="restaurantPhone">Telefono</label>
                    <input type="tel" id="restaurantPhone" placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label>Vantaggi</label>
                    <div style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="advTlFree">
                            <span>üéÅ TL Free - Descrizione:</span>
                        </label>
                        <input type="text" id="advTlFreeDesc" placeholder="es. Pranzo gratuito per il TL" style="margin-left: 24px; margin-bottom: 12px;">

                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="advCommission">
                            <span>üí∞ Commission - Descrizione:</span>
                        </label>
                        <input type="text" id="advCommissionDesc" placeholder="es. 10% commissione sul gruppo" style="margin-left: 24px; margin-bottom: 12px;">

                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="advDiscount">
                            <span>üè∑Ô∏è Discount - Descrizione:</span>
                        </label>
                        <input type="text" id="advDiscountDesc" placeholder="es. 15% sconto sul conto" style="margin-left: 24px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="restaurantNotes">Note</label>
                    <input type="text" id="restaurantNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRestaurant">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="restaurantError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- SHARED RESTAURANT FORM MODAL -->
    <!-- TASTES DATABASE MODAL (Complete Form) -->
    <div id="sharedRestaurantModal" class="modal">
        <div class="modal-content form-wide">
            <div class="modal-header">
                <h2 id="tastesModalTitle">Aggiungi a Œ§ŒîSŒ§Œû5 Database</h2>
                <button class="modal-close" id="closeSharedRestaurantModal">&times;</button>
            </div>

            <form id="sharedRestaurantForm">
                <!-- 1. NOME RISTORANTE -->
                <div class="form-group">
                    <label for="sharedRestaurantName">Nome Locale *</label>
                    <input type="text" id="sharedRestaurantName" required placeholder="es. Trattoria da Mario">
                </div>

                <!-- 2. CITT√Ä -->
                <div class="form-group">
                    <label for="sharedRestaurantCity">Citt√† *</label>
                    <input type="text" id="sharedRestaurantCity" required placeholder="es. Roma, Firenze, Parigi">
                </div>

                <!-- 2B. NAZIONE -->
                <div class="form-group">
                    <label for="sharedRestaurantCountry">Nazione</label>
                    <input type="text" id="sharedRestaurantCountry" placeholder="es. Italy, France, Germany" value="Italy">
                </div>

                <!-- 2C. REGIONE -->
                <div class="form-group">
                    <label for="sharedRestaurantRegion">Regione</label>
                    <input type="text" id="sharedRestaurantRegion" placeholder="es. Lazio, Toscana, Lombardia">
                </div>

                <!-- 3. GOOGLE MAPS -->
                <div class="form-group">
                    <label for="sharedGoogleMaps">Link Google Maps</label>
                    <input type="url" id="sharedGoogleMaps" placeholder="https://maps.google.com/...">
                </div>

                <!-- 3B. GOOGLE MAPS PLUS CODE -->
                <div class="form-group">
                    <label for="sharedPlusCode">Plus Code (Google Maps)</label>
                    <input type="text" id="sharedPlusCode" placeholder="es. 8FVC9G8F+6X">
                </div>

                <!-- 4. APPLE MAPS -->
                <div class="form-group">
                    <label for="sharedAppleMaps">Link Apple Maps</label>
                    <input type="url" id="sharedAppleMaps" placeholder="https://maps.apple.com/...">
                </div>

                <!-- 4B. WHAT3WORDS -->
                <div class="form-group">
                    <label for="sharedWhat3Words">what3words</label>
                    <input type="text" id="sharedWhat3Words" placeholder="es. ///compilato.contare.sapone">
                </div>

                <!-- 5. INDIRIZZO -->
                <div class="form-group">
                    <label for="sharedRestaurantAddress">Indirizzo</label>
                    <input type="text" id="sharedRestaurantAddress" placeholder="es. Via Roma 123">
                </div>

                <!-- 6. TELEFONI SECTION -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìû Contatti</h3>

                <div class="form-group">
                    <label for="sharedContactPerson">Riferimento/Contatto</label>
                    <input type="text" id="sharedContactPerson" placeholder="es. Mario Rossi, Responsabile sala">
                </div>

                <div class="form-group">
                    <label>Numeri Telefono</label>
                    <div id="phoneNumbersList" style="display: flex; flex-direction: column; gap: 8px;">
                        <input type="tel" class="phone-input" placeholder="es. +39 06 1234567" style="width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="addPhoneField()" style="padding: 8px 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--primary-blue); font-size: 14px; cursor: pointer; flex: 1; min-width: 140px;">‚ûï Aggiungi numero</button>
                        <label for="vcardUpload" style="padding: 8px 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--primary-blue); font-size: 14px; cursor: pointer; flex: 1; min-width: 140px; text-align: center; margin: 0; display: flex; align-items: center; justify-content: center;">
                            üìá Importa vCard
                        </label>
                        <input type="file" id="vcardUpload" accept=".vcf,.vcard" onchange="handleVCardUpload(event)" style="display: none;">
                    </div>
                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">üí° Puoi condividere un contatto dal telefono come file .vcf e caricarlo qui</small>
                </div>

                <!-- 7. TIPO CUCINA -->
                <div class="form-group">
                    <label for="sharedCuisineType">Tipo Cucina</label>
                    <input type="text" id="sharedCuisineType" placeholder="es. Italiana, Pizzeria, Trattoria">
                </div>

                <!-- 8. FASCIA PREZZO -->
                <div class="form-group">
                    <label for="sharedPriceRange">Fascia Prezzo</label>
                    <select id="sharedPriceRange">
                        <option value="">Seleziona...</option>
                        <option value="‚Ç¨">‚Ç¨ - Economico</option>
                        <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ - Medio</option>
                        <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ - Alto</option>
                        <option value="‚Ç¨‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ - Lusso</option>
                    </select>
                </div>

                <!-- 9. ORARI DI APERTURA (TEXTAREA) -->
                <div class="form-group">
                    <label for="sharedOpeningHours">Orari di Apertura</label>
                    <textarea id="sharedOpeningHours" rows="3" placeholder="es. Lun-Ven 12:00-23:00&#10;Sab-Dom 11:00-00:00&#10;Chiuso Marted√¨" style="width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 16px; resize: vertical;"></textarea>
                </div>

                <!-- 10. PRENOTAZIONE NECESSARIA -->
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="sharedBookingNeeded" style="width: 20px; height: 20px; margin: 0;">
                        <label for="sharedBookingNeeded" style="margin: 0; font-size: 15px;">üìÖ Prenotazione Necessaria</label>
                    </div>
                </div>

                <!-- 11. VANTAGGI TL -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üéÅ Vantaggi TL</h3>

                <div class="form-group" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- TL FREE checkbox -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="sharedTlFree" style="width: 20px; height: 20px; margin: 0;">
                        <label for="sharedTlFree" style="margin: 0; font-size: 15px;">üÜì TL Free</label>
                    </div>

                    <!-- COMMISSIONE checkbox -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="sharedHasCommission" style="width: 20px; height: 20px; margin: 0;">
                        <label for="sharedHasCommission" style="margin: 0; font-size: 15px;">üí∞ Commissione</label>
                    </div>

                    <!-- SCONTO -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="sharedDiscountPerc" style="margin: 0; font-size: 15px; font-weight: 600;">üíµ Sconto %:</label>
                        <input type="number" id="sharedDiscountPerc" min="0" max="100" placeholder="10" style="width: 80px; padding: 12px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                    </div>
                </div>

                <!-- 12. DIMENSIONE GRUPPO MASSIMA (NO % SYMBOL!) -->
                <div class="form-group">
                    <label for="sharedMaxGroupSize">Dimensione Gruppo Massima</label>
                    <input type="number" id="sharedMaxGroupSize" min="1" max="99" placeholder="es. 15">
                </div>

                <!-- 13. NOTE -->
                <div class="form-group">
                    <label for="sharedNotes">Note</label>
                    <textarea id="sharedNotes" rows="4" placeholder="Note utili per altri TL..." style="width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 16px; resize: vertical;"></textarea>
                </div>

                <!-- HIDDEN FIELDS (still needed for database) -->
                <input type="hidden" id="sharedType" value="restaurant">
                <input type="hidden" id="sharedSuitableForGroups" value="true">
                <input type="hidden" id="sharedMinGroupSize" value="1">
                <input type="hidden" id="sharedToursRelevant" value="">
                <input type="hidden" id="sharedTestedBy" value="">
                <input type="hidden" id="sharedTestedDate" value="">
                <input type="hidden" id="sharedCommissionPerc" value="0">
                <input type="hidden" id="sharedHasDiscount" value="false">

                <!-- 14. SAVE BUTTON (FULL WIDTH) -->
                <div class="modal-actions" style="border-top: 1px solid var(--border-color); margin-top: 32px; padding-top: 24px;">
                    <button type="submit" class="btn btn-primary">üíæ Salva in Database</button>
                </div>

                <div id="sharedRestaurantError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- RESTAURANT SEARCH MODAL -->
    <div id="restaurantSearchModal" class="modal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h2>üîç Cerca Ristorante nel Database</h2>
                <button class="modal-close" id="closeRestaurantSearchModal">&times;</button>
            </div>

            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="searchCity" placeholder="Citt√†..." style="width: 100%; padding: 12px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                    <input type="text" id="searchCuisine" placeholder="Tipo cucina..." style="width: 100%; padding: 12px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                    <button class="btn btn-primary" id="searchRestaurantsBtn">üîç Cerca</button>
                </div>

                <div id="searchResultsList" style="max-height: 400px; overflow-y: auto;">
                    <p class="loading">Usa i filtri per cercare</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TASTES PICKER MODAL (NODE Integration) -->
    <div id="tastesPickerModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>üçΩ Seleziona da TASTES Database</h2>
                <button class="modal-close" onclick="closeTastesPicker()">&times;</button>
            </div>

            <div style="padding: 24px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                <!-- Search bar -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="tastesSearchInput"
                           placeholder="üîç Cerca per nome, citt√†, regione, nazione..."
                           style="width: 100%; padding: 14px; font-size: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                </div>

                <!-- Filters -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="tastesCityFilter" style="padding: 10px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                        <option value="">Tutte le citt√†</option>
                    </select>
                    <select id="tastesCountryFilter" style="padding: 10px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                        <option value="">Tutte le nazioni</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; padding: 10px; background: var(--card-bg); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="tastesTlFreeFilter" style="width: 18px; height: 18px;">
                        <span>Solo TL Free</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; padding: 10px; background: var(--card-bg); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="tastesCommissionFilter" style="width: 18px; height: 18px;">
                        <span>Solo Commissione</span>
                    </label>
                </div>

                <!-- Restaurant list -->
                <div id="tastesRestaurantList" style="flex: 1; overflow-y: auto;">
                    <p class="loading">Caricamento ristoranti TASTES...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF UPLOAD MODAL -->
    <div id="pdfUploadModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìÑ Carica Itinerario PDF</h2>
                <button class="modal-close" onclick="closePdfUploadModal()">&times;</button>
            </div>

            <div style="padding: 24px;">
                <p style="color: #888; margin-bottom: 20px;">
                    Carica il PDF dell'itinerario del tour. Il sistema estrarr√† automaticamente:<br>
                    ‚Ä¢ üìÖ Giorni e tappe<br>
                    ‚Ä¢ üè® Hotel e strutture<br>
                    ‚Ä¢ üçΩ Ristoranti<br>
                    ‚Ä¢ üìç Citt√† e localit√†
                </p>

                <div class="form-group">
                    <label for="pdfFileInput">Seleziona PDF</label>
                    <input type="file" id="pdfFileInput" accept=".pdf" style="width: 100%; padding: 12px; background: var(--card-bg); border: 2px dashed var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer;">
                </div>

                <div id="pdfUploadProgress" style="display: none; margin: 20px 0;">
                    <div class="progress-bar" style="width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                        <div id="pdfProgressBar" style="width: 0%; height: 100%; background: var(--primary-blue); transition: width 0.3s;"></div>
                    </div>
                    <p id="pdfProgressText" style="text-align: center; margin-top: 8px; color: #888;">Caricamento...</p>
                </div>

                <div id="pdfExtractionResults" style="display: none; margin-top: 24px; padding: 20px; background: var(--dark-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 16px;">‚úÖ Estrazione Completata</h3>
                    <div id="extractedDataSummary"></div>
                    <button class="btn btn-primary" style="margin-top: 16px; width: 100%;" onclick="applyExtractedData()">üì• Applica Dati Estratti</button>
                </div>

                <div class="modal-actions" style="margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closePdfUploadModal()">Annulla</button>
                    <button type="button" class="btn btn-primary" id="processPdfBtn" onclick="processPdfFile()">üîç Analizza PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RATING MODAL -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Valuta Ristorante</h2>
                <button class="modal-close" id="closeRatingModal">&times;</button>
            </div>

            <form id="ratingForm" style="padding: 24px;">
                <div class="form-group">
                    <label>Valutazione *</label>
                    <div style="display: flex; gap: 8px; font-size: 32px; margin-top: 8px;">
                        <span class="star-rating" data-rating="1">‚≠ê</span>
                        <span class="star-rating" data-rating="2">‚≠ê</span>
                        <span class="star-rating" data-rating="3">‚≠ê</span>
                        <span class="star-rating" data-rating="4">‚≠ê</span>
                        <span class="star-rating" data-rating="5">‚≠ê</span>
                    </div>
                    <input type="hidden" id="ratingValue" required>
                    <input type="hidden" id="ratingRestaurantId">
                </div>

                <div class="form-group">
                    <label for="ratingNotes">Note (facoltative)</label>
                    <textarea id="ratingNotes" rows="3" placeholder="Racconta la tua esperienza..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRating">Annulla</button>
                    <button type="submit" class="btn btn-primary">‚≠ê Invia Valutazione</button>
                </div>

                <div id="ratingError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- ROUTES DATABASE MODAL -->
    <div id="routesModal" class="modal">
        <div class="modal-content form-wide">
            <div class="modal-header">
                <h2 id="routesModalTitle">Aggiungi a R0UT35 Database</h2>
                <button class="modal-close" id="closeRoutesModal">&times;</button>
            </div>

            <form id="routesForm">
                <!-- TRANSPORT TYPE -->
                <h3 style="margin: 0 0 16px; color: var(--primary-blue);">üöå Tipo Trasporto</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="routeTransportType">Tipo Trasporto *</label>
                        <select id="routeTransportType" required>
                            <option value="">Seleziona...</option>
                            <option value="bus">üöå Bus</option>
                            <option value="ferry">‚õ¥Ô∏è Ferry</option>
                            <option value="taxi">üöï Taxi</option>
                            <option value="ncc">üöó NCC</option>
                            <option value="train">üöÇ Train</option>
                            <option value="private">üöô Private Transfer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="routeTrainCategory">Categoria Treno (se train)</label>
                        <select id="routeTrainCategory">
                            <option value="">N/A</option>
                            <option value="AV">‚ö° AV - Alta Velocit√†</option>
                            <option value="IC">üöÑ IC - Intercity</option>
                            <option value="EC">üöÜ EC - EuroCity</option>
                            <option value="R">üöÇ R - Regionale</option>
                            <option value="RV">üöÉ RV - Regionale Veloce</option>
                            <option value="S">üöá S - Suburbano</option>
                            <option value="RE">üöä RE - Regionale Espresso</option>
                        </select>
                    </div>
                </div>

                <!-- OPERATOR INFO -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üè¢ Operatore</h3>

                <div class="form-group">
                    <label for="routeOperatorName">Nome Operatore *</label>
                    <input type="text" id="routeOperatorName" required placeholder="es. Trenitalia, Flixbus, Bluestar Ferries">
                </div>

                <!-- ROUTE INFO -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìç Tratta</h3>

                <div class="form-group">
                    <label for="routeAreaServed">Area Servita</label>
                    <input type="text" id="routeAreaServed" placeholder="es. Toscana, Costa Amalfitana">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="routeStartPoint">Partenza</label>
                        <input type="text" id="routeStartPoint" placeholder="es. Roma Termini">
                    </div>

                    <div class="form-group">
                        <label for="routeEndPoint">Arrivo</label>
                        <input type="text" id="routeEndPoint" placeholder="es. Firenze SMN">
                    </div>
                </div>

                <!-- TIMING & PRICING -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">‚è±Ô∏è Orari e Prezzi</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="routeFrequency">Frequenza</label>
                        <input type="text" id="routeFrequency" placeholder="es. Ogni 30 min, 3x al giorno">
                    </div>

                    <div class="form-group">
                        <label for="routeDuration">Durata</label>
                        <input type="text" id="routeDuration" placeholder="es. 1h 30min, 45 min">
                    </div>
                </div>

                <div class="form-group">
                    <label for="routePrice">Prezzo</label>
                    <input type="text" id="routePrice" placeholder="es. ‚Ç¨25-45, ‚Ç¨15 fisso">
                </div>

                <div class="form-group">
                    <label for="routeTicketInfo">Info Biglietti</label>
                    <textarea id="routeTicketInfo" rows="2" placeholder="Come acquistare, dove comprare, validit√†..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <!-- RELIABILITY -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">‚≠ê Affidabilit√†</h3>

                <div class="form-group">
                    <label for="routeReliability">Livello Affidabilit√†</label>
                    <select id="routeReliability">
                        <option value="">Seleziona...</option>
                        <option value="high">‚úÖ Alta - Molto affidabile</option>
                        <option value="medium">‚ö†Ô∏è Media - Generalmente ok</option>
                        <option value="low">‚ùå Bassa - Ritardi frequenti</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="routeReliabilityNotes">Note Affidabilit√†</label>
                    <textarea id="routeReliabilityNotes" rows="2" placeholder="Esperienza personale, problemi noti..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <!-- CONTACTS & LINKS -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìû Contatti e Link</h3>

                <div class="form-group">
                    <label for="routeContacts">Contatti</label>
                    <input type="text" id="routeContacts" placeholder="Telefono, email, WhatsApp...">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="routeWebsite">Sito Web</label>
                        <input type="url" id="routeWebsite" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label for="routeBookingUrl">Link Prenotazione</label>
                        <input type="url" id="routeBookingUrl" placeholder="https://...">
                    </div>
                </div>

                <div class="form-group">
                    <label for="routeMapsLink">Link Google Maps / Mappa Tratta</label>
                    <input type="url" id="routeMapsLink" placeholder="https://maps.google.com/...">
                </div>

                <!-- ADDITIONAL INFO -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìù Info Aggiuntive</h3>

                <div class="form-group">
                    <label for="routeNotes">Note</label>
                    <textarea id="routeNotes" rows="2" placeholder="Informazioni utili..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="form-group">
                    <label for="routeTips">Tips per TL</label>
                    <textarea id="routeTips" rows="2" placeholder="Consigli pratici..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRoute">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva in Database</button>
                </div>

                <div id="routesError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- STAY DATABASE MODAL -->
    <div id="stayModal" class="modal">
        <div class="modal-content form-wide">
            <div class="modal-header">
                <h2 id="stayModalTitle">Aggiungi a SŒ§ŒîŒ• Database</h2>
                <button class="modal-close" id="closeStayModal">&times;</button>
            </div>

            <form id="stayForm">
                <!-- BASIC INFO -->
                <h3 style="margin: 0 0 16px; color: var(--primary-blue);">üè® Info Base</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="stayName">Nome Struttura *</label>
                        <input type="text" id="stayName" required placeholder="es. Hotel Bella Vista">
                    </div>

                    <div class="form-group">
                        <label for="stayType">Tipo *</label>
                        <select id="stayType" required>
                            <option value="">Seleziona...</option>
                            <option value="hotel">üè® Hotel</option>
                            <option value="bnb">üè° B&B</option>
                            <option value="guesthouse">üè† Guesthouse</option>
                            <option value="boutique">‚ú® Boutique Hotel</option>
                            <option value="hostel">üõèÔ∏è Hostel</option>
                            <option value="apartment">üè¢ Apartment</option>
                        </select>
                    </div>
                </div>

                <!-- LOCATION -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìç Posizione</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="stayLocation">Citt√† *</label>
                        <input type="text" id="stayLocation" required placeholder="es. Firenze">
                    </div>

                    <div class="form-group">
                        <label for="stayDistanceCenter">Distanza dal Centro</label>
                        <input type="text" id="stayDistanceCenter" placeholder="es. 10 min a piedi, 2 km">
                    </div>
                </div>

                <div class="form-group">
                    <label for="stayAddress">Indirizzo</label>
                    <input type="text" id="stayAddress" placeholder="es. Via Roma 123">
                </div>

                <div class="form-group">
                    <label for="stayGoogleMaps">Link Google Maps</label>
                    <input type="url" id="stayGoogleMaps" placeholder="https://maps.google.com/...">
                </div>

                <!-- PRICING -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üí∞ Prezzi</h3>

                <div class="form-group">
                    <label for="stayPriceRange">Fascia di Prezzo</label>
                    <input type="text" id="stayPriceRange" placeholder="es. ‚Ç¨50-80/notte, ‚Ç¨100-150/camera">
                </div>

                <!-- CONTACTS -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìû Contatti e Booking</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="stayContact">Contatto</label>
                        <input type="text" id="stayContact" placeholder="Nome referente">
                    </div>

                    <div class="form-group">
                        <label for="stayPhone">Telefono</label>
                        <input type="tel" id="stayPhone" placeholder="+39 ...">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="stayWebsite">Sito Web</label>
                        <input type="url" id="stayWebsite" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label for="stayBookingUrl">Link Booking</label>
                        <input type="url" id="stayBookingUrl" placeholder="https://booking.com/...">
                    </div>
                </div>

                <!-- SUITABILITY -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üë• Idoneit√†</h3>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="staySuitableFamilies">
                        <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Adatto a Famiglie</span>
                    </label>

                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="staySuitableGroups">
                        <span>üë• Adatto a Gruppi</span>
                    </label>
                </div>

                <div class="form-group">
                    <label for="stayMaxGuests">Max Ospiti</label>
                    <input type="number" id="stayMaxGuests" min="1" placeholder="es. 30">
                </div>

                <!-- FACILITIES -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">‚ú® Servizi</h3>

                <div class="form-group">
                    <label for="stayFacilities">Servizi (separati da virgola)</label>
                    <textarea id="stayFacilities" rows="2" placeholder="es. WiFi, Colazione, Parcheggio, AC, Piscina, Palestra..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <!-- TL BENEFITS -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üéÅ Vantaggi TL</h3>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="stayCommission">
                        <span>üí∞ Commission</span>
                    </label>
                    <input type="number" id="stayCommissionPerc" min="0" max="100" placeholder="% commissione" style="margin-left: 24px; margin-bottom: 12px; width: calc(100% - 24px);">

                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="staySpecialRate">
                        <span>üè∑Ô∏è Tariffa Speciale TL</span>
                    </label>
                    <input type="text" id="staySpecialRateDetails" placeholder="Dettagli tariffa speciale..." style="margin-left: 24px; width: calc(100% - 24px);">
                </div>

                <!-- TESTING & NOTES -->
                <h3 style="margin: 24px 0 16px; color: var(--primary-blue);">üìù Info Aggiuntive</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="stayTestedBy">Testato da (TL)</label>
                        <input type="text" id="stayTestedBy" placeholder="Nome TL">
                    </div>

                    <div class="form-group">
                        <label for="stayTestedDate">Data Test</label>
                        <input type="date" id="stayTestedDate">
                    </div>
                </div>

                <div class="form-group">
                    <label for="stayRecommendedFor">Consigliato per</label>
                    <input type="text" id="stayRecommendedFor" placeholder="es. Famiglie con bambini, Coppie, Backpackers">
                </div>

                <div class="form-group">
                    <label for="stayNotes">Note</label>
                    <textarea id="stayNotes" rows="3" placeholder="Note utili per altri TL..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelStay">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva in Database</button>
                </div>

                <div id="stayError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- HOTEL MODAL -->
    <div id="hotelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="hotelModalTitle">Aggiungi Hotel</h2>
                <button class="modal-close" id="closeHotelModal">&times;</button>
            </div>

            <form id="hotelForm">
                <div class="form-group">
                    <label for="hotelDay">Giorno Tour *</label>
                    <input type="number" id="hotelDay" required min="1" max="30" placeholder="es. 1">
                </div>

                <div class="form-group">
                    <label for="hotelName">Nome Hotel *</label>
                    <input type="text" id="hotelName" required placeholder="es. Hotel Colosseo">
                </div>

                <div class="form-group">
                    <label for="hotelCity">Citt√† *</label>
                    <input type="text" id="hotelCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="hotelAddress">Indirizzo</label>
                    <input type="text" id="hotelAddress" placeholder="es. Via del Corso 123">
                </div>

                <div class="form-group">
                    <label for="hotelPhone">Telefono</label>
                    <input type="tel" id="hotelPhone" placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label for="hotelWifiPassword">üîê Password WiFi</label>
                    <input type="text" id="hotelWifiPassword" placeholder="es. GuestWiFi2024">
                </div>

                <div class="form-group">
                    <label for="hotelNotes">Note</label>
                    <input type="text" id="hotelNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelHotel">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="hotelError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- EMERGENCY CONTACT MODAL -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="emergencyModalTitle">Aggiungi Contatto di Emergenza</h2>
                <button class="modal-close" id="closeEmergencyModal">&times;</button>
            </div>

            <form id="emergencyForm">
                <div class="form-group">
                    <label for="emergencyCity">Citt√† *</label>
                    <input type="text" id="emergencyCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="emergencyType">Tipo Contatto *</label>
                    <select id="emergencyType" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="police">üöì Polizia</option>
                        <option value="hospital">üè• Ospedale</option>
                        <option value="embassy">üèõÔ∏è Ambasciata/Consolato</option>
                        <option value="fire">üöí Vigili del Fuoco</option>
                        <option value="taxi">üöï Taxi</option>
                        <option value="other">üìû Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="emergencyName">Nome/Organizzazione *</label>
                    <input type="text" id="emergencyName" required placeholder="es. Ospedale Santo Spirito">
                </div>

                <div class="form-group">
                    <label for="emergencyPhone">Telefono *</label>
                    <input type="tel" id="emergencyPhone" required placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label for="emergencyAddress">Indirizzo</label>
                    <input type="text" id="emergencyAddress" placeholder="es. Via Roma 123">
                </div>

                <div class="form-group">
                    <label for="emergencyNotes">Note</label>
                    <input type="text" id="emergencyNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEmergency">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="emergencyError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- FILE MODAL -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="fileModalTitle">Aggiungi Documento</h2>
                <button class="modal-close" id="closeFileModal">&times;</button>
            </div>

            <form id="fileForm">
                <div class="form-group">
                    <label for="fileName">Nome File *</label>
                    <input type="text" id="fileName" required placeholder="es. Itinerario Completo">
                </div>

                <div class="form-group">
                    <label for="fileType">Tipo Documento *</label>
                    <select id="fileType" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="itinerary">üìÖ Itinerario</option>
                        <option value="voucher">üé´ Voucher</option>
                        <option value="contract">üìã Contratto</option>
                        <option value="insurance">üõ°Ô∏è Assicurazione</option>
                        <option value="passport">üõÇ Documento Identit√†</option>
                        <option value="map">üó∫Ô∏è Mappa</option>
                        <option value="other">üìÑ Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fileUrl">Link al File *</label>
                    <input type="url" id="fileUrl" required placeholder="https://...">
                    <small style="color: var(--text-secondary); font-size: 12px;">Inserisci un link a Google Drive, Dropbox, o altro servizio</small>
                </div>

                <div class="form-group">
                    <label for="fileNotes">Note</label>
                    <input type="text" id="fileNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelFile">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="fileError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- LINK MODAL -->
    <div id="linkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="linkModalTitle">Aggiungi Link Utile</h2>
                <button class="modal-close" id="closeLinkModal">&times;</button>
            </div>

            <form id="linkForm">
                <div class="form-group">
                    <label for="linkTitle">Titolo *</label>
                    <input type="text" id="linkTitle" required placeholder="es. Meteo Roma">
                </div>

                <div class="form-group">
                    <label for="linkCategory">Categoria *</label>
                    <select id="linkCategory" required>
                        <option value="">Seleziona categoria...</option>
                        <option value="weather">üå§Ô∏è Meteo</option>
                        <option value="transport">üöá Trasporti</option>
                        <option value="restaurant">üçΩÔ∏è Ristoranti</option>
                        <option value="attraction">üèõÔ∏è Attrazioni</option>
                        <option value="booking">üè® Prenotazioni</option>
                        <option value="map">üó∫Ô∏è Mappe</option>
                        <option value="other">üîó Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="linkUrl">URL *</label>
                    <input type="url" id="linkUrl" required placeholder="https://...">
                </div>

                <div class="form-group">
                    <label for="linkDescription">Descrizione</label>
                    <input type="text" id="linkDescription" placeholder="Breve descrizione...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelLink">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="linkError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- ACTIVITY MODAL -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="activityModalTitle">Aggiungi Attivit√†</h2>
                <button class="modal-close" id="closeActivityModal">&times;</button>
            </div>

            <form id="activityForm">
                <input type="hidden" id="activityDayNumber">

                <div class="form-group">
                    <label for="activityTime">Orario *</label>
                    <input type="time" id="activityTime" required>
                </div>

                <div class="form-group">
                    <label for="activityTitle">Titolo *</label>
                    <input type="text" id="activityTitle" required placeholder="es. Visita Colosseo">
                </div>

                <div class="form-group">
                    <label for="activityType">Tipo *</label>
                    <select id="activityType" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="tour">üèõÔ∏è Tour</option>
                        <option value="meal">üçΩÔ∏è Pasto</option>
                        <option value="transport">üöá Trasporto</option>
                        <option value="free_time">‚è∞ Tempo Libero</option>
                        <option value="accommodation">üè® Sistemazione</option>
                        <option value="other">üìå Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="activityDescription">Descrizione</label>
                    <textarea id="activityDescription" rows="3" placeholder="Dettagli dell'attivit√†..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="form-group">
                    <label for="activityLocation">Luogo</label>
                    <input type="text" id="activityLocation" placeholder="es. Piazza del Colosseo">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelActivity">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="activityError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- BULK PASSENGER INPUT MODAL -->
    <div id="bulkPassengerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Inserimento Multiplo Passeggeri</h2>
                <button class="modal-close" id="closeBulkPassengerModal">&times;</button>
            </div>

            <div style="padding: 24px;">
                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                    Inserisci un nome per riga. Puoi opzionalmente includere email e telefono separati da virgole.
                </p>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                    <strong>Formato:</strong><br>
                    Nome Cognome<br>
                    Nome Cognome, email@example.com<br>
                    Nome Cognome, email@example.com, +39 123 456 7890
                </p>

                <textarea
                    id="bulkPassengerInput"
                    rows="15"
                    placeholder="Mario Rossi&#10;Giulia Bianchi, giulia@email.com&#10;Luca Verdi, luca@email.com, +39 333 1234567"
                    style="width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 14px; resize: vertical;"
                ></textarea>

                <div class="modal-actions" style="margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" id="cancelBulkPassenger">Annulla</button>
                    <button type="button" class="btn btn-primary" id="saveBulkPassengers">üíæ Salva Tutti</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>
    <script>
// ===== SUPABASE SETUP =====
const { createClient } = supabase;

const SUPABASE_URL = 'https://kvomxtzcnczvbcscybcy.supabase.co';
const SUPABASE_PUBLISHABLE_OR_ANON_KEY = 'sb_publishable_WgMzf0xMBQ6a8WMcun3fvg_sUfBQ8qC';
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_OR_ANON_KEY);

// ===== MULTI-LANGUAGE SYSTEM =====
const translations = {
    it: {
        // Login
        login: {
            title: "Tour Leader Dashboard",
            subtitle: "Accedi con le tue credenziali BlueRiot Syndicate",
            email: "Email",
            emailPlaceholder: "tuo@email.com",
            password: "Password",
            loginButton: "Accedi",
            footer: "Problemi di accesso? Contatta @blueriot"
        },
        // Ecosystem Home
        ecosystem: {
            subtitle: "Seleziona un servizio per iniziare",
            tastesDesc: "Database completo di ristoranti, bar, gelaterie e locali testati. Gestisci recensioni, vantaggi TL e info utili.",
            routesDesc: "Database trasporti: bus, treni (AV, IC, R), ferry, taxi, NCC. Info su orari, prezzi e affidabilit√†.",
            stayDesc: "Database hotel alternativi, B&B e strutture consigliate. Prezzi, contatti e recensioni personali.",
            hubDesc: "Gestione tour completa: programma, ristoranti, hotel, emergenze, documenti, templates, eTickets e mini-site builder."
        },
        // Common
        common: {
            logout: "Logout",
            backToEcosystem: "‚Üê mŒ±trŒπœá",
            save: "Salva",
            cancel: "Annulla",
            close: "Chiudi",
            delete: "Elimina",
            edit: "Modifica",
            add: "Aggiungi",
            search: "Cerca",
            loading: "Caricamento...",
            noData: "Nessun dato disponibile"
        }
    },
    en: {
        // Login
        login: {
            title: "Tour Leader Dashboard",
            subtitle: "Sign in with your BlueRiot Syndicate credentials",
            email: "Email",
            emailPlaceholder: "your@email.com",
            password: "Password",
            loginButton: "Sign In",
            footer: "Having issues? Contact @blueriot"
        },
        // Ecosystem Home
        ecosystem: {
            subtitle: "Select a service to get started",
            tastesDesc: "Complete database of restaurants, bars, gelaterias and tested venues. Manage reviews, TL benefits and useful info.",
            routesDesc: "Transport database: buses, trains (AV, IC, R), ferries, taxis, NCC. Info on schedules, prices and reliability.",
            stayDesc: "Alternative hotels, B&Bs and recommended properties database. Prices, contacts and personal reviews.",
            hubDesc: "Complete tour management: schedule, restaurants, hotels, emergencies, documents, templates, eTickets and mini-site builder."
        },
        // Common
        common: {
            logout: "Logout",
            backToEcosystem: "‚Üê mŒ±trŒπœá",
            save: "Save",
            cancel: "Cancel",
            close: "Close",
            delete: "Delete",
            edit: "Edit",
            add: "Add",
            search: "Search",
            loading: "Loading...",
            noData: "No data available"
        }
    },
    de: {
        // Login
        login: {
            title: "Tour Leader Dashboard",
            subtitle: "Melden Sie sich mit Ihren BlueRiot Syndicate Zugangsdaten an",
            email: "E-Mail",
            emailPlaceholder: "ihre@email.de",
            password: "Passwort",
            loginButton: "Anmelden",
            footer: "Probleme? Kontaktieren Sie @blueriot"
        },
        // Ecosystem Home
        ecosystem: {
            subtitle: "W√§hlen Sie einen Service zum Starten",
            tastesDesc: "Vollst√§ndige Datenbank mit Restaurants, Bars, Eisdielen und getesteten Lokalen. Verwalten Sie Bewertungen, TL-Vorteile und n√ºtzliche Infos.",
            routesDesc: "Transportdatenbank: Busse, Z√ºge (AV, IC, R), F√§hren, Taxis, NCC. Infos zu Fahrpl√§nen, Preisen und Zuverl√§ssigkeit.",
            stayDesc: "Datenbank f√ºr alternative Hotels, B&Bs und empfohlene Unterk√ºnfte. Preise, Kontakte und pers√∂nliche Bewertungen.",
            hubDesc: "Komplettes Tour-Management: Programm, Restaurants, Hotels, Notf√§lle, Dokumente, Templates, eTickets und Mini-Site Builder."
        },
        // Common
        common: {
            logout: "Abmelden",
            backToEcosystem: "‚Üê mŒ±trŒπœá",
            save: "Speichern",
            cancel: "Abbrechen",
            close: "Schlie√üen",
            delete: "L√∂schen",
            edit: "Bearbeiten",
            add: "Hinzuf√ºgen",
            search: "Suchen",
            loading: "Laden...",
            noData: "Keine Daten verf√ºgbar"
        }
    },
    fr: {
        // Login
        login: {
            title: "Tour Leader Dashboard",
            subtitle: "Connectez-vous avec vos identifiants BlueRiot Syndicate",
            email: "Email",
            emailPlaceholder: "votre@email.fr",
            password: "Mot de passe",
            loginButton: "Se connecter",
            footer: "Des probl√®mes ? Contactez @blueriot"
        },
        // Ecosystem Home
        ecosystem: {
            subtitle: "S√©lectionnez un service pour commencer",
            tastesDesc: "Base de donn√©es compl√®te de restaurants, bars, glaciers et √©tablissements test√©s. G√©rez les avis, avantages TL et infos utiles.",
            routesDesc: "Base de donn√©es transport : bus, trains (AV, IC, R), ferries, taxis, NCC. Infos sur horaires, prix et fiabilit√©.",
            stayDesc: "Base de donn√©es h√¥tels alternatifs, B&B et propri√©t√©s recommand√©es. Prix, contacts et avis personnels.",
            hubDesc: "Gestion de tourn√©e compl√®te : programme, restaurants, h√¥tels, urgences, documents, templates, eTickets et mini-site builder."
        },
        // Common
        common: {
            logout: "D√©connexion",
            backToEcosystem: "‚Üê mŒ±trŒπœá",
            save: "Enregistrer",
            cancel: "Annuler",
            close: "Fermer",
            delete: "Supprimer",
            edit: "Modifier",
            add: "Ajouter",
            search: "Rechercher",
            loading: "Chargement...",
            noData: "Aucune donn√©e disponible"
        }
    },
    es: {
        // Login
        login: {
            title: "Tour Leader Dashboard",
            subtitle: "Inicia sesi√≥n con tus credenciales de BlueRiot Syndicate",
            email: "Email",
            emailPlaceholder: "tu@email.es",
            password: "Contrase√±a",
            loginButton: "Iniciar sesi√≥n",
            footer: "¬øProblemas? Contacta @blueriot"
        },
        // Ecosystem Home
        ecosystem: {
            subtitle: "Selecciona un servicio para empezar",
            tastesDesc: "Base de datos completa de restaurantes, bares, helader√≠as y locales probados. Gestiona rese√±as, ventajas TL e info √∫til.",
            routesDesc: "Base de datos transporte: autobuses, trenes (AV, IC, R), ferries, taxis, NCC. Info sobre horarios, precios y fiabilidad.",
            stayDesc: "Base de datos hoteles alternativos, B&B y propiedades recomendadas. Precios, contactos y rese√±as personales.",
            hubDesc: "Gesti√≥n de tour completa: programa, restaurantes, hoteles, emergencias, documentos, templates, eTickets y mini-site builder."
        },
        // Common
        common: {
            logout: "Cerrar sesi√≥n",
            backToEcosystem: "‚Üê mŒ±trŒπœá",
            save: "Guardar",
            cancel: "Cancelar",
            close: "Cerrar",
            delete: "Eliminar",
            edit: "Editar",
            add: "A√±adir",
            search: "Buscar",
            loading: "Cargando...",
            noData: "No hay datos disponibles"
        }
    }
};

// Current language (default: Italian)
let currentLanguage = localStorage.getItem('blueriot_language') || 'it';

// Set language and apply translations
function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('blueriot_language', lang);

    // Update active button for all 5 languages
    document.getElementById('langBtnIt').classList.toggle('active', lang === 'it');
    document.getElementById('langBtnEn').classList.toggle('active', lang === 'en');
    document.getElementById('langBtnDe').classList.toggle('active', lang === 'de');
    document.getElementById('langBtnFr').classList.toggle('active', lang === 'fr');
    document.getElementById('langBtnEs').classList.toggle('active', lang === 'es');

    // Apply translations
    applyTranslations();
}

// Apply translations to all elements with data-i18n
function applyTranslations() {
    const elements = document.querySelectorAll('[data-i18n]');

    elements.forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = getTranslation(key);

        if (translation) {
            element.textContent = translation;
        }
    });

    // Handle placeholders
    const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
    placeholderElements.forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        const translation = getTranslation(key);

        if (translation) {
            element.placeholder = translation;
        }
    });
}

// Get nested translation by key (e.g., "login.title")
function getTranslation(key) {
    const keys = key.split('.');
    let translation = translations[currentLanguage];

    for (const k of keys) {
        if (translation && translation[k]) {
            translation = translation[k];
        } else {
            return null;
        }
    }

    return translation;
}

// Initialize language on page load
document.addEventListener('DOMContentLoaded', () => {
    setLanguage(currentLanguage);
});

// Global state
let currentUser = null;
let currentTL = null;
let currentTourDetail = null;
let currentRestaurantEdit = null;
let currentHotelEdit = null;
let currentEmergencyEdit = null;
let currentFileEdit = null;
let currentLinkEdit = null;
let currentActivityEdit = null;

// DOM elements
let loginScreen, dashboardScreen, restaurantDatabaseScreen, loginForm, loginError, loginBtn, logoutBtn, userEmail;
let toursGrid, newTourBtn, newTourModal, newTourForm, closeModal, cancelTour, tourError;
let tourDetailModal, closeTourDetail, deleteTourBtn;
let tabButtons, tabPanes;
let restaurantModal, restaurantForm, closeRestaurantModal, cancelRestaurant, restaurantError;
let sharedRestaurantModal, sharedRestaurantForm, closeSharedRestaurantModal, cancelSharedRestaurant, sharedRestaurantError;
let restaurantSearchModal, closeRestaurantSearchModal, searchRestaurantsBtn, searchResultsList;
let ratingModal, ratingForm, closeRatingModal, cancelRating, ratingError;
let hotelModal, hotelForm, closeHotelModal, cancelHotel, hotelError;
let emergencyModal, emergencyForm, closeEmergencyModal, cancelEmergency, emergencyError;
let fileModal, fileForm, closeFileModal, cancelFile, fileError;
let linkModal, linkForm, closeLinkModal, cancelLink, linkError;
let activityModal, activityForm, closeActivityModal, cancelActivity, activityError;

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', init);

function init() {
    console.log('üöÄ App loading...');

    // Initialize DOM elements
    loginScreen = document.getElementById('loginScreen');
    dashboardScreen = document.getElementById('dashboardScreen');
    restaurantDatabaseScreen = document.getElementById('restaurantDatabaseScreen');
    loginForm = document.getElementById('loginForm');
    loginError = document.getElementById('loginError');
    loginBtn = document.getElementById('loginBtn');
    logoutBtn = document.getElementById('logoutBtn');
    userEmail = document.getElementById('userEmail');
    toursGrid = document.getElementById('toursGrid');
    newTourBtn = document.getElementById('newTourBtn');
    newTourModal = document.getElementById('newTourModal');
    newTourForm = document.getElementById('newTourForm');
    closeModal = document.getElementById('closeModal');
    cancelTour = document.getElementById('cancelTour');
    tourError = document.getElementById('tourError');

    // Tour detail modal elements
    tourDetailModal = document.getElementById('tourDetailModal');
    closeTourDetail = document.getElementById('closeTourDetail');
    deleteTourBtn = document.getElementById('deleteTourBtn');

    // Tab elements
    tabButtons = document.querySelectorAll('.tab-btn');
    tabPanes = document.querySelectorAll('.tab-pane');

    // Restaurant modal elements
    restaurantModal = document.getElementById('restaurantModal');
    restaurantForm = document.getElementById('restaurantForm');
    closeRestaurantModal = document.getElementById('closeRestaurantModal');
    cancelRestaurant = document.getElementById('cancelRestaurant');
    restaurantError = document.getElementById('restaurantError');

    // Shared restaurant modal elements
    sharedRestaurantModal = document.getElementById('sharedRestaurantModal');
    sharedRestaurantForm = document.getElementById('sharedRestaurantForm');
    closeSharedRestaurantModal = document.getElementById('closeSharedRestaurantModal');
    cancelSharedRestaurant = document.getElementById('cancelSharedRestaurant');
    sharedRestaurantError = document.getElementById('sharedRestaurantError');

    // Restaurant search modal elements
    restaurantSearchModal = document.getElementById('restaurantSearchModal');
    closeRestaurantSearchModal = document.getElementById('closeRestaurantSearchModal');
    searchRestaurantsBtn = document.getElementById('searchRestaurantsBtn');
    searchResultsList = document.getElementById('searchResultsList');

    // Rating modal elements
    ratingModal = document.getElementById('ratingModal');
    ratingForm = document.getElementById('ratingForm');
    closeRatingModal = document.getElementById('closeRatingModal');
    cancelRating = document.getElementById('cancelRating');
    ratingError = document.getElementById('ratingError');

    // Hotel modal elements
    hotelModal = document.getElementById('hotelModal');
    hotelForm = document.getElementById('hotelForm');
    closeHotelModal = document.getElementById('closeHotelModal');
    cancelHotel = document.getElementById('cancelHotel');
    hotelError = document.getElementById('hotelError');

    // Emergency modal elements
    emergencyModal = document.getElementById('emergencyModal');
    emergencyForm = document.getElementById('emergencyForm');
    closeEmergencyModal = document.getElementById('closeEmergencyModal');
    cancelEmergency = document.getElementById('cancelEmergency');
    emergencyError = document.getElementById('emergencyError');

    // File modal elements
    fileModal = document.getElementById('fileModal');
    fileForm = document.getElementById('fileForm');
    closeFileModal = document.getElementById('closeFileModal');
    cancelFile = document.getElementById('cancelFile');
    fileError = document.getElementById('fileError');

    // Link modal elements
    linkModal = document.getElementById('linkModal');
    linkForm = document.getElementById('linkForm');
    closeLinkModal = document.getElementById('closeLinkModal');
    cancelLink = document.getElementById('cancelLink');
    linkError = document.getElementById('linkError');

    // Activity modal elements
    activityModal = document.getElementById('activityModal');
    activityForm = document.getElementById('activityForm');
    closeActivityModal = document.getElementById('closeActivityModal');
    cancelActivity = document.getElementById('cancelActivity');
    activityError = document.getElementById('activityError');

    // Check for missing elements
    if (!loginScreen || !dashboardScreen || !loginForm) {
        console.error('‚ùå Critical DOM elements missing!');
        alert('‚ùå ERRORE: Elementi pagina non trovati.');
        return;
    }

    console.log('‚úÖ DOM ready');

    // Set up event listeners
    setupEventListeners();

    // Setup city autofill for all forms
    setupCityAutofill('sharedRestaurantCity', 'sharedRestaurantRegion', 'sharedRestaurantCountry'); // TASTES form
    setupCityAutofill('restaurantCity', 'restaurantRegion', 'restaurantCountry'); // NODE restaurant form
    setupCityAutofill('hotelCity', 'hotelRegion', 'hotelCountry'); // Hotel form

    // Setup Supabase auth listener (handles OAuth automatically)
    setupAuthListener();

    // Check if user is already logged in
    checkAuth();
}

function setupEventListeners() {
    // Login
    loginForm.addEventListener('submit', handleLogin);

    // Google OAuth login
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    if (googleLoginBtn) {
        googleLoginBtn.addEventListener('click', handleGoogleLogin);
    }

    // Logout
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            location.reload();
        });
    }

    // Tour modal
    if (newTourBtn) {
        newTourBtn.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.add('active');
            if (newTourForm) newTourForm.reset();
            hideTourError();
        });
    }

    if (closeModal) {
        closeModal.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.remove('active');
        });
    }

    if (cancelTour) {
        cancelTour.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.remove('active');
        });
    }

    if (newTourModal) {
        newTourModal.addEventListener('click', (e) => {
            if (e.target === newTourModal) {
                newTourModal.classList.remove('active');
            }
        });
    }

    if (newTourForm) {
        console.log('‚úÖ Adding submit event listener to newTourForm');
        newTourForm.addEventListener('submit', handleCreateTour);
    } else {
        console.error('‚ùå newTourForm not found!');
    }

    // Tour detail modal
    if (closeTourDetail) {
        closeTourDetail.addEventListener('click', () => {
            if (tourDetailModal) tourDetailModal.classList.remove('active');
        });
    }

    if (tourDetailModal) {
        tourDetailModal.addEventListener('click', (e) => {
            if (e.target === tourDetailModal) {
                tourDetailModal.classList.remove('active');
            }
        });
    }

    // Tab switching
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;
            switchTab(targetTab);
        });
    });

    // Restaurant modal
    if (closeRestaurantModal) {
        closeRestaurantModal.addEventListener('click', () => {
            if (restaurantModal) restaurantModal.classList.remove('active');
        });
    }

    if (cancelRestaurant) {
        cancelRestaurant.addEventListener('click', () => {
            if (restaurantModal) restaurantModal.classList.remove('active');
        });
    }

    if (restaurantModal) {
        restaurantModal.addEventListener('click', (e) => {
            if (e.target === restaurantModal) {
                restaurantModal.classList.remove('active');
            }
        });
    }

    if (restaurantForm) {
        restaurantForm.addEventListener('submit', handleSaveRestaurant);
    }

    // Navigation buttons
    const backToEcosystemBtn = document.getElementById('backToEcosystemBtn');
    const backToEcosystemBtn2 = document.getElementById('backToEcosystemBtn2');
    const backToEcosystemBtn3 = document.getElementById('backToEcosystemBtn3');
    const backToEcosystemBtn4 = document.getElementById('backToEcosystemBtn4');
    const ecosystemLogoutBtn = document.getElementById('ecosystemLogoutBtn');
    const logoutBtn2 = document.getElementById('logoutBtn2');
    const logoutBtn3 = document.getElementById('logoutBtn3');
    const logoutBtn4 = document.getElementById('logoutBtn4');

    // Back to ecosystem buttons
    if (backToEcosystemBtn) backToEcosystemBtn.addEventListener('click', backToEcosystem);
    if (backToEcosystemBtn2) backToEcosystemBtn2.addEventListener('click', backToEcosystem);
    if (backToEcosystemBtn3) backToEcosystemBtn3.addEventListener('click', backToEcosystem);
    if (backToEcosystemBtn4) backToEcosystemBtn4.addEventListener('click', backToEcosystem);

    // Logout buttons
    const logoutButtons = [ecosystemLogoutBtn, logoutBtn2, logoutBtn3, logoutBtn4];
    logoutButtons.forEach(btn => {
        if (btn) {
            btn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                location.reload();
            });
        }
    });

    // Search database button in restaurant form
    const searchDatabaseBtn = document.getElementById('searchDatabaseBtn');
    if (searchDatabaseBtn) {
        searchDatabaseBtn.addEventListener('click', openRestaurantSearchModal);
    }

    // Shared restaurant modal
    if (closeSharedRestaurantModal) {
        closeSharedRestaurantModal.addEventListener('click', () => {
            if (sharedRestaurantModal) sharedRestaurantModal.classList.remove('active');
        });
    }

    if (cancelSharedRestaurant) {
        cancelSharedRestaurant.addEventListener('click', () => {
            if (sharedRestaurantModal) sharedRestaurantModal.classList.remove('active');
        });
    }

    if (sharedRestaurantModal) {
        sharedRestaurantModal.addEventListener('click', (e) => {
            if (e.target === sharedRestaurantModal) {
                sharedRestaurantModal.classList.remove('active');
            }
        });
    }

    if (sharedRestaurantForm) {
        sharedRestaurantForm.addEventListener('submit', handleSaveSharedRestaurant);
    }

    // Restaurant search modal
    if (closeRestaurantSearchModal) {
        closeRestaurantSearchModal.addEventListener('click', () => {
            if (restaurantSearchModal) restaurantSearchModal.classList.remove('active');
        });
    }

    if (restaurantSearchModal) {
        restaurantSearchModal.addEventListener('click', (e) => {
            if (e.target === restaurantSearchModal) {
                restaurantSearchModal.classList.remove('active');
            }
        });
    }

    if (searchRestaurantsBtn) {
        searchRestaurantsBtn.addEventListener('click', performRestaurantSearch);
    }

    // Rating modal
    if (closeRatingModal) {
        closeRatingModal.addEventListener('click', () => {
            if (ratingModal) ratingModal.classList.remove('active');
        });
    }

    if (cancelRating) {
        cancelRating.addEventListener('click', () => {
            if (ratingModal) ratingModal.classList.remove('active');
        });
    }

    if (ratingModal) {
        ratingModal.addEventListener('click', (e) => {
            if (e.target === ratingModal) {
                ratingModal.classList.remove('active');
            }
        });
    }

    if (ratingForm) {
        ratingForm.addEventListener('submit', handleSubmitRating);
    }

    // Star rating clicks
    document.querySelectorAll('.star-rating').forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            document.getElementById('ratingValue').value = rating;

            // Update visual feedback
            document.querySelectorAll('.star-rating').forEach((s, idx) => {
                if (idx < rating) {
                    s.classList.add('selected');
                } else {
                    s.classList.remove('selected');
                }
            });
        });
    });

    // Hotel modal
    if (closeHotelModal) {
        closeHotelModal.addEventListener('click', () => {
            if (hotelModal) hotelModal.classList.remove('active');
        });
    }

    if (cancelHotel) {
        cancelHotel.addEventListener('click', () => {
            if (hotelModal) hotelModal.classList.remove('active');
        });
    }

    if (hotelModal) {
        hotelModal.addEventListener('click', (e) => {
            if (e.target === hotelModal) {
                hotelModal.classList.remove('active');
            }
        });
    }

    if (hotelForm) {
        hotelForm.addEventListener('submit', handleSaveHotel);
    }

    // Emergency contact modal
    if (closeEmergencyModal) {
        closeEmergencyModal.addEventListener('click', () => {
            if (emergencyModal) emergencyModal.classList.remove('active');
        });
    }

    if (cancelEmergency) {
        cancelEmergency.addEventListener('click', () => {
            if (emergencyModal) emergencyModal.classList.remove('active');
        });
    }

    if (emergencyModal) {
        emergencyModal.addEventListener('click', (e) => {
            if (e.target === emergencyModal) {
                emergencyModal.classList.remove('active');
            }
        });
    }

    if (emergencyForm) {
        emergencyForm.addEventListener('submit', handleSaveEmergency);
    }

    // File modal
    if (closeFileModal) {
        closeFileModal.addEventListener('click', () => {
            if (fileModal) fileModal.classList.remove('active');
        });
    }

    if (cancelFile) {
        cancelFile.addEventListener('click', () => {
            if (fileModal) fileModal.classList.remove('active');
        });
    }

    if (fileModal) {
        fileModal.addEventListener('click', (e) => {
            if (e.target === fileModal) {
                fileModal.classList.remove('active');
            }
        });
    }

    if (fileForm) {
        fileForm.addEventListener('submit', handleSaveFile);
    }

    // Link modal
    if (closeLinkModal) {
        closeLinkModal.addEventListener('click', () => {
            if (linkModal) linkModal.classList.remove('active');
        });
    }

    if (cancelLink) {
        cancelLink.addEventListener('click', () => {
            if (linkModal) linkModal.classList.remove('active');
        });
    }

    if (linkModal) {
        linkModal.addEventListener('click', (e) => {
            if (e.target === linkModal) {
                linkModal.classList.remove('active');
            }
        });
    }

    if (linkForm) {
        linkForm.addEventListener('submit', handleSaveLink);
    }

    // Activity modal
    if (closeActivityModal) {
        closeActivityModal.addEventListener('click', () => {
            if (activityModal) activityModal.classList.remove('active');
        });
    }

    if (cancelActivity) {
        cancelActivity.addEventListener('click', () => {
            if (activityModal) activityModal.classList.remove('active');
        });
    }

    if (activityModal) {
        activityModal.addEventListener('click', (e) => {
            if (e.target === activityModal) {
                activityModal.classList.remove('active');
            }
        });
    }

    if (activityForm) {
        activityForm.addEventListener('submit', handleSaveActivity);
    }

    // Add shared restaurant button
    const addSharedRestaurantBtn = document.getElementById('addSharedRestaurantBtn');
    if (addSharedRestaurantBtn) {
        addSharedRestaurantBtn.addEventListener('click', () => {
            if (sharedRestaurantForm) sharedRestaurantForm.reset();
            if (sharedRestaurantModal) sharedRestaurantModal.classList.add('active');
        });
    }

    // Apply filters button
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', loadSharedRestaurants);
    }

    // ROUTES modal
    const addRouteBtn = document.getElementById('addRouteBtn');
    const closeRoutesModal = document.getElementById('closeRoutesModal');
    const cancelRoute = document.getElementById('cancelRoute');
    const routesForm = document.getElementById('routesForm');
    const routesModal = document.getElementById('routesModal');

    if (addRouteBtn) {
        addRouteBtn.addEventListener('click', () => {
            if (routesForm) routesForm.reset();
            if (routesModal) routesModal.classList.add('active');
        });
    }

    if (closeRoutesModal) {
        closeRoutesModal.addEventListener('click', () => {
            if (routesModal) routesModal.classList.remove('active');
        });
    }

    if (cancelRoute) {
        cancelRoute.addEventListener('click', () => {
            if (routesModal) routesModal.classList.remove('active');
        });
    }

    if (routesModal) {
        routesModal.addEventListener('click', (e) => {
            if (e.target === routesModal) {
                routesModal.classList.remove('active');
            }
        });
    }

    if (routesForm) {
        routesForm.addEventListener('submit', handleSaveRoute);
    }

    // STAY modal
    const addStayBtn = document.getElementById('addStayBtn');
    const closeStayModal = document.getElementById('closeStayModal');
    const cancelStay = document.getElementById('cancelStay');
    const stayForm = document.getElementById('stayForm');
    const stayModal = document.getElementById('stayModal');

    if (addStayBtn) {
        addStayBtn.addEventListener('click', () => {
            if (stayForm) stayForm.reset();
            if (stayModal) stayModal.classList.add('active');
        });
    }

    if (closeStayModal) {
        closeStayModal.addEventListener('click', () => {
            if (stayModal) stayModal.classList.remove('active');
        });
    }

    if (cancelStay) {
        cancelStay.addEventListener('click', () => {
            if (stayModal) stayModal.classList.remove('active');
        });
    }

    if (stayModal) {
        stayModal.addEventListener('click', (e) => {
            if (e.target === stayModal) {
                stayModal.classList.remove('active');
            }
        });
    }

    if (stayForm) {
        stayForm.addEventListener('submit', handleSaveStay);
    }

    // Delete tour button (will be reattached when modal opens)
    // Other buttons will be handled in openTourDetail()
}

async function checkAuth() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
            const { data: tlData, error: tlError } = await supabaseClient
                .from('tl_users')
                .select('*')
                .eq('user_id', session.user.id)
                .single();

            if (tlError || !tlData) {
                console.error('TL profile not found:', tlError);
                showError('Profilo Tour Leader non trovato');
                await supabaseClient.auth.signOut();
                return;
            }

            showDashboard(session.user, tlData);
        }
    } catch (error) {
        console.error('Auth check error:', error);
    }
}

async function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (!email || !password) {
        alert('‚ùå Inserisci email e password');
        return;
    }

    console.log('üéØ Login attempt:', email);

    if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span class="btn-text">Caricamento...</span>';
    }
    hideError();

    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
        });

        if (error) {
            console.error('‚ùå Auth error:', error);
            throw new Error(`Auth: ${error.message}`);
        }

        console.log('‚úÖ Auth OK, user:', data.user?.id);

        const { data: tlData, error: tlError } = await supabaseClient
            .from('tl_users')
            .select('*')
            .eq('user_id', data.user.id)
            .single();

        if (tlError) {
            console.error('‚ùå DB error:', tlError);
            throw new Error(`DB: ${tlError.message} (${tlError.code})`);
        }

        if (!tlData) {
            throw new Error('Profilo TL non trovato');
        }

        console.log('‚úÖ TL profile found');
        showDashboard(data.user, tlData);

    } catch (error) {
        console.error('üí• Login failed:', error);
        const errorMsg = error.message || 'Errore login';
        showError(errorMsg);

        setTimeout(() => {
            alert('‚ùå LOGIN FALLITO:\n\n' + errorMsg + '\n\nControlla Supabase!');
        }, 300);

        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<span class="btn-text">Accedi</span>';
        }
    }
}

async function handleGoogleLogin() {
    const googleLoginBtn = document.getElementById('googleLoginBtn');

    if (googleLoginBtn) {
        googleLoginBtn.disabled = true;
        googleLoginBtn.innerHTML = '<span class="btn-text">Reindirizzamento a Google...</span>';
    }

    try {
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: "https://blueriot723.github.io/blueriot_webapp/"
            }
        });

        if (error) {
            console.error('‚ùå OAuth error:', error);
            throw new Error(`OAuth: ${error.message}`);
        }

        // Il browser verr√† reindirizzato a Google
        // Quando torna, handleOAuthCallback() gestir√† il login

    } catch (error) {
        console.error('üí• Google login failed:', error);
        alert('‚ùå ERRORE GOOGLE LOGIN:\n\n' + (error.message || 'Errore sconosciuto'));

        if (googleLoginBtn) {
            googleLoginBtn.disabled = false;
            googleLoginBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 8px;"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg><span class="btn-text">Accedi con Google</span>';
        }
    }
}

// Setup Supabase auth state listener (handles OAuth automatically)
function setupAuthListener() {
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log('üîÑ Auth state changed:', event);

        if (event === 'SIGNED_IN' && session) {
            console.log('‚úÖ User signed in:', session.user.id);

            try {
                // Cerca il profilo TL nel database
                const { data: tlData, error: tlError } = await supabaseClient
                    .from('tl_users')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .single();

                if (tlError) {
                    console.error('‚ùå DB error:', tlError);
                    throw new Error(`DB: ${tlError.message} (${tlError.code})`);
                }

                if (!tlData) {
                    throw new Error('Profilo TL non trovato per questo account Google.\n\nContatta @blueriot per registrarti.');
                }

                console.log('‚úÖ TL profile found');

                // Pulisci l'URL dal hash OAuth
                if (window.location.hash) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                // Mostra la dashboard
                showDashboard(session.user, tlData);

            } catch (error) {
                console.error('üí• Profile lookup failed:', error);
                alert('‚ùå LOGIN FALLITO:\n\n' + (error.message || 'Errore sconosciuto'));
                await supabaseClient.auth.signOut();
            }
        }

        if (event === 'SIGNED_OUT') {
            console.log('üëã User signed out');
            location.reload();
        }
    });
}

function showDashboard(user, tlData) {
    const ecosystemHomeScreen = document.getElementById('ecosystemHomeScreen');

    if (!loginScreen || !ecosystemHomeScreen) {
        alert('Errore: impossibile mostrare ecosystem');
        return;
    }

    currentUser = user;
    currentTL = tlData;

    loginScreen.classList.remove('active');
    ecosystemHomeScreen.classList.add('active');

    // Set user email in ecosystem nav
    const ecosystemUserEmail = document.getElementById('ecosystemUserEmail');
    if (ecosystemUserEmail) {
        ecosystemUserEmail.textContent = user.email;
    }

    // Set user email in all other screens
    const userEmails = [
        document.getElementById('userEmail'),
        document.getElementById('userEmail2'),
        document.getElementById('userEmail3'),
        document.getElementById('userEmail4')
    ];
    userEmails.forEach(el => {
        if (el) el.textContent = user.email;
    });
}

async function loadTours() {
    if (!currentTL || !currentTL.id) {
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore: Profilo TL non caricato</p>';
        }
        return;
    }

    try {
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading">Caricamento tour...</p>';
        }

        const { data: tours, error } = await supabaseClient
            .from('tours')
            .select('*')
            .eq('tl_id', currentTL.id)
            .order('start_date', { ascending: false });

        if (error) {
            console.error('Error loading tours:', error);
            if (toursGrid) {
                toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore nel caricamento</p>';
            }
            return;
        }

        if (!tours || tours.length === 0) {
            if (toursGrid) {
                toursGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #8B9DC3;">
                        <h2 style="font-size: 24px; margin-bottom: 16px; color: #00F0FF;">Nessun tour ancora</h2>
                        <p style="font-size: 16px;">Clicca su "+ Nuovo Tour" per iniziare!</p>
                    </div>
                `;
            }
        } else {
            displayTours(tours);
        }
    } catch (error) {
        console.error('Load tours error:', error);
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore caricamento</p>';
        }
    }
}

function displayTours(tours) {
    if (!toursGrid) return;

    toursGrid.innerHTML = tours.map(tour => `
        <div class="tour-card" data-tour-id="${tour.id}" onclick="openTourDetail('${tour.id}')">
            <span class="tour-code">${tour.code}</span>
            <h3 class="tour-name">${tour.name}</h3>
            <div class="tour-meta">
                <div>üìÖ ${formatDate(tour.start_date)} - ${formatDate(tour.end_date)}</div>
                <div>üè¢ ${tour.operator || 'N/A'}</div>
                <div>üìä ${tour.status === 'active' ? 'Attivo' : 'Archiviato'}</div>
            </div>
        </div>
    `).join('');

    // Store tours in memory for quick access
    window.allTours = tours;
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

async function handleCreateTour(e) {
    e.preventDefault();

    console.log('üîç DEBUG: handleCreateTour called');
    console.log('üîç DEBUG: currentTL =', currentTL);

    hideTourError();

    // Check if currentTL exists
    if (!currentTL || !currentTL.id) {
        console.error('‚ùå currentTL is not set!');
        showTourError('Errore: TL non identificato. Riprova a effettuare il login.');
        return;
    }

    const tourData = {
        tl_id: currentTL.id,
        code: document.getElementById('tourCode').value.toUpperCase(),
        name: document.getElementById('tourName').value,
        operator: document.getElementById('tourOperator').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        status: 'active'
    };

    console.log('üîç DEBUG: tourData =', tourData);

    if (new Date(tourData.end_date) < new Date(tourData.start_date)) {
        showTourError('La data di fine deve essere dopo la data di inizio');
        return;
    }

    try {
        console.log('üîç DEBUG: Attempting to insert tour...');

        const { data, error } = await supabaseClient
            .from('tours')
            .insert([tourData])
            .select();

        if (error) throw error;

        console.log('‚úÖ Tour created successfully:', data);
        alert('‚úÖ Tour creato con successo!');

        if (newTourModal) newTourModal.classList.remove('active');
        if (newTourForm) newTourForm.reset();
        loadTours();

    } catch (error) {
        console.error('‚ùå Create tour error:', error);

        if (error.code === '23505') {
            showTourError('Codice tour gi√† esistente');
        } else {
            showTourError(error.message || 'Errore creazione tour');
        }
    }
}

function showError(message) {
    if (loginError) {
        loginError.textContent = message;
        loginError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideError() {
    if (loginError) {
        loginError.classList.remove('show');
    }
}

function showTourError(message) {
    if (tourError) {
        tourError.textContent = message;
        tourError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideTourError() {
    if (tourError) {
        tourError.classList.remove('show');
    }
}

// ===== TAB SWITCHING =====

function switchTab(tabName) {
    // Update tab buttons
    tabButtons.forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // Update tab panes
    tabPanes.forEach(pane => {
        if (pane.id === `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`) {
            pane.classList.add('active');
        } else {
            pane.classList.remove('active');
        }
    });

    // Load data when switching to tabs
    if (tabName === 'ristoranti') {
        loadRestaurants();
    } else if (tabName === 'hotel') {
        loadHotels();
    } else if (tabName === 'emergenze') {
        loadEmergencyContacts();
    } else if (tabName === 'file') {
        loadFiles();
    } else if (tabName === 'link') {
        loadLinks();
    } else if (tabName === 'programma') {
        loadProgram();
    } else if (tabName === 'templates') {
        loadTemplates();
    }
}

// ===== TOUR DETAIL FUNCTIONS =====

function openTourDetail(tourId) {
    // Find tour in stored tours
    const tour = window.allTours?.find(t => t.id === tourId);

    if (!tour) {
        alert('‚ùå Tour non trovato');
        return;
    }

    currentTourDetail = tour;

    // Populate modal header
    document.getElementById('modalTourName').textContent = tour.name;
    document.getElementById('modalTourCode').textContent = tour.code;

    // Switch to dashboard tab
    switchTab('dashboard');

    // Load dashboard data
    loadDashboardData();

    // Set up button listeners (need to be reattached each time modal opens)
    setupModalButtons();

    // Open modal
    if (tourDetailModal) tourDetailModal.classList.add('active');
}

function setupModalButtons() {
    // Delete tour button
    const deleteBtn = document.getElementById('deleteTourBtn');
    if (deleteBtn) {
        deleteBtn.onclick = handleDeleteTour;
    }

    // Edit tour info button
    const editInfoBtn = document.getElementById('editTourInfoBtn');
    if (editInfoBtn) {
        editInfoBtn.onclick = () => alert('üöß Modifica info tour in arrivo!');
    }

    // Upload PDF button
    const uploadPdfBtn = document.getElementById('uploadPdfBtn');
    if (uploadPdfBtn) {
        uploadPdfBtn.onclick = openPdfUploadModal;
    }

    // Publish site button
    const publishSiteBtn = document.getElementById('publishSiteBtn');
    if (publishSiteBtn) {
        publishSiteBtn.onclick = () => alert('üöß Mini-Site in arrivo!');
    }

    // Add restaurant button
    const addRestaurantBtn = document.getElementById('addRestaurantBtn');
    if (addRestaurantBtn) {
        addRestaurantBtn.onclick = openAddRestaurantForm;
    }

    // Add from TASTES button (NODE integration)
    const addFromTastesBtn = document.getElementById('addFromTastesBtn');
    if (addFromTastesBtn) {
        addFromTastesBtn.onclick = showTastesRestaurantPicker;
    }

    // Add hotel button
    const addHotelBtn = document.getElementById('addHotelBtn');
    if (addHotelBtn) {
        addHotelBtn.onclick = openAddHotelForm;
    }

    // Generate days button
    const generateDaysBtn = document.getElementById('generateDaysBtn');
    if (generateDaysBtn) {
        generateDaysBtn.onclick = generateDays;
    }

    // Add emergency button
    const addEmergencyBtn = document.getElementById('addEmergencyBtn');
    if (addEmergencyBtn) {
        addEmergencyBtn.onclick = openAddEmergencyForm;
    }

    // Add file button
    const addFileBtn = document.getElementById('addFileBtn');
    if (addFileBtn) {
        addFileBtn.onclick = openAddFileForm;
    }

    // Add link button
    const addLinkBtn = document.getElementById('addLinkBtn');
    if (addLinkBtn) {
        addLinkBtn.onclick = openAddLinkForm;
    }

    // Save template button
    const saveTemplateBtn = document.getElementById('saveTemplateBtn');
    if (saveTemplateBtn) {
        saveTemplateBtn.onclick = saveAsTemplate;
    }

    // Total passengers input
    const totalPassengersInput = document.getElementById('totalPassengersInput');
    if (totalPassengersInput) {
        totalPassengersInput.onchange = handlePassengersChange;
    }
}

function loadDashboardData() {
    if (!currentTourDetail) return;

    // Load from tour data
    const feedbackCount = currentTourDetail.feedback_count || 0;
    const totalPassengers = currentTourDetail.total_passengers || 0;

    document.getElementById('feedbackCount').textContent = feedbackCount;
    document.getElementById('totalPassengers').textContent = totalPassengers;
    document.getElementById('totalPassengersInput').value = totalPassengers || '';

    // Calculate percentage
    const percentage = totalPassengers > 0 ? Math.round((feedbackCount / totalPassengers) * 100) : 0;
    document.getElementById('feedbackPercentage').textContent = percentage + '%';
}

function incrementFeedback() {
    const currentCount = parseInt(document.getElementById('feedbackCount').textContent) || 0;
    const newCount = currentCount + 1;
    document.getElementById('feedbackCount').textContent = newCount;
    updatePercentage();
    // Auto-save
    saveFeedbackCount(newCount);
}

function decrementFeedback() {
    const currentCount = parseInt(document.getElementById('feedbackCount').textContent) || 0;
    if (currentCount > 0) {
        const newCount = currentCount - 1;
        document.getElementById('feedbackCount').textContent = newCount;
        updatePercentage();
        // Auto-save
        saveFeedbackCount(newCount);
    }
}

function updatePercentage() {
    const feedbackCount = parseInt(document.getElementById('feedbackCount').textContent) || 0;
    const totalPassengers = parseInt(document.getElementById('totalPassengers').textContent) || 0;
    const percentage = totalPassengers > 0 ? Math.round((feedbackCount / totalPassengers) * 100) : 0;
    document.getElementById('feedbackPercentage').textContent = percentage + '%';
}

async function saveFeedbackCount(count) {
    if (!currentTourDetail || !currentTourDetail.id) return;

    try {
        const { error } = await supabaseClient
            .from('tours')
            .update({ feedback_count: count })
            .eq('id', currentTourDetail.id);

        if (error) throw error;

        // Update current tour detail
        currentTourDetail.feedback_count = count;

    } catch (error) {
        console.error('Save feedback error:', error);
        alert('‚ùå Errore salvataggio feedback:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function saveDashboardData() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const totalPassengers = parseInt(document.getElementById('totalPassengersInput').value) || 0;

    if (totalPassengers < 1) {
        alert('‚ùå Inserisci un numero di passeggeri valido');
        return;
    }

    showSaveSpinner('Salvataggio...');

    try {
        const { error } = await supabaseClient
            .from('tours')
            .update({ total_passengers: totalPassengers })
            .eq('id', currentTourDetail.id);

        if (error) throw error;

        // Update current tour detail and display
        currentTourDetail.total_passengers = totalPassengers;
        document.getElementById('totalPassengers').textContent = totalPassengers;
        updatePercentage();

        hideSaveSpinner();
        alert('‚úÖ Dati salvati!');

    } catch (error) {
        hideSaveSpinner();
        console.error('Save dashboard data error:', error);
        alert('‚ùå Errore salvataggio:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function handlePassengersChange(e) {
    // Deprecated - now using saveDashboardData button
    const total = parseInt(e.target.value) || 0;
    document.getElementById('totalPassengers').textContent = total;
    updatePercentage();
}

async function handleDeleteTour() {
    if (!currentTourDetail) return;

    // Confirm deletion
    const confirmed = confirm(
        `‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler cancellare il tour:\n\n"${currentTourDetail.code} - ${currentTourDetail.name}"\n\nQuesta azione √® IRREVERSIBILE!`
    );

    if (!confirmed) return;

    try {
        const { error } = await supabaseClient
            .from('tours')
            .delete()
            .eq('id', currentTourDetail.id);

        if (error) throw error;

        // Success
        alert('‚úÖ Tour cancellato con successo!');

        // Close modal
        if (tourDetailModal) tourDetailModal.classList.remove('active');

        // Reload tours
        loadTours();

    } catch (error) {
        console.error('Delete tour error:', error);
        alert('‚ùå Errore nella cancellazione:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

// ===== RESTAURANT FUNCTIONS =====

async function loadRestaurants() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const restaurantsList = document.getElementById('restaurantsList');
    if (!restaurantsList) return;

    try {
        restaurantsList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: restaurants, error } = await supabaseClient
            .from('tour_restaurants')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('city', { ascending: true });

        if (error) throw error;

        if (!restaurants || restaurants.length === 0) {
            restaurantsList.innerHTML = '<p class="loading">Nessun ristorante ancora</p>';
        } else {
            displayRestaurants(restaurants);
        }
    } catch (error) {
        console.error('Load restaurants error:', error);
        restaurantsList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento ristoranti:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayRestaurants(restaurants) {
    const restaurantsList = document.getElementById('restaurantsList');
    if (!restaurantsList) return;

    restaurantsList.innerHTML = restaurants.map(restaurant => {
        const advantages = restaurant.advantages || [];
        const badgesHtml = advantages.map(adv => {
            if (adv.type === 'tl_free') {
                return `<span class="badge badge-green">üéÅ TL Free</span>`;
            } else if (adv.type === 'commission') {
                return `<span class="badge badge-yellow">üí∞ Commission</span>`;
            } else if (adv.type === 'discount') {
                return `<span class="badge badge-blue">üè∑Ô∏è Discount</span>`;
            }
            return '';
        }).join('');

        return `
            <div class="data-card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <h4 style="margin: 0;">${restaurant.name} <span class="badge badge-blue" style="font-size: 11px;">Giorno ${restaurant.day_number || '?'}</span></h4>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="openEditRestaurantForm('${restaurant.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; background: var(--error); border-color: var(--error);" onclick="handleDeleteRestaurant('${restaurant.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="meta">üìç ${restaurant.city || 'N/A'}${restaurant.address ? ' - ' + restaurant.address : ''}</div>
                ${restaurant.phone ? `<div class="meta">üìû ${restaurant.phone}</div>` : ''}
                ${badgesHtml ? `<div style="margin-top: 8px;">${badgesHtml}</div>` : ''}
                ${restaurant.notes ? `<div class="meta" style="margin-top: 8px;">üí¨ ${restaurant.notes}</div>` : ''}
            </div>
        `;
    }).join('');

    // Store restaurants in memory
    window.currentRestaurants = restaurants;
}

function openAddRestaurantForm() {
    currentRestaurantEdit = null;

    // Reset form
    if (restaurantForm) restaurantForm.reset();

    // Set title
    document.getElementById('restaurantModalTitle').textContent = 'Aggiungi Ristorante';

    // Clear error
    hideRestaurantError();

    // Open modal
    if (restaurantModal) restaurantModal.classList.add('active');
}

function openEditRestaurantForm(restaurantId) {
    const restaurant = window.currentRestaurants?.find(r => r.id === restaurantId);
    if (!restaurant) {
        alert('‚ùå Ristorante non trovato');
        return;
    }

    currentRestaurantEdit = restaurant;

    // Populate form
    document.getElementById('restaurantDay').value = restaurant.day_number || '';
    document.getElementById('restaurantName').value = restaurant.name || '';
    document.getElementById('restaurantCity').value = restaurant.city || '';
    document.getElementById('restaurantAddress').value = restaurant.address || '';
    document.getElementById('restaurantPhone').value = restaurant.phone || '';
    document.getElementById('restaurantNotes').value = restaurant.notes || '';

    // Clear all advantages first
    document.getElementById('advTlFree').checked = false;
    document.getElementById('advTlFreeDesc').value = '';
    document.getElementById('advCommission').checked = false;
    document.getElementById('advCommissionDesc').value = '';
    document.getElementById('advDiscount').checked = false;
    document.getElementById('advDiscountDesc').value = '';

    // Populate advantages
    const advantages = restaurant.advantages || [];
    advantages.forEach(adv => {
        if (adv.type === 'tl_free') {
            document.getElementById('advTlFree').checked = true;
            document.getElementById('advTlFreeDesc').value = adv.description || '';
        } else if (adv.type === 'commission') {
            document.getElementById('advCommission').checked = true;
            document.getElementById('advCommissionDesc').value = adv.description || '';
        } else if (adv.type === 'discount') {
            document.getElementById('advDiscount').checked = true;
            document.getElementById('advDiscountDesc').value = adv.description || '';
        }
    });

    // Set title
    document.getElementById('restaurantModalTitle').textContent = 'Modifica Ristorante';

    // Clear error
    hideRestaurantError();

    // Open modal
    if (restaurantModal) restaurantModal.classList.add('active');
}

async function handleSaveRestaurant(e) {
    e.preventDefault();
    hideRestaurantError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showRestaurantError('Tour non selezionato');
        return;
    }

    // Collect form data
    const restaurantData = {
        tour_id: currentTourDetail.id,
        day_number: parseInt(document.getElementById('restaurantDay').value),
        name: document.getElementById('restaurantName').value,
        city: document.getElementById('restaurantCity').value,
        address: document.getElementById('restaurantAddress').value || null,
        phone: document.getElementById('restaurantPhone').value || null,
        notes: document.getElementById('restaurantNotes').value || null,
        advantages: []
    };

    // Collect advantages
    if (document.getElementById('advTlFree').checked) {
        restaurantData.advantages.push({
            type: 'tl_free',
            description: document.getElementById('advTlFreeDesc').value || ''
        });
    }
    if (document.getElementById('advCommission').checked) {
        restaurantData.advantages.push({
            type: 'commission',
            description: document.getElementById('advCommissionDesc').value || ''
        });
    }
    if (document.getElementById('advDiscount').checked) {
        restaurantData.advantages.push({
            type: 'discount',
            description: document.getElementById('advDiscountDesc').value || ''
        });
    }

    try {
        if (currentRestaurantEdit) {
            // Update
            const { error } = await supabaseClient
                .from('tour_restaurants')
                .update(restaurantData)
                .eq('id', currentRestaurantEdit.id);

            if (error) throw error;

            alert('‚úÖ Ristorante aggiornato!');
        } else {
            // Insert
            const { error } = await supabaseClient
                .from('tour_restaurants')
                .insert([restaurantData]);

            if (error) throw error;

            alert('‚úÖ Ristorante aggiunto!');
        }

        // Close modal
        if (restaurantModal) restaurantModal.classList.remove('active');

        // Reload restaurants
        loadRestaurants();

    } catch (error) {
        console.error('Save restaurant error:', error);
        showRestaurantError(error.message || 'Errore nel salvataggio');
    }
}

async function handleDeleteRestaurant(restaurantId) {
    const restaurant = window.currentRestaurants?.find(r => r.id === restaurantId);
    if (!restaurant) return;

    const confirmed = confirm(
        `‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler cancellare:\n\n"${restaurant.name}"\n\nQuesta azione √® IRREVERSIBILE!`
    );

    if (!confirmed) return;

    try {
        const { error } = await supabaseClient
            .from('tour_restaurants')
            .delete()
            .eq('id', restaurantId);

        if (error) throw error;

        alert('‚úÖ Ristorante cancellato!');
        loadRestaurants();

    } catch (error) {
        console.error('Delete restaurant error:', error);
        alert('‚ùå Errore nella cancellazione:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showRestaurantError(message) {
    if (restaurantError) {
        restaurantError.textContent = message;
        restaurantError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideRestaurantError() {
    if (restaurantError) {
        restaurantError.classList.remove('show');
    }
}

// ===== HOTEL FUNCTIONS =====

async function loadHotels() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const hotelsList = document.getElementById('hotelsList');
    if (!hotelsList) return;

    try {
        hotelsList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: hotels, error } = await supabaseClient
            .from('tour_hotels')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('day_number', { ascending: true });

        if (error) throw error;

        if (!hotels || hotels.length === 0) {
            hotelsList.innerHTML = '<p class="loading">Nessun hotel ancora</p>';
        } else {
            displayHotels(hotels);
        }
    } catch (error) {
        console.error('Load hotels error:', error);
        hotelsList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento hotel:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayHotels(hotels) {
    const hotelsList = document.getElementById('hotelsList');
    if (!hotelsList) return;

    hotelsList.innerHTML = hotels.map(hotel => `
        <div class="data-card" style="margin-bottom: 12px; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary-blue);">Giorno ${hotel.day_number}</span>
                        <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${hotel.name}</h4>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                        üìç ${hotel.city}
                        ${hotel.address ? `<br>üìß ${hotel.address}` : ''}
                        ${hotel.phone ? `<br>üìû ${hotel.phone}` : ''}
                    </div>
                    ${hotel.wifi_password ? `
                        <div style="margin-top: 8px; padding: 8px 12px; background: rgba(0, 240, 255, 0.1); border: 1px solid var(--primary-blue); border-radius: 6px;">
                            <span style="font-weight: 600; color: var(--primary-blue);">üîê WiFi:</span> ${hotel.wifi_password}
                        </div>
                    ` : ''}
                    ${hotel.notes ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${hotel.notes}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-left: 12px;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditHotelForm(${hotel.id})">‚úèÔ∏è</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteHotel(${hotel.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddHotelForm() {
    currentHotelEdit = null;

    if (hotelForm) hotelForm.reset();

    document.getElementById('hotelModalTitle').textContent = 'Aggiungi Hotel';

    hideHotelError();

    if (hotelModal) hotelModal.classList.add('active');
}

async function openEditHotelForm(hotelId) {
    try {
        const { data: hotel, error } = await supabaseClient
            .from('tour_hotels')
            .select('*')
            .eq('id', hotelId)
            .single();

        if (error) throw error;
        if (!hotel) throw new Error('Hotel non trovato');

        currentHotelEdit = hotel;

        // Fill form
        document.getElementById('hotelDay').value = hotel.day_number;
        document.getElementById('hotelName').value = hotel.name;
        document.getElementById('hotelCity').value = hotel.city;
        document.getElementById('hotelAddress').value = hotel.address || '';
        document.getElementById('hotelPhone').value = hotel.phone || '';
        document.getElementById('hotelWifiPassword').value = hotel.wifi_password || '';
        document.getElementById('hotelNotes').value = hotel.notes || '';

        document.getElementById('hotelModalTitle').textContent = 'Modifica Hotel';

        hideHotelError();

        if (hotelModal) hotelModal.classList.add('active');

    } catch (error) {
        console.error('Load hotel error:', error);
        alert('‚ùå Errore caricamento hotel:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveHotel(e) {
    e.preventDefault();
    hideHotelError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showHotelError('Tour non selezionato');
        return;
    }

    const hotelData = {
        tour_id: currentTourDetail.id,
        day_number: parseInt(document.getElementById('hotelDay').value),
        name: document.getElementById('hotelName').value,
        city: document.getElementById('hotelCity').value,
        address: document.getElementById('hotelAddress').value || null,
        phone: document.getElementById('hotelPhone').value || null,
        wifi_password: document.getElementById('hotelWifiPassword').value || null,
        notes: document.getElementById('hotelNotes').value || null
    };

    try {
        if (currentHotelEdit && currentHotelEdit.id) {
            // Update existing hotel
            const { error } = await supabaseClient
                .from('tour_hotels')
                .update(hotelData)
                .eq('id', currentHotelEdit.id);

            if (error) throw error;
        } else {
            // Create new hotel
            const { error } = await supabaseClient
                .from('tour_hotels')
                .insert([hotelData]);

            if (error) throw error;
        }

        if (hotelModal) hotelModal.classList.remove('active');

        loadHotels();

    } catch (error) {
        console.error('Save hotel error:', error);
        showHotelError(error.message || 'Errore salvataggio hotel');
    }
}

async function deleteHotel(hotelId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo hotel?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_hotels')
            .delete()
            .eq('id', hotelId);

        if (error) throw error;

        loadHotels();

    } catch (error) {
        console.error('Delete hotel error:', error);
        alert('‚ùå Errore eliminazione hotel:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showHotelError(message) {
    if (hotelError) {
        hotelError.textContent = message;
        hotelError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideHotelError() {
    if (hotelError) {
        hotelError.classList.remove('show');
    }
}

// ===== EMERGENCY CONTACT FUNCTIONS =====

const emergencyTypeIcons = {
    police: 'üöì',
    hospital: 'üè•',
    embassy: 'üèõÔ∏è',
    fire: 'üöí',
    taxi: 'üöï',
    other: 'üìû'
};

const emergencyTypeNames = {
    police: 'Polizia',
    hospital: 'Ospedale',
    embassy: 'Ambasciata/Consolato',
    fire: 'Vigili del Fuoco',
    taxi: 'Taxi',
    other: 'Altro'
};

async function loadEmergencyContacts() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const emergencyList = document.getElementById('emergencyList');
    if (!emergencyList) return;

    try {
        emergencyList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: contacts, error } = await supabaseClient
            .from('tour_emergency_contacts')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('city', { ascending: true });

        if (error) throw error;

        if (!contacts || contacts.length === 0) {
            emergencyList.innerHTML = '<p class="loading">Nessun contatto ancora</p>';
        } else {
            displayEmergencyContacts(contacts);
        }
    } catch (error) {
        console.error('Load emergency contacts error:', error);
        emergencyList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento contatti emergenza:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayEmergencyContacts(contacts) {
    const emergencyList = document.getElementById('emergencyList');
    if (!emergencyList) return;

    // Group contacts by city
    const contactsByCity = contacts.reduce((acc, contact) => {
        if (!acc[contact.city]) {
            acc[contact.city] = [];
        }
        acc[contact.city].push(contact);
        return acc;
    }, {});

    emergencyList.innerHTML = Object.keys(contactsByCity).sort().map(city => `
        <div style="margin-bottom: 24px;">
            <h4 style="font-size: 18px; font-weight: 700; color: var(--primary-blue); margin-bottom: 12px;">üìç ${city}</h4>
            ${contactsByCity[city].map(contact => `
                <div class="data-card" style="margin-bottom: 12px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">${emergencyTypeIcons[contact.contact_type] || 'üìû'}</span>
                                <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${contact.name}</h4>
                                <span style="font-size: 13px; color: var(--text-secondary);">(${emergencyTypeNames[contact.contact_type] || contact.contact_type})</span>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                                üìû <a href="tel:${contact.phone}" style="color: var(--primary-blue); text-decoration: none;">${contact.phone}</a>
                                ${contact.address ? `<br>üìß ${contact.address}` : ''}
                            </div>
                            ${contact.notes ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${contact.notes}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 12px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditEmergencyForm(${contact.id})">‚úèÔ∏è</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteEmergencyContact(${contact.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `).join('');
}

function openAddEmergencyForm() {
    currentEmergencyEdit = null;

    if (emergencyForm) emergencyForm.reset();

    document.getElementById('emergencyModalTitle').textContent = 'Aggiungi Contatto di Emergenza';

    hideEmergencyError();

    if (emergencyModal) emergencyModal.classList.add('active');
}

async function openEditEmergencyForm(contactId) {
    try {
        const { data: contact, error } = await supabaseClient
            .from('tour_emergency_contacts')
            .select('*')
            .eq('id', contactId)
            .single();

        if (error) throw error;
        if (!contact) throw new Error('Contatto non trovato');

        currentEmergencyEdit = contact;

        // Fill form
        document.getElementById('emergencyCity').value = contact.city;
        document.getElementById('emergencyType').value = contact.contact_type;
        document.getElementById('emergencyName').value = contact.name;
        document.getElementById('emergencyPhone').value = contact.phone;
        document.getElementById('emergencyAddress').value = contact.address || '';
        document.getElementById('emergencyNotes').value = contact.notes || '';

        document.getElementById('emergencyModalTitle').textContent = 'Modifica Contatto di Emergenza';

        hideEmergencyError();

        if (emergencyModal) emergencyModal.classList.add('active');

    } catch (error) {
        console.error('Load emergency contact error:', error);
        alert('‚ùå Errore caricamento contatto:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveEmergency(e) {
    e.preventDefault();
    hideEmergencyError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showEmergencyError('Tour non selezionato');
        return;
    }

    const contactData = {
        tour_id: currentTourDetail.id,
        city: document.getElementById('emergencyCity').value,
        contact_type: document.getElementById('emergencyType').value,
        name: document.getElementById('emergencyName').value,
        phone: document.getElementById('emergencyPhone').value,
        address: document.getElementById('emergencyAddress').value || null,
        notes: document.getElementById('emergencyNotes').value || null
    };

    try {
        if (currentEmergencyEdit && currentEmergencyEdit.id) {
            // Update existing contact
            const { error } = await supabaseClient
                .from('tour_emergency_contacts')
                .update(contactData)
                .eq('id', currentEmergencyEdit.id);

            if (error) throw error;
        } else {
            // Create new contact
            const { error } = await supabaseClient
                .from('tour_emergency_contacts')
                .insert([contactData]);

            if (error) throw error;
        }

        if (emergencyModal) emergencyModal.classList.remove('active');

        loadEmergencyContacts();

    } catch (error) {
        console.error('Save emergency contact error:', error);
        showEmergencyError(error.message || 'Errore salvataggio contatto');
    }
}

async function deleteEmergencyContact(contactId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo contatto?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_emergency_contacts')
            .delete()
            .eq('id', contactId);

        if (error) throw error;

        loadEmergencyContacts();

    } catch (error) {
        console.error('Delete emergency contact error:', error);
        alert('‚ùå Errore eliminazione contatto:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showEmergencyError(message) {
    if (emergencyError) {
        emergencyError.textContent = message;
        emergencyError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideEmergencyError() {
    if (emergencyError) {
        emergencyError.classList.remove('show');
    }
}

// ===== FILE FUNCTIONS =====

const fileTypeIcons = {
    itinerary: 'üìÖ',
    voucher: 'üé´',
    contract: 'üìã',
    insurance: 'üõ°Ô∏è',
    passport: 'üõÇ',
    map: 'üó∫Ô∏è',
    other: 'üìÑ'
};

const fileTypeNames = {
    itinerary: 'Itinerario',
    voucher: 'Voucher',
    contract: 'Contratto',
    insurance: 'Assicurazione',
    passport: 'Documento Identit√†',
    map: 'Mappa',
    other: 'Altro'
};

async function loadFiles() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const filesList = document.getElementById('filesList');
    if (!filesList) return;

    try {
        filesList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: files, error } = await supabaseClient
            .from('tour_files')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!files || files.length === 0) {
            filesList.innerHTML = '<p class="loading">Nessun file ancora</p>';
        } else {
            displayFiles(files);
        }
    } catch (error) {
        console.error('Load files error:', error);
        filesList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento file:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayFiles(files) {
    const filesList = document.getElementById('filesList');
    if (!filesList) return;

    filesList.innerHTML = files.map(file => `
        <div class="data-card" style="margin-bottom: 12px; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 20px;">${fileTypeIcons[file.file_type] || 'üìÑ'}</span>
                        <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${file.name}</h4>
                        <span style="font-size: 13px; color: var(--text-secondary);">(${fileTypeNames[file.file_type] || file.file_type})</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <a href="${file.url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); text-decoration: none; font-size: 14px;">
                            üîó Apri documento ‚Üí
                        </a>
                    </div>
                    ${file.notes ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${file.notes}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-left: 12px;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditFileForm(${file.id})">‚úèÔ∏è</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteFile(${file.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddFileForm() {
    currentFileEdit = null;

    if (fileForm) fileForm.reset();

    document.getElementById('fileModalTitle').textContent = 'Aggiungi Documento';

    hideFileError();

    if (fileModal) fileModal.classList.add('active');
}

async function openEditFileForm(fileId) {
    try {
        const { data: file, error } = await supabaseClient
            .from('tour_files')
            .select('*')
            .eq('id', fileId)
            .single();

        if (error) throw error;
        if (!file) throw new Error('File non trovato');

        currentFileEdit = file;

        // Fill form
        document.getElementById('fileName').value = file.name;
        document.getElementById('fileType').value = file.file_type;
        document.getElementById('fileUrl').value = file.url;
        document.getElementById('fileNotes').value = file.notes || '';

        document.getElementById('fileModalTitle').textContent = 'Modifica Documento';

        hideFileError();

        if (fileModal) fileModal.classList.add('active');

    } catch (error) {
        console.error('Load file error:', error);
        alert('‚ùå Errore caricamento file:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveFile(e) {
    e.preventDefault();
    hideFileError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showFileError('Tour non selezionato');
        return;
    }

    const fileData = {
        tour_id: currentTourDetail.id,
        name: document.getElementById('fileName').value,
        file_type: document.getElementById('fileType').value,
        url: document.getElementById('fileUrl').value,
        notes: document.getElementById('fileNotes').value || null
    };

    try {
        if (currentFileEdit && currentFileEdit.id) {
            // Update existing file
            const { error } = await supabaseClient
                .from('tour_files')
                .update(fileData)
                .eq('id', currentFileEdit.id);

            if (error) throw error;
        } else {
            // Create new file
            const { error } = await supabaseClient
                .from('tour_files')
                .insert([fileData]);

            if (error) throw error;
        }

        if (fileModal) fileModal.classList.remove('active');

        loadFiles();

    } catch (error) {
        console.error('Save file error:', error);
        showFileError(error.message || 'Errore salvataggio file');
    }
}

async function deleteFile(fileId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo file?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_files')
            .delete()
            .eq('id', fileId);

        if (error) throw error;

        loadFiles();

    } catch (error) {
        console.error('Delete file error:', error);
        alert('‚ùå Errore eliminazione file:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showFileError(message) {
    if (fileError) {
        fileError.textContent = message;
        fileError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideFileError() {
    if (fileError) {
        fileError.classList.remove('show');
    }
}

// ===== LINK FUNCTIONS =====

const linkCategoryIcons = {
    weather: 'üå§Ô∏è',
    transport: 'üöá',
    restaurant: 'üçΩÔ∏è',
    attraction: 'üèõÔ∏è',
    booking: 'üè®',
    map: 'üó∫Ô∏è',
    other: 'üîó'
};

const linkCategoryNames = {
    weather: 'Meteo',
    transport: 'Trasporti',
    restaurant: 'Ristoranti',
    attraction: 'Attrazioni',
    booking: 'Prenotazioni',
    map: 'Mappe',
    other: 'Altro'
};

async function loadLinks() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const linksList = document.getElementById('linksList');
    if (!linksList) return;

    try {
        linksList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: links, error } = await supabaseClient
            .from('tour_links')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!links || links.length === 0) {
            linksList.innerHTML = '<p class="loading">Nessun link ancora</p>';
        } else {
            displayLinks(links);
        }
    } catch (error) {
        console.error('Load links error:', error);
        linksList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento link:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayLinks(links) {
    const linksList = document.getElementById('linksList');
    if (!linksList) return;

    linksList.innerHTML = links.map(link => `
        <div class="data-card" style="margin-bottom: 12px; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 20px;">${linkCategoryIcons[link.category] || 'üîó'}</span>
                        <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${link.title}</h4>
                        <span style="font-size: 13px; color: var(--text-secondary);">(${linkCategoryNames[link.category] || link.category})</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <a href="${link.url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); text-decoration: none; font-size: 14px;">
                            üîó Apri link ‚Üí
                        </a>
                    </div>
                    ${link.description ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${link.description}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-left: 12px;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditLinkForm(${link.id})">‚úèÔ∏è</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteLink(${link.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddLinkForm() {
    currentLinkEdit = null;

    if (linkForm) linkForm.reset();

    document.getElementById('linkModalTitle').textContent = 'Aggiungi Link Utile';

    hideLinkError();

    if (linkModal) linkModal.classList.add('active');
}

async function openEditLinkForm(linkId) {
    try {
        const { data: link, error } = await supabaseClient
            .from('tour_links')
            .select('*')
            .eq('id', linkId)
            .single();

        if (error) throw error;
        if (!link) throw new Error('Link non trovato');

        currentLinkEdit = link;

        // Fill form
        document.getElementById('linkTitle').value = link.title;
        document.getElementById('linkCategory').value = link.category;
        document.getElementById('linkUrl').value = link.url;
        document.getElementById('linkDescription').value = link.description || '';

        document.getElementById('linkModalTitle').textContent = 'Modifica Link';

        hideLinkError();

        if (linkModal) linkModal.classList.add('active');

    } catch (error) {
        console.error('Load link error:', error);
        alert('‚ùå Errore caricamento link:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveLink(e) {
    e.preventDefault();
    hideLinkError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showLinkError('Tour non selezionato');
        return;
    }

    const linkData = {
        tour_id: currentTourDetail.id,
        title: document.getElementById('linkTitle').value,
        category: document.getElementById('linkCategory').value,
        url: document.getElementById('linkUrl').value,
        description: document.getElementById('linkDescription').value || null
    };

    try {
        if (currentLinkEdit && currentLinkEdit.id) {
            // Update existing link
            const { error } = await supabaseClient
                .from('tour_links')
                .update(linkData)
                .eq('id', currentLinkEdit.id);

            if (error) throw error;
        } else {
            // Create new link
            const { error } = await supabaseClient
                .from('tour_links')
                .insert([linkData]);

            if (error) throw error;
        }

        if (linkModal) linkModal.classList.remove('active');

        loadLinks();

    } catch (error) {
        console.error('Save link error:', error);
        showLinkError(error.message || 'Errore salvataggio link');
    }
}

async function deleteLink(linkId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo link?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_links')
            .delete()
            .eq('id', linkId);

        if (error) throw error;

        loadLinks();

    } catch (error) {
        console.error('Delete link error:', error);
        alert('‚ùå Errore eliminazione link:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showLinkError(message) {
    if (linkError) {
        linkError.textContent = message;
        linkError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideLinkError() {
    if (linkError) {
        linkError.classList.remove('show');
    }
}

// ===== PROGRAMMA (DAILY PROGRAM) FUNCTIONS =====

const activityTypeIcons = {
    tour: 'üèõÔ∏è',
    meal: 'üçΩÔ∏è',
    transport: 'üöá',
    free_time: '‚è∞',
    accommodation: 'üè®',
    other: 'üìå'
};

const activityTypeNames = {
    tour: 'Tour',
    meal: 'Pasto',
    transport: 'Trasporto',
    free_time: 'Tempo Libero',
    accommodation: 'Sistemazione',
    other: 'Altro'
};

async function loadProgram() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const daysList = document.getElementById('daysList');
    if (!daysList) return;

    try {
        daysList.innerHTML = '<p class="loading">Caricamento...</p>';

        // Use NODŒû Day Engine API
        const NODEX_API = 'https://blueriot-matrikh-nodks.onrender.com/api/days';
        const response = await fetch(`${NODEX_API}/tour/${currentTourDetail.id}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        const days = result.days || [];

        if (days.length === 0) {
            daysList.innerHTML = '<p class="loading">Clicca "Genera Giorni" per creare il programma</p>';
        } else {
            await displayProgram(days);
        }
    } catch (error) {
        console.error('Load program error:', error);
        daysList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento programma:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function displayProgram(days) {
    const daysList = document.getElementById('daysList');
    if (!daysList) return;

    daysList.innerHTML = days.map(day => `
        <div class="day-card" draggable="true" data-day-id="${day.id}" data-logical-number="${day.logical_day_number}" style="margin-bottom: 16px; cursor: move;">
            <div class="data-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px; cursor: grab;">‚ãÆ‚ãÆ</span>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--primary-blue); margin: 0;">Giorno ${day.logical_day_number}</h3>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 4px 0 0 0;">${formatDate(day.calendar_date)}</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" onclick="openEditDayForm('${day.id}')">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="deleteDay('${day.id}')">üóëÔ∏è</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    ${day.cities && day.cities.length > 0 ? `
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">üìç Citt√†</div>
                            <div style="font-size: 14px; font-weight: 600;">${day.cities.join(', ')}</div>
                        </div>
                    ` : ''}
                    ${day.morning_schedule ? `
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">üåÖ Mattina</div>
                            <div style="font-size: 14px;">${day.morning_schedule}</div>
                        </div>
                    ` : ''}
                    ${day.afternoon_schedule ? `
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">‚òÄÔ∏è Pomeriggio</div>
                            <div style="font-size: 14px;">${day.afternoon_schedule}</div>
                        </div>
                    ` : ''}
                    ${day.evening_schedule ? `
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">üåô Sera</div>
                            <div style="font-size: 14px;">${day.evening_schedule}</div>
                        </div>
                    ` : ''}
                    ${day.notes ? `
                        <div style="grid-column: 1 / -1;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">üìù Note</div>
                            <div style="font-size: 14px;">${day.notes}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');

    // Initialize drag and drop
    initializeDragAndDrop();
}

// ===== DRAG AND DROP FOR DAY REORDERING =====

let draggedDay = null;

function initializeDragAndDrop() {
    const dayCards = document.querySelectorAll('.day-card');

    dayCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
    });
}

function handleDragStart(e) {
    draggedDay = this;
    this.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';

    const afterElement = getDragAfterElement(e.clientY);
    if (afterElement == null) {
        this.parentElement.appendChild(draggedDay);
    } else {
        this.parentElement.insertBefore(draggedDay, afterElement);
    }

    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    return false;
}

async function handleDragEnd(e) {
    this.style.opacity = '1';

    // Get new order
    const dayCards = document.querySelectorAll('.day-card');
    const newOrder = Array.from(dayCards).map((card, index) => ({
        id: card.dataset.dayId,
        new_logical_day_number: index + 1
    }));

    // Save new order to API
    try {
        const NODEX_API = 'https://blueriot-matrikh-nodks.onrender.com/api/days';
        const response = await fetch(`${NODEX_API}/reorder`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tourId: currentTourDetail.id,
                dayOrder: newOrder
            })
        });

        if (!response.ok) {
            throw new Error('Errore riordinamento giorni');
        }

        // Reload to show updated numbers
        await loadProgram();
    } catch (error) {
        console.error('Reorder error:', error);
        alert('‚ùå Errore durante il riordinamento. Ricarica la pagina.');
    }
}

function getDragAfterElement(y) {
    const dayCards = [...document.querySelectorAll('.day-card:not(.dragging)')];

    return dayCards.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// ===== DAY MANAGEMENT FUNCTIONS =====

async function deleteDay(dayId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo giorno? Tutti i giorni successivi verranno rinumerati.')) {
        return;
    }

    try {
        const NODEX_API = 'https://blueriot-matrikh-nodks.onrender.com/api/days';
        const response = await fetch(`${NODEX_API}/${dayId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            throw new Error('Errore eliminazione giorno');
        }

        await loadProgram();
        alert('‚úÖ Giorno eliminato con successo');
    } catch (error) {
        console.error('Delete day error:', error);
        alert('‚ùå Errore durante l\'eliminazione del giorno');
    }
}

function openEditDayForm(dayId) {
    alert('üöß Funzione modifica giorno in sviluppo. Per ora puoi modificare direttamente dal database o ricreare i giorni.');
}

async function generateDays() {
    if (!currentTourDetail || !currentTourDetail.id) {
        alert('‚ùå Tour non selezionato');
        return;
    }

    if (!currentTourDetail.start_date || !currentTourDetail.end_date) {
        alert('‚ùå Date del tour non impostate');
        return;
    }

    try {
        // Check if days already exist using NODŒû API
        const NODEX_API = 'https://blueriot-matrikh-nodks.onrender.com/api/days';
        const checkResponse = await fetch(`${NODEX_API}/tour/${currentTourDetail.id}`);

        if (checkResponse.ok) {
            const result = await checkResponse.json();
            if (result.days && result.days.length > 0) {
                if (!confirm('‚ö†Ô∏è I giorni sono gi√† stati generati. Vuoi rigenerarli? Questo eliminer√† tutti i giorni esistenti!')) {
                    return;
                }

                // Delete existing days
                for (const day of result.days) {
                    await fetch(`${NODEX_API}/${day.id}`, { method: 'DELETE' });
                }
            }
        }

        // Generate days between start and end date
        const startDate = new Date(currentTourDetail.start_date);
        const endDate = new Date(currentTourDetail.end_date);
        const daysCreated = [];

        for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
            const dayData = {
                tour_id: currentTourDetail.id,
                calendar_date: date.toISOString().split('T')[0],
                day_title: `Giorno ${daysCreated.length + 1}`,
                cities: [],
                morning_schedule: null,
                afternoon_schedule: null,
                evening_schedule: null
            };

            const response = await fetch(NODEX_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dayData)
            });

            if (!response.ok) {
                throw new Error('Errore creazione giorno');
            }

            const result = await response.json();
            daysCreated.push(result.day);
        }

        alert(`‚úÖ Generati ${daysCreated.length} giorni con successo!`);
        loadProgram();

    } catch (error) {
        console.error('Generate days error:', error);
        alert('‚ùå Errore generazione giorni:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function openAddActivityForm(dayNumber) {
    currentActivityEdit = null;

    if (activityForm) activityForm.reset();

    document.getElementById('activityDayNumber').value = dayNumber;
    document.getElementById('activityModalTitle').textContent = `Aggiungi Attivit√† - Giorno ${dayNumber}`;

    hideActivityError();

    if (activityModal) activityModal.classList.add('active');
}

async function openEditActivityForm(activityId) {
    try {
        const { data: activity, error } = await supabaseClient
            .from('tour_activities')
            .select('*')
            .eq('id', activityId)
            .single();

        if (error) throw error;
        if (!activity) throw new Error('Attivit√† non trovata');

        currentActivityEdit = activity;

        // Fill form
        document.getElementById('activityDayNumber').value = activity.day_number;
        document.getElementById('activityTime').value = activity.time;
        document.getElementById('activityTitle').value = activity.title;
        document.getElementById('activityType').value = activity.activity_type;
        document.getElementById('activityDescription').value = activity.description || '';
        document.getElementById('activityLocation').value = activity.location || '';

        document.getElementById('activityModalTitle').textContent = `Modifica Attivit√† - Giorno ${activity.day_number}`;

        hideActivityError();

        if (activityModal) activityModal.classList.add('active');

    } catch (error) {
        console.error('Load activity error:', error);
        alert('‚ùå Errore caricamento attivit√†:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveActivity(e) {
    e.preventDefault();
    hideActivityError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showActivityError('Tour non selezionato');
        return;
    }

    const activityData = {
        tour_id: currentTourDetail.id,
        day_number: parseInt(document.getElementById('activityDayNumber').value),
        time: document.getElementById('activityTime').value,
        title: document.getElementById('activityTitle').value,
        activity_type: document.getElementById('activityType').value,
        description: document.getElementById('activityDescription').value || null,
        location: document.getElementById('activityLocation').value || null
    };

    try {
        if (currentActivityEdit && currentActivityEdit.id) {
            // Update existing activity
            const { error } = await supabaseClient
                .from('tour_activities')
                .update(activityData)
                .eq('id', currentActivityEdit.id);

            if (error) throw error;
        } else {
            // Create new activity
            const { error } = await supabaseClient
                .from('tour_activities')
                .insert([activityData]);

            if (error) throw error;
        }

        if (activityModal) activityModal.classList.remove('active');

        loadProgram();

    } catch (error) {
        console.error('Save activity error:', error);
        showActivityError(error.message || 'Errore salvataggio attivit√†');
    }
}

async function deleteActivity(activityId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questa attivit√†?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_activities')
            .delete()
            .eq('id', activityId);

        if (error) throw error;

        loadProgram();

    } catch (error) {
        console.error('Delete activity error:', error);
        alert('‚ùå Errore eliminazione attivit√†:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showActivityError(message) {
    if (activityError) {
        activityError.textContent = message;
        activityError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideActivityError() {
    if (activityError) {
        activityError.classList.remove('show');
    }
}

// ===== TEMPLATES FUNCTIONS =====

async function loadTemplates() {
    if (!currentTL || !currentTL.id) return;

    const templatesList = document.getElementById('templatesList');
    if (!templatesList) return;

    try {
        templatesList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: templates, error } = await supabaseClient
            .from('tour_templates')
            .select('*')
            .eq('tl_id', currentTL.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!templates || templates.length === 0) {
            templatesList.innerHTML = '<p class="loading">Nessun template disponibile</p>';
        } else {
            displayTemplates(templates);
        }
    } catch (error) {
        console.error('Load templates error:', error);
        templatesList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento templates:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayTemplates(templates) {
    const templatesList = document.getElementById('templatesList');
    if (!templatesList) return;

    templatesList.innerHTML = templates.map(template => `
        <div class="data-card" style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <h4 style="font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">${template.name}</h4>
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
                        Creato: ${new Date(template.created_at).toLocaleDateString('it-IT')}
                    </p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" onclick="loadTemplate(${template.id})">üìã Carica</button>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteTemplate(${template.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

async function saveAsTemplate() {
    if (!currentTourDetail || !currentTourDetail.id) {
        alert('‚ùå Nessun tour aperto');
        return;
    }

    const templateNameInput = document.getElementById('templateName');
    const templateName = templateNameInput ? templateNameInput.value.trim() : '';

    if (!templateName) {
        alert('‚ùå Inserisci un nome per il template');
        return;
    }

    try {
        // Load all tour data
        const [
            { data: restaurants },
            { data: hotels },
            { data: emergencyContacts },
            { data: files },
            { data: links },
            { data: days },
            { data: activities }
        ] = await Promise.all([
            supabaseClient.from('tour_restaurants').select('*').eq('tour_id', currentTourDetail.id),
            supabaseClient.from('tour_hotels').select('*').eq('tour_id', currentTourDetail.id),
            supabaseClient.from('tour_emergency_contacts').select('*').eq('tour_id', currentTourDetail.id),
            supabaseClient.from('tour_files').select('*').eq('tour_id', currentTourDetail.id),
            supabaseClient.from('tour_links').select('*').eq('tour_id', currentTourDetail.id),
            supabaseClient.from('tour_days').select('*').eq('tour_id', currentTourDetail.id),
            supabaseClient.from('tour_activities').select('*').eq('tour_id', currentTourDetail.id)
        ]);

        // Create template object
        const templateData = {
            tl_id: currentTL.id,
            name: templateName,
            data: {
                restaurants: restaurants || [],
                hotels: hotels || [],
                emergencyContacts: emergencyContacts || [],
                files: files || [],
                links: links || [],
                days: days || [],
                activities: activities || []
            }
        };

        // Save template
        const { error } = await supabaseClient
            .from('tour_templates')
            .insert([templateData]);

        if (error) throw error;

        alert(`‚úÖ Template "${templateName}" salvato con successo!`);
        if (templateNameInput) templateNameInput.value = '';
        loadTemplates();

    } catch (error) {
        console.error('Save template error:', error);
        alert('‚ùå Errore salvataggio template:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function loadTemplate(templateId) {
    if (!currentTourDetail || !currentTourDetail.id) {
        alert('‚ùå Nessun tour aperto');
        return;
    }

    if (!confirm('‚ö†Ô∏è Caricare questo template? Questo aggiunger√† i dati del template al tour corrente (non sovrascriver√† i dati esistenti).')) {
        return;
    }

    try {
        // Load template
        const { data: template, error } = await supabaseClient
            .from('tour_templates')
            .select('*')
            .eq('id', templateId)
            .single();

        if (error) throw error;
        if (!template || !template.data) {
            alert('‚ùå Template non valido');
            return;
        }

        const templateData = template.data;

        // Insert restaurants (remove id and tour_id fields)
        if (templateData.restaurants && templateData.restaurants.length > 0) {
            const restaurants = templateData.restaurants.map(r => {
                const { id, tour_id, created_at, ...rest } = r;
                return { ...rest, tour_id: currentTourDetail.id };
            });
            await supabaseClient.from('tour_restaurants').insert(restaurants);
        }

        // Insert hotels
        if (templateData.hotels && templateData.hotels.length > 0) {
            const hotels = templateData.hotels.map(h => {
                const { id, tour_id, created_at, ...rest } = h;
                return { ...rest, tour_id: currentTourDetail.id };
            });
            await supabaseClient.from('tour_hotels').insert(hotels);
        }

        // Insert emergency contacts
        if (templateData.emergencyContacts && templateData.emergencyContacts.length > 0) {
            const contacts = templateData.emergencyContacts.map(c => {
                const { id, tour_id, created_at, ...rest } = c;
                return { ...rest, tour_id: currentTourDetail.id };
            });
            await supabaseClient.from('tour_emergency_contacts').insert(contacts);
        }

        // Insert files
        if (templateData.files && templateData.files.length > 0) {
            const files = templateData.files.map(f => {
                const { id, tour_id, created_at, ...rest } = f;
                return { ...rest, tour_id: currentTourDetail.id };
            });
            await supabaseClient.from('tour_files').insert(files);
        }

        // Insert links
        if (templateData.links && templateData.links.length > 0) {
            const links = templateData.links.map(l => {
                const { id, tour_id, created_at, ...rest } = l;
                return { ...rest, tour_id: currentTourDetail.id };
            });
            await supabaseClient.from('tour_links').insert(links);
        }

        // Insert days and activities
        if (templateData.days && templateData.days.length > 0) {
            const days = templateData.days.map(d => {
                const { id, tour_id, created_at, ...rest } = d;
                return { ...rest, tour_id: currentTourDetail.id };
            });
            await supabaseClient.from('tour_days').insert(days);

            if (templateData.activities && templateData.activities.length > 0) {
                const activities = templateData.activities.map(a => {
                    const { id, tour_id, created_at, ...rest } = a;
                    return { ...rest, tour_id: currentTourDetail.id };
                });
                await supabaseClient.from('tour_activities').insert(activities);
            }
        }

        alert(`‚úÖ Template "${template.name}" caricato con successo!`);

        // Reload current tab
        const activeTab = document.querySelector('.tab-btn.active');
        if (activeTab) {
            const tabName = activeTab.dataset.tab;
            switchTab(tabName);
        }

    } catch (error) {
        console.error('Load template error:', error);
        alert('‚ùå Errore caricamento template:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function deleteTemplate(templateId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo template?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_templates')
            .delete()
            .eq('id', templateId);

        if (error) throw error;

        alert('‚úÖ Template eliminato');
        loadTemplates();

    } catch (error) {
        console.error('Delete template error:', error);
        alert('‚ùå Errore eliminazione template:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

// ===== SCREEN NAVIGATION =====

function showScreen(screenName) {
    const screens = {
        ecosystem: document.getElementById('ecosystemHomeScreen'),
        dashboard: document.getElementById('dashboardScreen'),
        tastes: document.getElementById('restaurantDatabaseScreen'),
        routes: document.getElementById('routesScreen'),
        stay: document.getElementById('stayScreen')
    };

    // Hide all screens
    Object.values(screens).forEach(screen => {
        if (screen) screen.classList.remove('active');
    });

    // Show selected screen
    if (screens[screenName]) {
        screens[screenName].classList.add('active');

        // Load data for specific screens
        if (screenName === 'dashboard') {
            loadTours();
        } else if (screenName === 'tastes') {
            loadSharedRestaurants();
        } else if (screenName === 'routes') {
            loadRoutes();
        } else if (screenName === 'stay') {
            loadStayOptions();
        }
    }
}

// Navigate from ecosystem cards to sections
function navigateToSection(section) {
    if (section === 'hub') {
        showScreen('dashboard');
    } else if (section === 'tastes') {
        showScreen('tastes');
    } else if (section === 'routes') {
        showScreen('routes');
    } else if (section === 'stay') {
        showScreen('stay');
    }
}

// Navigate back to ecosystem home
function backToEcosystem() {
    showScreen('ecosystem');
}

// ===== SHARED RESTAURANT DATABASE FUNCTIONS =====

async function loadSharedRestaurants() {
    const sharedRestaurantsList = document.getElementById('sharedRestaurantsList');
    if (!sharedRestaurantsList) return;

    try {
        sharedRestaurantsList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: restaurants, error } = await supabaseClient
            .from('blueriot_tastes')
            .select('*')
            .order('location', { ascending: true });

        if (error) throw error;

        if (!restaurants || restaurants.length === 0) {
            sharedRestaurantsList.innerHTML = '<p class="loading">Nessun ristorante nel database ancora. Sii il primo ad aggiungerne uno!</p>';
        } else {
            displaySharedRestaurants(restaurants);
        }
    } catch (error) {
        console.error('Load shared restaurants error:', error);
        sharedRestaurantsList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento database ristoranti:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displaySharedRestaurants(restaurants) {
    const sharedRestaurantsList = document.getElementById('sharedRestaurantsList');
    if (!sharedRestaurantsList) return;

    // Build hierarchical structure: country ‚Üí region ‚Üí city ‚Üí restaurants
    const hierarchy = {};

    restaurants.forEach(restaurant => {
        const country = restaurant.country || 'Other';
        const region = restaurant.region || 'Other';
        const city = restaurant.city || restaurant.location || 'Other';

        if (!hierarchy[country]) hierarchy[country] = {};
        if (!hierarchy[country][region]) hierarchy[country][region] = {};
        if (!hierarchy[country][region][city]) hierarchy[country][region][city] = [];

        hierarchy[country][region][city].push(restaurant);
    });

    // Sort alphabetically
    const countries = Object.keys(hierarchy).sort();

    let html = '<div style="padding: 20px;">';

    countries.forEach(country => {
        const countryCount = Object.values(hierarchy[country]).flat().flat().length;
        const countryId = country.replace(/\s+/g, '_');

        html += `
            <div style="margin-bottom: 24px;">
                <button onclick="toggleSection('${countryId}')"
                        style="width: 100%; text-align: left; padding: 16px; background: var(--card-bg); border: 2px solid var(--primary-blue); border-radius: 12px; color: var(--text-primary); font-size: 18px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <span>üåç ${country} <span style="color: var(--text-secondary); font-size: 14px; font-weight: 400;">(${countryCount})</span></span>
                    <span id="${countryId}_arrow">‚ñº</span>
                </button>

                <div id="${countryId}" style="display: none; margin-left: 20px; margin-top: 12px;">
        `;

        const regions = Object.keys(hierarchy[country]).sort();

        regions.forEach(region => {
            const regionCount = Object.values(hierarchy[country][region]).flat().length;
            const regionId = `${countryId}_${region.replace(/\s+/g, '_')}`;

            html += `
                <button onclick="toggleSection('${regionId}')"
                        style="width: 100%; text-align: left; padding: 12px; margin-bottom: 8px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìç ${region} <span style="color: var(--text-secondary); font-size: 13px;">(${regionCount})</span></span>
                    <span id="${regionId}_arrow">‚ñ∂</span>
                </button>

                <div id="${regionId}" style="display: none; margin-left: 20px; margin-top: 8px;">
            `;

            const cities = Object.keys(hierarchy[country][region]).sort();

            cities.forEach(city => {
                const cityRestaurants = hierarchy[country][region][city];
                const cityId = `${regionId}_${city.replace(/\s+/g, '_')}`;

                html += `
                    <button onclick="toggleSection('${cityId}')"
                            style="width: 100%; text-align: left; padding: 10px; margin-bottom: 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-blue); font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>üèôÔ∏è ${city} <span style="color: var(--text-secondary); font-size: 12px;">(${cityRestaurants.length})</span></span>
                        <span id="${cityId}_arrow">‚ñ∂</span>
                    </button>

                    <div id="${cityId}" style="display: none; margin-left: 20px; margin-top: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 16px;">
                `;

                cityRestaurants.forEach(restaurant => {
                    const stars = '‚≠ê'.repeat(Math.round(restaurant.rating_avg || 0));
                    const cardId = `card_${restaurant.id}`;
                    const detailsId = `details_${restaurant.id}`;

                    // Parse phone numbers (can be array or string)
                    let phoneDisplay = '';
                    if (restaurant.phone) {
                        const phones = Array.isArray(restaurant.phone) ? restaurant.phone : [restaurant.phone];
                        phoneDisplay = phones.map(p => `üìû ${p}`).join('<br>');
                    }

                    html += `
                        <div id="${cardId}" class="data-card" style="font-size: 13px; cursor: pointer; transition: all 0.2s;" onclick="toggleCardDetails('${detailsId}', '${cardId}')">
                            <h4 style="margin: 0 0 6px 0; font-size: 15px;">${restaurant.name}</h4>

                            <!-- BASIC INFO (always visible) -->
                            <div style="font-size: 12px;">
                                ${restaurant.cuisine ? `<div class="meta">üçΩÔ∏è ${restaurant.cuisine}</div>` : ''}
                                ${restaurant.price_range ? `<div class="meta">${restaurant.price_range}</div>` : ''}
                                <div style="margin-top: 6px;">
                                    ${restaurant.gratuity ? '<span class="badge badge-green" style="font-size: 10px; padding: 3px 6px;">üéÅ TL Free</span>' : ''}
                                    ${restaurant.commission ? '<span class="badge badge-yellow" style="font-size: 10px; padding: 3px 6px;">üí∞ ' + (restaurant.commission_percentage ? restaurant.commission_percentage + '%' : 'Comm.') + '</span>' : ''}
                                    ${restaurant.discount_percentage ? '<span class="badge badge-blue" style="font-size: 10px; padding: 3px 6px;">üè∑Ô∏è ' + restaurant.discount_percentage + '%</span>' : ''}
                                </div>
                            </div>

                            <!-- DETAILED INFO (collapsible) -->
                            <div id="${detailsId}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 12px;" onclick="event.stopPropagation()">
                                ${restaurant.address ? `<div class="meta">üìç ${restaurant.address}</div>` : ''}
                                ${phoneDisplay ? `<div class="meta">${phoneDisplay}</div>` : ''}
                                ${restaurant.google_maps_link ? `<div class="meta"><a href="${restaurant.google_maps_link}" target="_blank" style="color: var(--primary-blue);">üó∫Ô∏è Google Maps</a></div>` : ''}
                                ${restaurant.opening_hours ? `<div class="meta">üïê ${restaurant.opening_hours}</div>` : ''}
                                ${restaurant.booking_needed ? '<div class="meta">üìÖ Prenotazione necessaria</div>' : ''}
                                ${restaurant.min_group_size || restaurant.max_group_size ? `<div class="meta">üë• Gruppi: ${restaurant.min_group_size || '?'}-${restaurant.max_group_size || '?'} persone</div>` : ''}
                                ${stars ? `<div style="margin-top: 6px;">${stars} (${restaurant.total_ratings || 0})</div>` : ''}
                                ${restaurant.notes ? `<div class="meta" style="margin-top: 6px;">üí¨ ${restaurant.notes}</div>` : ''}
                                ${restaurant.tested_by ? `<div class="meta" style="margin-top: 6px; font-size: 11px;">üß™ Testato da ${restaurant.tested_by}${restaurant.tested_date ? ' il ' + restaurant.tested_date : ''}</div>` : ''}

                                <!-- ACTION BUTTONS -->
                                <div style="display: flex; gap: 6px; margin-top: 10px;">
                                    <button class="btn btn-secondary" style="flex: 1; padding: 6px; font-size: 11px;" onclick="editRestaurant('${restaurant.id}')">‚úèÔ∏è Modifica</button>
                                    <button class="btn btn-secondary" style="flex: 1; padding: 6px; font-size: 11px;" onclick="openRatingModal('${restaurant.id}')">‚≠ê Vota</button>
                                    <button class="btn" style="padding: 6px 10px; font-size: 14px; background: #ff0000; border-color: #ff0000; color: white; font-weight: bold;" onclick="deleteRestaurant('${restaurant.id}', '${restaurant.name}')" title="Elimina">‚úï</button>
                                </div>
                            </div>

                            <!-- EXPAND INDICATOR -->
                            <div style="text-align: center; margin-top: 8px; color: var(--text-secondary); font-size: 11px;">
                                <span id="${detailsId}_arrow">‚ñº Click per dettagli</span>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    });

    html += '</div>';

    sharedRestaurantsList.innerHTML = html;
    window.allSharedRestaurants = restaurants;
}

function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const arrow = document.getElementById(sectionId + '_arrow');

    if (!section || !arrow) return;

    if (section.style.display === 'none') {
        section.style.display = 'block';
        arrow.textContent = '‚ñº';
    } else {
        section.style.display = 'none';
        arrow.textContent = '‚ñ∂';
    }
}

function toggleCardDetails(detailsId, cardId) {
    const details = document.getElementById(detailsId);
    const card = document.getElementById(cardId);
    const arrow = document.getElementById(detailsId + '_arrow');

    if (!details || !arrow) return;

    if (details.style.display === 'none') {
        details.style.display = 'block';
        arrow.textContent = '‚ñ≤ Chiudi';
        if (card) card.style.background = 'rgba(0, 240, 255, 0.05)';
    } else {
        details.style.display = 'none';
        arrow.textContent = '‚ñº Click per dettagli';
        if (card) card.style.background = '';
    }
}

function addPhoneField() {
    const phonesList = document.getElementById('phoneNumbersList');
    if (!phonesList) return;

    const newInput = document.createElement('input');
    newInput.type = 'tel';
    newInput.className = 'phone-input';
    newInput.placeholder = 'es. +39 06 1234567';
    newInput.style.cssText = 'width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;';

    phonesList.appendChild(newInput);
}

function handleVCardUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const vcardText = e.target.result;

            // Parse vCard format
            const lines = vcardText.split(/\r?\n/);
            let name = '';
            let phones = [];
            let organization = '';

            lines.forEach(line => {
                // Extract name (FN = Full Name)
                if (line.startsWith('FN:')) {
                    name = line.substring(3).trim();
                }
                // Extract organization
                if (line.startsWith('ORG:')) {
                    organization = line.substring(4).trim();
                }
                // Extract phone numbers (TEL)
                if (line.startsWith('TEL') || line.includes('TEL')) {
                    const phoneMatch = line.match(/:([\d\s\+\-\(\)]+)$/);
                    if (phoneMatch) {
                        phones.push(phoneMatch[1].trim());
                    }
                }
            });

            // Populate contact person field
            if (name) {
                const contactInput = document.getElementById('sharedContactPerson');
                if (contactInput) {
                    contactInput.value = name + (organization ? ` (${organization})` : '');
                }
            }

            // Populate phone numbers
            if (phones.length > 0) {
                const phonesList = document.getElementById('phoneNumbersList');
                if (phonesList) {
                    phonesList.innerHTML = ''; // Clear existing
                    phones.forEach((phone, index) => {
                        const phoneInput = document.createElement('input');
                        phoneInput.type = 'tel';
                        phoneInput.className = 'phone-input';
                        phoneInput.value = phone;
                        phoneInput.placeholder = 'es. +39 06 1234567';
                        phoneInput.style.cssText = 'width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;';
                        phonesList.appendChild(phoneInput);
                    });
                }
            }

            alert(`‚úÖ vCard importata!\n\nNome: ${name}\nTelefoni: ${phones.length}`);

        } catch (error) {
            console.error('vCard parse error:', error);
            alert('‚ùå Errore nel leggere il file vCard. Assicurati che sia un file .vcf valido.');
        }

        // Reset file input
        event.target.value = '';
    };

    reader.readAsText(file);
}


async function editRestaurant(id) {
    try {
        // Find restaurant data
        const restaurant = window.allSharedRestaurants.find(r => r.id === id);
        if (!restaurant) {
            alert('‚ùå Ristorante non trovato');
            return;
        }

        // Open modal
        const modal = document.getElementById('sharedRestaurantModal');
        const form = document.getElementById('sharedRestaurantForm');
        if (!modal || !form) return;

        // Set editing mode
        window.currentEditingId = id;

        // Fill form with data
        document.getElementById('sharedRestaurantName').value = restaurant.name || '';
        document.getElementById('sharedType').value = restaurant.type || '';
        document.getElementById('sharedCuisineType').value = restaurant.cuisine || '';
        document.getElementById('sharedPriceRange').value = restaurant.price_range || '';

        // Location
        document.getElementById('sharedRestaurantCountry').value = restaurant.country || '';
        document.getElementById('sharedRestaurantRegion').value = restaurant.region || '';
        document.getElementById('sharedRestaurantCity').value = restaurant.city || restaurant.location || '';
        document.getElementById('sharedRestaurantAddress').value = restaurant.address || '';
        document.getElementById('sharedGoogleMaps').value = restaurant.google_maps_link || '';

        // Phone numbers
        const phonesList = document.getElementById('phoneNumbersList');
        if (phonesList) {
            phonesList.innerHTML = ''; // Clear existing
            const phones = Array.isArray(restaurant.phone) ? restaurant.phone : (restaurant.phone ? [restaurant.phone] : ['']);
            phones.forEach((phone, i) => {
                const input = document.createElement('input');
                input.type = 'tel';
                input.className = 'phone-input';
                input.value = phone;
                input.placeholder = 'es. +39 06 1234567';
                input.style.cssText = 'width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);';
                phonesList.appendChild(input);
            });
        }

        // Hours
        document.getElementById('sharedOpeningHours').value = restaurant.opening_hours || '';
        document.getElementById('sharedBookingNeeded').checked = restaurant.booking_needed || false;

        // Benefits
        document.getElementById('sharedTlFree').checked = restaurant.gratuity || false;
        document.getElementById('sharedHasCommission').checked = restaurant.commission || false;
        document.getElementById('sharedCommissionPerc').value = restaurant.commission_percentage || '';
        document.getElementById('sharedHasDiscount').checked = restaurant.discount || false;
        document.getElementById('sharedDiscountPerc').value = restaurant.discount_percentage || '';

        // Group
        document.getElementById('sharedSuitableForGroups').checked = restaurant.suitable_for_groups !== false;
        document.getElementById('sharedMinGroupSize').value = restaurant.min_group_size || '';
        document.getElementById('sharedMaxGroupSize').value = restaurant.max_group_size || '';

        // Additional
        document.getElementById('sharedToursRelevant').value = Array.isArray(restaurant.tours_relevant) ? restaurant.tours_relevant.join(', ') : '';
        document.getElementById('sharedTestedBy').value = restaurant.tested_by || '';
        document.getElementById('sharedTestedDate').value = restaurant.tested_date || '';
        document.getElementById('sharedNotes').value = restaurant.notes || '';

        // Change modal title
        const modalTitle = document.getElementById('tastesModalTitle');
        if (modalTitle) modalTitle.textContent = '‚úèÔ∏è Modifica Ristorante';

        modal.classList.add('active');

    } catch (error) {
        console.error('Edit restaurant error:', error);
        alert('‚ùå Errore apertura modifica:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function deleteRestaurant(id, name) {
    if (!confirm(`üóëÔ∏è Sei sicuro di voler eliminare "${name}"?\n\nQuesta azione √® irreversibile!`)) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('blueriot_tastes')
            .delete()
            .eq('id', id);

        if (error) throw error;

        alert(`‚úÖ "${name}" eliminato con successo!`);
        loadSharedRestaurants(); // Reload list
    } catch (error) {
        console.error('Delete restaurant error:', error);
        alert('‚ùå Errore eliminazione:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveSharedRestaurant(e) {
    e.preventDefault();

    if (!currentTL || !currentTL.id) {
        alert('‚ùå Errore: TL non identificato');
        return;
    }

    showSaveSpinner('Salvataggio ristorante...');

    // Parse tours_relevant from comma-separated string to array
    const toursRelevantStr = document.getElementById('sharedToursRelevant').value || '';
    const toursRelevantArray = toursRelevantStr ? toursRelevantStr.split(',').map(t => t.trim()).filter(t => t) : null;

    // Collect phone numbers from all input fields
    const phoneInputs = document.querySelectorAll('.phone-input');
    const phoneNumbers = Array.from(phoneInputs)
        .map(input => input.value.trim())
        .filter(phone => phone); // Remove empty values

    const tastesData = {
        // Basic info
        name: document.getElementById('sharedRestaurantName').value,
        type: document.getElementById('sharedType').value,
        cuisine: document.getElementById('sharedCuisineType').value || null,
        price_range: document.getElementById('sharedPriceRange').value || null,

        // TL benefits
        gratuity: document.getElementById('sharedTlFree').checked,
        commission: document.getElementById('sharedHasCommission').checked,
        commission_percentage: null,
        discount: document.getElementById('sharedDiscountPerc').value ? true : false,
        discount_percentage: document.getElementById('sharedDiscountPerc').value ? parseInt(document.getElementById('sharedDiscountPerc').value) : null,

        // Location (hierarchical structure)
        country: document.getElementById('sharedRestaurantCountry').value,
        region: document.getElementById('sharedRestaurantRegion').value || null,
        city: document.getElementById('sharedRestaurantCity').value,
        location: document.getElementById('sharedRestaurantCity').value,
        address: document.getElementById('sharedRestaurantAddress').value || null,
        contact_person: document.getElementById('sharedContactPerson').value || null,
        phone: phoneNumbers.length > 0 ? phoneNumbers : null,
        google_maps_link: document.getElementById('sharedGoogleMaps').value || null,
        plus_code: document.getElementById('sharedPlusCode').value || null,
        apple_maps_link: document.getElementById('sharedAppleMaps').value || null,
        what3words: document.getElementById('sharedWhat3Words').value || null,

        // Hours
        opening_hours: document.getElementById('sharedOpeningHours').value || null,
        booking_needed: document.getElementById('sharedBookingNeeded').checked,

        // Group suitability
        suitable_for_groups: document.getElementById('sharedSuitableForGroups').checked,
        min_group_size: document.getElementById('sharedMinGroupSize').value ? parseInt(document.getElementById('sharedMinGroupSize').value) : null,
        max_group_size: document.getElementById('sharedMaxGroupSize').value ? parseInt(document.getElementById('sharedMaxGroupSize').value) : null,

        // Tours & testing
        tours_relevant: toursRelevantArray,
        tested_by: document.getElementById('sharedTestedBy').value || null,
        tested_date: document.getElementById('sharedTestedDate').value || null,
        notes: document.getElementById('sharedNotes').value || null,

        // System
        added_by: currentTL.id
    };

    try {
        let result;
        const isEditing = window.currentEditingId;

        if (isEditing) {
            result = await supabaseClient
                .from('blueriot_tastes')
                .update(tastesData)
                .eq('id', isEditing);
        } else {
            result = await supabaseClient
                .from('blueriot_tastes')
                .insert([tastesData]);
        }

        if (result.error) throw result.error;

        hideSaveSpinner();
        alert(isEditing ? '‚úÖ Ristorante modificato!' : '‚úÖ Locale aggiunto al database Œ§ŒîSŒ§Œû5!');

        // Reset and close
        closeModal('sharedRestaurantModal');
        if (sharedRestaurantForm) sharedRestaurantForm.reset();

        // Reset modal title and editing mode
        const modalTitle = document.getElementById('tastesModalTitle');
        if (modalTitle) modalTitle.textContent = 'Aggiungi a Œ§ŒîSŒ§Œû5 Database';
        window.currentEditingId = null;

        // Reload phone field (reset to 1)
        const phonesList = document.getElementById('phoneNumbersList');
        if (phonesList) {
            phonesList.innerHTML = '<input type="tel" class="phone-input" placeholder="es. +39 06 1234567" style="width: 100%; padding: 16px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">';
        }

        loadSharedRestaurants();

    } catch (error) {
        hideSaveSpinner();
        console.error('Save TASTES error:', error);
        alert('‚ùå Errore:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function openRestaurantSearchModal() {
    if (restaurantModal) restaurantModal.classList.remove('active');
    if (restaurantSearchModal) restaurantSearchModal.classList.add('active');
}

async function performRestaurantSearch() {
    const city = document.getElementById('searchCity').value;
    const cuisine = document.getElementById('searchCuisine').value;

    if (!city && !cuisine) {
        alert('Inserisci almeno un filtro');
        return;
    }

    try {
        searchResultsList.innerHTML = '<p class="loading">Ricerca...</p>';

        let query = supabaseClient.from('blueriot_tastes').select('*');

        if (city) query = query.ilike('location', `%${city}%`);
        if (cuisine) query = query.ilike('cuisine', `%${cuisine}%`);

        const { data: restaurants, error } = await query.order('rating_avg', { ascending: false });

        if (error) throw error;

        if (!restaurants || restaurants.length === 0) {
            searchResultsList.innerHTML = '<p class="loading">Nessun risultato</p>';
            return;
        }

        searchResultsList.innerHTML = restaurants.map(r => `
            <div class="data-card">
                <h4>${r.name}</h4>
                <div class="meta">üìç ${r.location}</div>
                ${r.cuisine ? `<div class="meta">üçΩÔ∏è ${r.cuisine}</div>` : ''}
                <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="copyRestaurantToTour('${r.id}')">‚ûï Aggiungi al Tour</button>
            </div>
        `).join('');

    } catch (error) {
        console.error('Search error:', error);
        alert('‚ùå Errore ricerca:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function copyRestaurantToTour(restaurantId) {
    const restaurant = window.allSharedRestaurants?.find(r => r.id === restaurantId);
    if (!restaurant || !currentTourDetail) {
        alert('‚ùå Errore');
        return;
    }

    // Pre-populate form
    document.getElementById('restaurantDay').value = '';
    document.getElementById('restaurantName').value = restaurant.name;
    document.getElementById('restaurantCity').value = restaurant.location;
    document.getElementById('restaurantAddress').value = restaurant.address || '';
    document.getElementById('restaurantPhone').value = restaurant.phone || '';
    document.getElementById('restaurantNotes').value = restaurant.notes || '';

    // Close search modal
    if (restaurantSearchModal) restaurantSearchModal.classList.remove('active');
    // Open restaurant form
    if (restaurantModal) restaurantModal.classList.add('active');

    alert('‚úÖ Dati copiati! Seleziona il giorno e salva.');
}

function openRatingModal(restaurantId) {
    document.getElementById('ratingRestaurantId').value = restaurantId;
    document.getElementById('ratingValue').value = '';
    document.getElementById('ratingNotes').value = '';

    // Reset stars
    document.querySelectorAll('.star-rating').forEach(s => s.classList.remove('selected'));

    if (ratingModal) ratingModal.classList.add('active');
}

async function handleSubmitRating(e) {
    e.preventDefault();

    const restaurantId = document.getElementById('ratingRestaurantId').value;
    const rating = parseInt(document.getElementById('ratingValue').value);
    const notes = document.getElementById('ratingNotes').value;

    if (!rating || !currentTL) {
        alert('‚ùå Seleziona una valutazione');
        return;
    }

    try {
        // Insert rating
        const { error: ratingError } = await supabaseClient
            .from('restaurant_ratings')
            .upsert([{
                restaurant_id: restaurantId,
                tl_id: currentTL.id,
                rating: rating,
                notes: notes || null
            }], { onConflict: 'restaurant_id,tl_id' });

        if (ratingError) throw ratingError;

        // Recalculate average
        const { data: ratings } = await supabaseClient
            .from('restaurant_ratings')
            .select('rating')
            .eq('restaurant_id', restaurantId);

        const avg = ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length;

        await supabaseClient
            .from('blueriot_tastes')
            .update({
                rating_avg: avg,
                total_ratings: ratings.length
            })
            .eq('id', restaurantId);

        alert('‚úÖ Valutazione inviata!');

        if (ratingModal) ratingModal.classList.remove('active');
        loadSharedRestaurants();

    } catch (error) {
        console.error('Rating error:', error);
        alert('‚ùå Errore:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

// ===== ROUTES DATABASE FUNCTIONS (Placeholder) =====

async function loadRoutes() {
    const routesList = document.getElementById('routesList');
    if (!routesList) return;

    try {
        routesList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: routes, error } = await supabaseClient
            .from('blueriot_routes')
            .select('*')
            .order('area_served', { ascending: true });

        if (error) {
            // Table might not exist yet
            console.log('Routes table not created yet:', error);
            routesList.innerHTML = '<p class="loading">üöß Database ROUTES in costruzione. Funzionalit√† disponibile a breve!</p>';
            return;
        }

        if (!routes || routes.length === 0) {
            routesList.innerHTML = '<p class="loading">Nessun trasporto nel database. Aggiungi il primo!</p>';
        } else {
            // Display routes (to be implemented)
            routesList.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">` +
                routes.map(route => `
                    <div class="data-card">
                        <h4 style="margin: 0 0 8px 0;">${route.operator_name}</h4>
                        <div class="meta">üöå ${route.transport_type}</div>
                        <div class="meta">üìç ${route.area_served}</div>
                        ${route.price ? `<div class="meta">üí∞ ${route.price}</div>` : ''}
                    </div>
                `).join('') + '</div>';
        }
    } catch (error) {
        console.error('Load routes error:', error);
        routesList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
    }
}

// ===== STAY DATABASE FUNCTIONS (Placeholder) =====

async function loadStayOptions() {
    const stayList = document.getElementById('stayList');
    if (!stayList) return;

    try {
        stayList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: stays, error } = await supabaseClient
            .from('blueriot_stay')
            .select('*')
            .order('location', { ascending: true });

        if (error) {
            // Table might not exist yet
            console.log('Stay table not created yet:', error);
            stayList.innerHTML = '<p class="loading">üöß Database STAY in costruzione. Funzionalit√† disponibile a breve!</p>';
            return;
        }

        if (!stays || stays.length === 0) {
            stayList.innerHTML = '<p class="loading">Nessuna struttura nel database. Aggiungi la prima!</p>';
        } else {
            // Display stays (to be implemented)
            stayList.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">` +
                stays.map(stay => `
                    <div class="data-card">
                        <h4 style="margin: 0 0 8px 0;">${stay.name}</h4>
                        <div class="meta">üè® ${stay.type}</div>
                        <div class="meta">üìç ${stay.location}</div>
                        ${stay.price_range ? `<div class="meta">${stay.price_range}</div>` : ''}
                    </div>
                `).join('') + '</div>';
        }
    } catch (error) {
        console.error('Load stay error:', error);
        stayList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
    }
}

// ===== ROUTES CRUD FUNCTIONS =====

async function handleSaveRoute(e) {
    e.preventDefault();

    if (!currentTL || !currentTL.id) {
        alert('‚ùå Errore: TL non identificato');
        return;
    }

    const routeData = {
        // Transport type
        transport_type: document.getElementById('routeTransportType').value,
        train_category: document.getElementById('routeTrainCategory').value || null,

        // Operator
        operator_name: document.getElementById('routeOperatorName').value,

        // Route
        area_served: document.getElementById('routeAreaServed').value || null,
        start_point: document.getElementById('routeStartPoint').value || null,
        end_point: document.getElementById('routeEndPoint').value || null,

        // Timing
        frequency: document.getElementById('routeFrequency').value || null,
        duration: document.getElementById('routeDuration').value || null,
        price: document.getElementById('routePrice').value || null,
        ticket_info: document.getElementById('routeTicketInfo').value || null,

        // Reliability
        reliability: document.getElementById('routeReliability').value || null,
        reliability_notes: document.getElementById('routeReliabilityNotes').value || null,

        // Contacts
        contacts: document.getElementById('routeContacts').value || null,
        website: document.getElementById('routeWebsite').value || null,
        booking_url: document.getElementById('routeBookingUrl').value || null,
        maps_link: document.getElementById('routeMapsLink').value || null,

        // Additional
        notes: document.getElementById('routeNotes').value || null,
        tips: document.getElementById('routeTips').value || null,

        // System
        added_by: currentTL.id
    };

    try {
        const { error } = await supabaseClient
            .from('blueriot_routes')
            .insert([routeData]);

        if (error) throw error;

        alert('‚úÖ Trasporto aggiunto al database R0UT35!');

        const routesModal = document.getElementById('routesModal');
        const routesForm = document.getElementById('routesForm');

        if (routesModal) routesModal.classList.remove('active');
        if (routesForm) routesForm.reset();

        loadRoutes();

    } catch (error) {
        console.error('Save ROUTES error:', error);
        alert('‚ùå Errore:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

// ===== STAY CRUD FUNCTIONS =====

async function handleSaveStay(e) {
    e.preventDefault();

    if (!currentTL || !currentTL.id) {
        alert('‚ùå Errore: TL non identificato');
        return;
    }

    // Parse facilities from comma-separated string to array
    const facilitiesStr = document.getElementById('stayFacilities').value || '';
    const facilitiesArray = facilitiesStr ? facilitiesStr.split(',').map(f => f.trim()).filter(f => f) : null;

    const stayData = {
        // Basic info
        name: document.getElementById('stayName').value,
        type: document.getElementById('stayType').value,

        // Location
        location: document.getElementById('stayLocation').value,
        address: document.getElementById('stayAddress').value || null,
        google_maps_link: document.getElementById('stayGoogleMaps').value || null,
        distance_from_center: document.getElementById('stayDistanceCenter').value || null,

        // Pricing
        price_range: document.getElementById('stayPriceRange').value || null,

        // Contacts
        contact: document.getElementById('stayContact').value || null,
        phone: document.getElementById('stayPhone').value || null,
        website: document.getElementById('stayWebsite').value || null,
        booking_url: document.getElementById('stayBookingUrl').value || null,

        // Suitability
        suitable_for_families: document.getElementById('staySuitableFamilies').checked,
        suitable_for_groups: document.getElementById('staySuitableGroups').checked,
        max_guests: document.getElementById('stayMaxGuests').value ? parseInt(document.getElementById('stayMaxGuests').value) : null,

        // Facilities
        facilities: facilitiesStr || null,
        facilities_array: facilitiesArray,

        // TL benefits
        commission: document.getElementById('stayCommission').checked,
        commission_percentage: document.getElementById('stayCommissionPerc').value ? parseInt(document.getElementById('stayCommissionPerc').value) : null,
        special_tl_rate: document.getElementById('staySpecialRate').checked,
        special_rate_details: document.getElementById('staySpecialRateDetails').value || null,

        // Testing & notes
        tested_by: document.getElementById('stayTestedBy').value || null,
        tested_date: document.getElementById('stayTestedDate').value || null,
        recommended_for: document.getElementById('stayRecommendedFor').value || null,
        notes: document.getElementById('stayNotes').value || null,

        // System
        added_by: currentTL.id
    };

    try {
        const { error } = await supabaseClient
            .from('blueriot_stay')
            .insert([stayData]);

        if (error) throw error;

        alert('‚úÖ Struttura aggiunta al database SŒ§ŒîŒ•!');

        const stayModal = document.getElementById('stayModal');
        const stayForm = document.getElementById('stayForm');

        if (stayModal) stayModal.classList.remove('active');
        if (stayForm) stayForm.reset();

        loadStayOptions();

    } catch (error) {
        console.error('Save STAY error:', error);
        alert('‚ùå Errore:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

// ===== TICKET SYSTEM FUNCTIONS =====

let currentTemplate = null; // Stores template data
let currentTemplatePosition = { x: null, y: null };
let currentLogo = null; // Stores logo data

// Template Upload Handler
document.getElementById('ticketTemplateInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
        // Convert to base64
        const base64 = await fileToBase64(file);

        // Save template to memory
        currentTemplate = {
            file_url: base64,
            file_name: file.name,
            file_type: file.type
        };

        // Show preview
        const imgEl = document.getElementById('templateImage');
        imgEl.src = base64;
        document.getElementById('templatePreview').style.display = 'block';

        // Save to database
        await saveTemplateToDatabase();

        alert('‚úÖ Template caricato!');
    } catch (error) {
        console.error('Template upload error:', error);
        alert('‚ùå Errore caricamento template:\n' + error.message);
    }
});

// Remove Template
document.getElementById('removeTemplateBtn').addEventListener('click', () => {
    currentTemplate = null;
    currentTemplatePosition = { x: null, y: null };
    document.getElementById('templatePreview').style.display = 'none';
    document.getElementById('templateImage').src = '';
    document.getElementById('namePositionMarker').style.display = 'none';
});

// Logo Upload Handler
document.getElementById('logoInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
        const base64 = await fileToBase64(file);

        currentLogo = {
            file_url: base64,
            file_name: file.name
        };

        const logoImg = document.getElementById('logoImage');
        logoImg.src = base64;
        document.getElementById('logoPreview').style.display = 'block';

        await saveTemplateToDatabase(); // Update logo in DB

        alert('‚úÖ Logo caricato!');
    } catch (error) {
        console.error('Logo upload error:', error);
        alert('‚ùå Errore caricamento logo');
    }
});

// Remove Logo
document.getElementById('removeLogoBtn').addEventListener('click', () => {
    currentLogo = null;
    document.getElementById('logoPreview').style.display = 'none';
    document.getElementById('logoImage').src = '';
    saveTemplateToDatabase(); // Update DB to remove logo
});

// Name Position Selector
document.getElementById('setNamePositionBtn').addEventListener('click', () => {
    const img = document.getElementById('templateImage');

    img.classList.add('selecting');
    alert('üëÜ Clicca sull\'immagine dove vuoi posizionare il nome del passeggero');

    img.style.cursor = 'crosshair';
    img.onclick = async (e) => {
        const rect = img.getBoundingClientRect();
        const x = Math.round((e.clientX - rect.left) / rect.width * img.naturalWidth);
        const y = Math.round((e.clientY - rect.top) / rect.height * img.naturalHeight);

        currentTemplatePosition = { x, y };

        // Show marker
        const marker = document.getElementById('namePositionMarker');
        marker.style.left = (e.clientX - rect.left - 5) + 'px';
        marker.style.top = (e.clientY - rect.top - 5) + 'px';
        marker.style.display = 'block';

        img.style.cursor = 'default';
        img.classList.remove('selecting');
        img.onclick = null;

        // Save to DB
        await saveTemplateToDatabase();

        alert(`‚úÖ Posizione salvata!\n\nX: ${x}, Y: ${y}`);
    };
});

// Save template to database
async function saveTemplateToDatabase() {
    if (!currentEditingTour || !currentTemplate) return;

    const templateData = {
        tour_id: currentEditingTour.id,
        template_name: currentTemplate.file_name || 'ticket_template',
        template_file_url: currentTemplate.file_url,
        logo_url: currentLogo ? currentLogo.file_url : null,
        name_position_x: currentTemplatePosition.x,
        name_position_y: currentTemplatePosition.y,
        font_size: 24,
        font_color: '#000000'
    };

    try {
        const { error } = await supabaseClient
            .from('ticket_templates')
            .upsert(templateData, { onConflict: 'tour_id' });

        if (error) throw error;
        console.log('Template saved to database');
    } catch (error) {
        console.error('Save template error:', error);
    }
}

// Load template from database
async function loadTemplateFromDatabase() {
    if (!currentEditingTour) return;

    try {
        const { data, error } = await supabaseClient
            .from('ticket_templates')
            .select('*')
            .eq('tour_id', currentEditingTour.id)
            .single();

        if (error || !data) return;

        // Restore template
        currentTemplate = {
            file_url: data.template_file_url,
            file_name: data.template_name
        };

        const imgEl = document.getElementById('templateImage');
        imgEl.src = data.template_file_url;
        document.getElementById('templatePreview').style.display = 'block';

        // Restore position
        if (data.name_position_x && data.name_position_y) {
            currentTemplatePosition = {
                x: data.name_position_x,
                y: data.name_position_y
            };
            // Show marker at saved position
            const marker = document.getElementById('namePositionMarker');
            marker.style.display = 'block';
            marker.style.left = (data.name_position_x / imgEl.naturalWidth * imgEl.width - 5) + 'px';
            marker.style.top = (data.name_position_y / imgEl.naturalHeight * imgEl.height - 5) + 'px';
        }

        // Restore logo
        if (data.logo_url) {
            currentLogo = { file_url: data.logo_url };
            document.getElementById('logoImage').src = data.logo_url;
            document.getElementById('logoPreview').style.display = 'block';
        }
    } catch (error) {
        console.error('Load template error:', error);
    }
}

// Add Single Passenger
document.getElementById('addPassengerBtn').addEventListener('click', () => {
    const passengersList = document.getElementById('passengersList');

    // Remove "no passengers" message if present
    if (passengersList.querySelector('p')) {
        passengersList.innerHTML = '';
    }

    const row = document.createElement('div');
    row.className = 'passenger-row';
    row.innerHTML = `
        <input type="text" placeholder="Nome Completo *" class="passenger-name" required>
        <input type="email" placeholder="Email (opzionale)" class="passenger-email">
        <input type="tel" placeholder="Telefono (opzionale)" class="passenger-phone">
        <button class="btn btn-primary" onclick="savePassengerRow(this)">üíæ</button>
        <button class="btn btn-secondary" onclick="removePassengerRow(this)">‚ùå</button>
    `;

    passengersList.appendChild(row);
});

// Save Passenger Row
async function savePassengerRow(btn) {
    const row = btn.parentElement;
    const name = row.querySelector('.passenger-name').value.trim();
    const email = row.querySelector('.passenger-email').value.trim();
    const phone = row.querySelector('.passenger-phone').value.trim();

    if (!name) {
        alert('‚ùå Inserisci almeno il nome del passeggero');
        return;
    }

    if (!currentEditingTour) {
        alert('‚ùå Errore: Tour non identificato');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('tour_passengers')
            .insert({
                tour_id: currentEditingTour.id,
                full_name: name,
                email: email || null,
                phone: phone || null
            })
            .select()
            .single();

        if (error) throw error;

        // Make inputs readonly and change save button to edit
        row.querySelectorAll('input').forEach(input => input.readOnly = true);
        btn.textContent = '‚úèÔ∏è';
        btn.onclick = () => editPassengerRow(btn);

        alert('‚úÖ Passeggero salvato!');

        // Store passenger ID in row
        row.dataset.passengerId = data.id;
    } catch (error) {
        console.error('Save passenger error:', error);
        alert('‚ùå Errore salvataggio:\n' + error.message);
    }
}

// Edit Passenger Row
function editPassengerRow(btn) {
    const row = btn.parentElement;
    row.querySelectorAll('input').forEach(input => input.readOnly = false);
    btn.textContent = 'üíæ';
    btn.onclick = () => savePassengerRow(btn);
}

// Remove Passenger Row
async function removePassengerRow(btn) {
    const row = btn.parentElement;
    const passengerId = row.dataset.passengerId;

    if (passengerId) {
        if (!confirm('Sei sicuro di voler eliminare questo passeggero?')) return;

        try {
            const { error } = await supabaseClient
                .from('tour_passengers')
                .delete()
                .eq('id', passengerId);

            if (error) throw error;
        } catch (error) {
            console.error('Delete passenger error:', error);
            alert('‚ùå Errore eliminazione');
            return;
        }
    }

    row.remove();

    // Check if list is empty
    const passengersList = document.getElementById('passengersList');
    if (passengersList.children.length === 0) {
        passengersList.innerHTML = '<p style="color: var(--text-secondary);">Nessun passeggero ancora. Clicca "+ Aggiungi Passeggero" per iniziare.</p>';
    }
}

// Bulk Add Passengers - Open Modal
document.getElementById('bulkAddPassengersBtn').addEventListener('click', () => {
    const modal = document.getElementById('bulkPassengerModal');
    modal.classList.add('active');
});

// Close Bulk Modal
document.getElementById('closeBulkPassengerModal').addEventListener('click', () => {
    document.getElementById('bulkPassengerModal').classList.remove('active');
});

document.getElementById('cancelBulkPassenger').addEventListener('click', () => {
    document.getElementById('bulkPassengerModal').classList.remove('active');
});

// Save Bulk Passengers
document.getElementById('saveBulkPassengers').addEventListener('click', async () => {
    const textarea = document.getElementById('bulkPassengerInput');
    const lines = textarea.value.split('\n').filter(line => line.trim());

    if (lines.length === 0) {
        alert('‚ùå Nessun passeggero inserito');
        return;
    }

    if (!currentEditingTour) {
        alert('‚ùå Errore: Tour non identificato');
        return;
    }

    const passengers = [];

    lines.forEach(line => {
        const parts = line.split(',').map(p => p.trim());
        const name = parts[0];
        const email = parts[1] || null;
        const phone = parts[2] || null;

        if (name) {
            passengers.push({
                tour_id: currentEditingTour.id,
                full_name: name,
                email: email,
                phone: phone
            });
        }
    });

    try {
        const { data, error } = await supabaseClient
            .from('tour_passengers')
            .insert(passengers)
            .select();

        if (error) throw error;

        alert(`‚úÖ ${data.length} passeggeri aggiunti!`);

        // Close modal and reload passengers
        document.getElementById('bulkPassengerModal').classList.remove('active');
        textarea.value = '';

        loadPassengers();
    } catch (error) {
        console.error('Bulk add error:', error);
        alert('‚ùå Errore:\n' + error.message);
    }
});

// Load Passengers List
async function loadPassengers() {
    if (!currentEditingTour) return;

    try {
        const { data, error } = await supabaseClient
            .from('tour_passengers')
            .select('*')
            .eq('tour_id', currentEditingTour.id)
            .order('created_at', { ascending: true });

        if (error) throw error;

        const passengersList = document.getElementById('passengersList');
        passengersList.innerHTML = '';

        if (!data || data.length === 0) {
            passengersList.innerHTML = '<p style="color: var(--text-secondary);">Nessun passeggero ancora. Clicca "+ Aggiungi Passeggero" per iniziare.</p>';
            return;
        }

        data.forEach(passenger => {
            const row = document.createElement('div');
            row.className = 'passenger-row';
            row.dataset.passengerId = passenger.id;
            row.innerHTML = `
                <input type="text" value="${passenger.full_name}" class="passenger-name" readonly>
                <input type="email" value="${passenger.email || ''}" class="passenger-email" readonly>
                <input type="tel" value="${passenger.phone || ''}" class="passenger-phone" readonly>
                <button class="btn btn-secondary" onclick="editPassengerRow(this)">‚úèÔ∏è</button>
                <button class="btn btn-secondary" onclick="removePassengerRow(this)">‚ùå</button>
            `;
            passengersList.appendChild(row);
        });
    } catch (error) {
        console.error('Load passengers error:', error);
    }
}

// Generate Tickets for All Passengers
document.getElementById('generateTicketsBtn').addEventListener('click', async () => {
    if (!currentTemplate) {
        alert('‚ùå Carica prima un template biglietto!');
        return;
    }

    if (!currentTemplatePosition.x || !currentTemplatePosition.y) {
        alert('‚ùå Scegli prima la posizione del nome sul biglietto!');
        return;
    }

    if (!currentEditingTour) {
        alert('‚ùå Errore: Tour non identificato');
        return;
    }

    try {
        // Get all passengers
        const { data: passengers, error } = await supabaseClient
            .from('tour_passengers')
            .select('*')
            .eq('tour_id', currentEditingTour.id);

        if (error) throw error;

        if (!passengers || passengers.length === 0) {
            alert('‚ùå Aggiungi almeno un passeggero prima di generare i biglietti');
            return;
        }

        const confirmMsg = `Generare ${passengers.length} biglietti personalizzati?`;
        if (!confirm(confirmMsg)) return;

        alert(`‚è≥ Generazione di ${passengers.length} biglietti in corso...\n\nAttendi qualche secondo.`);

        // Generate tickets
        let successCount = 0;
        for (const passenger of passengers) {
            try {
                const ticketBlob = await generateSingleTicket(passenger);
                const ticketDataUrl = await blobToDataURL(ticketBlob);

                // Update passenger with ticket URL
                const { error: updateError } = await supabaseClient
                    .from('tour_passengers')
                    .update({
                        ticket_generated: true,
                        ticket_url: ticketDataUrl
                    })
                    .eq('id', passenger.id);

                if (updateError) throw updateError;
                successCount++;
            } catch (err) {
                console.error(`Error generating ticket for ${passenger.full_name}:`, err);
            }
        }

        alert(`‚úÖ ${successCount} biglietti generati con successo!`);
        loadGeneratedTickets();
    } catch (error) {
        console.error('Generate tickets error:', error);
        alert('‚ùå Errore generazione biglietti:\n' + error.message);
    }
});

// Generate Single Ticket
async function generateSingleTicket(passenger) {
    return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;

            // Draw template
            ctx.drawImage(img, 0, 0);

            // Draw logo if exists
            if (currentLogo) {
                const logo = new Image();
                logo.src = currentLogo.file_url;
                logo.onload = () => {
                    // Draw logo in top-left corner (50x50)
                    ctx.drawImage(logo, 30, 30, 80, 80);
                    drawNameAndFinish();
                };
                logo.onerror = () => {
                    console.warn('Logo load failed, continuing without logo');
                    drawNameAndFinish();
                };
            } else {
                drawNameAndFinish();
            }

            function drawNameAndFinish() {
                // Draw passenger name
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#000000';
                ctx.textAlign = 'center';
                ctx.fillText(
                    passenger.full_name,
                    currentTemplatePosition.x,
                    currentTemplatePosition.y
                );

                // Convert to blob
                canvas.toBlob((blob) => {
                    if (blob) {
                        resolve(blob);
                    } else {
                        reject(new Error('Canvas to blob failed'));
                    }
                }, 'image/png');
            }
        };

        img.onerror = () => reject(new Error('Template image load failed'));
        img.src = currentTemplate.file_url;
    });
}

// Convert Blob to Data URL
function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// Load Generated Tickets
async function loadGeneratedTickets() {
    if (!currentEditingTour) return;

    try {
        const { data: passengers, error } = await supabaseClient
            .from('tour_passengers')
            .select('*')
            .eq('tour_id', currentEditingTour.id)
            .eq('ticket_generated', true)
            .order('full_name', { ascending: true });

        if (error) throw error;

        const container = document.getElementById('generatedTicketsList');
        container.innerHTML = '';

        if (!passengers || passengers.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary);">I biglietti generati appariranno qui.</p>';
            return;
        }

        passengers.forEach(passenger => {
            const card = document.createElement('div');
            card.className = 'ticket-card';
            card.innerHTML = `
                <h4>${passenger.full_name}</h4>
                <img src="${passenger.ticket_url}" class="ticket-preview" alt="${passenger.full_name} ticket">
                <div class="ticket-actions">
                    <a href="${passenger.ticket_url}" download="${passenger.full_name.replace(/\s+/g, '_')}_ticket.png" class="btn btn-primary">
                        ‚¨áÔ∏è Scarica PNG
                    </a>
                    ${passenger.email ? `<button class="btn btn-secondary" onclick="sendTicketEmail('${passenger.id}')">üìß Invia Email</button>` : ''}
                </div>
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error('Load tickets error:', error);
    }
}

// Send Ticket via Email (placeholder for future)
function sendTicketEmail(passengerId) {
    alert('üìß Funzione email in arrivo!\n\nPer ora scarica il biglietto e invialo manualmente.');
}

// Helper: File to Base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Initialize ticket system when opening biglietti tab
function initTicketSystem() {
    loadTemplateFromDatabase();
    loadPassengers();
    loadGeneratedTickets();
}

// Hook into tab switching to initialize ticket system
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        if (tab === 'biglietti') {
            initTicketSystem();
        }
    });
});

// =====================================================
// PART 1: GLOBAL SPINNER & MODAL UTILITIES
// =====================================================

function showSaveSpinner(message = 'Salvataggio...') {
    let spinner = document.getElementById('globalSaveSpinner');
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'globalSaveSpinner';
        spinner.className = 'save-spinner';
        spinner.innerHTML = `
            <div class="spinner-ring"></div>
            <p id="spinnerMessage">${message}</p>
        `;
        document.body.appendChild(spinner);
    } else {
        document.getElementById('spinnerMessage').textContent = message;
        spinner.style.display = 'block';
    }
}

function hideSaveSpinner() {
    const spinner = document.getElementById('globalSaveSpinner');
    if (spinner) {
        spinner.style.display = 'none';
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.classList.add('modal-open');
        // Add to history for back button support
        if (history.state?.modal !== modalId) {
            history.pushState({ modal: modalId }, '', `#${modalId}`);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        document.body.classList.remove('modal-open');
    }
}

// Back button support for modals
window.addEventListener('popstate', (event) => {
    // Close all open modals when user goes back
    document.querySelectorAll('.modal.active').forEach(m => {
        m.classList.remove('active');
    });
    document.body.classList.remove('modal-open');
});

// =====================================================
// PART 2: COMPREHENSIVE CITY DATABASE (200+ cities)
// =====================================================

const CITY_DATABASE = {
    // ========== ITALY ==========

    // Veneto
    'venezia': { region: 'Veneto', country: 'Italia' },
    'venice': { region: 'Veneto', country: 'Italia' },
    'verona': { region: 'Veneto', country: 'Italia' },
    'padova': { region: 'Veneto', country: 'Italia' },
    'padua': { region: 'Veneto', country: 'Italia' },
    'vicenza': { region: 'Veneto', country: 'Italia' },
    'treviso': { region: 'Veneto', country: 'Italia' },
    'rovigo': { region: 'Veneto', country: 'Italia' },
    'belluno': { region: 'Veneto', country: 'Italia' },

    // Toscana
    'firenze': { region: 'Toscana', country: 'Italia' },
    'florence': { region: 'Toscana', country: 'Italia' },
    'pisa': { region: 'Toscana', country: 'Italia' },
    'siena': { region: 'Toscana', country: 'Italia' },
    'lucca': { region: 'Toscana', country: 'Italia' },
    'arezzo': { region: 'Toscana', country: 'Italia' },
    'grosseto': { region: 'Toscana', country: 'Italia' },
    'livorno': { region: 'Toscana', country: 'Italia' },
    'pistoia': { region: 'Toscana', country: 'Italia' },
    'prato': { region: 'Toscana', country: 'Italia' },
    'massa': { region: 'Toscana', country: 'Italia' },
    'carrara': { region: 'Toscana', country: 'Italia' },

    // Lazio
    'roma': { region: 'Lazio', country: 'Italia' },
    'rome': { region: 'Lazio', country: 'Italia' },
    'frosinone': { region: 'Lazio', country: 'Italia' },
    'latina': { region: 'Lazio', country: 'Italia' },
    'rieti': { region: 'Lazio', country: 'Italia' },
    'viterbo': { region: 'Lazio', country: 'Italia' },

    // Lombardia
    'milano': { region: 'Lombardia', country: 'Italia' },
    'milan': { region: 'Lombardia', country: 'Italia' },
    'bergamo': { region: 'Lombardia', country: 'Italia' },
    'brescia': { region: 'Lombardia', country: 'Italia' },
    'como': { region: 'Lombardia', country: 'Italia' },
    'cremona': { region: 'Lombardia', country: 'Italia' },
    'lecco': { region: 'Lombardia', country: 'Italia' },
    'lodi': { region: 'Lombardia', country: 'Italia' },
    'mantova': { region: 'Lombardia', country: 'Italia' },
    'mantua': { region: 'Lombardia', country: 'Italia' },
    'monza': { region: 'Lombardia', country: 'Italia' },
    'pavia': { region: 'Lombardia', country: 'Italia' },
    'sondrio': { region: 'Lombardia', country: 'Italia' },
    'varese': { region: 'Lombardia', country: 'Italia' },

    // Campania
    'napoli': { region: 'Campania', country: 'Italia' },
    'naples': { region: 'Campania', country: 'Italia' },
    'salerno': { region: 'Campania', country: 'Italia' },
    'avellino': { region: 'Campania', country: 'Italia' },
    'benevento': { region: 'Campania', country: 'Italia' },
    'caserta': { region: 'Campania', country: 'Italia' },
    'sorrento': { region: 'Campania', country: 'Italia' },
    'positano': { region: 'Campania', country: 'Italia' },
    'amalfi': { region: 'Campania', country: 'Italia' },
    'pompei': { region: 'Campania', country: 'Italia' },
    'pompeii': { region: 'Campania', country: 'Italia' },

    // Piemonte
    'torino': { region: 'Piemonte', country: 'Italia' },
    'turin': { region: 'Piemonte', country: 'Italia' },
    'alessandria': { region: 'Piemonte', country: 'Italia' },
    'asti': { region: 'Piemonte', country: 'Italia' },
    'biella': { region: 'Piemonte', country: 'Italia' },
    'cuneo': { region: 'Piemonte', country: 'Italia' },
    'novara': { region: 'Piemonte', country: 'Italia' },
    'verbania': { region: 'Piemonte', country: 'Italia' },
    'vercelli': { region: 'Piemonte', country: 'Italia' },

    // Liguria
    'genova': { region: 'Liguria', country: 'Italia' },
    'genoa': { region: 'Liguria', country: 'Italia' },
    'imperia': { region: 'Liguria', country: 'Italia' },
    'la spezia': { region: 'Liguria', country: 'Italia' },
    'savona': { region: 'Liguria', country: 'Italia' },
    'portofino': { region: 'Liguria', country: 'Italia' },
    'cinque terre': { region: 'Liguria', country: 'Italia' },

    // Emilia-Romagna
    'bologna': { region: 'Emilia-Romagna', country: 'Italia' },
    'ferrara': { region: 'Emilia-Romagna', country: 'Italia' },
    'forli': { region: 'Emilia-Romagna', country: 'Italia' },
    'modena': { region: 'Emilia-Romagna', country: 'Italia' },
    'parma': { region: 'Emilia-Romagna', country: 'Italia' },
    'piacenza': { region: 'Emilia-Romagna', country: 'Italia' },
    'ravenna': { region: 'Emilia-Romagna', country: 'Italia' },
    'reggio emilia': { region: 'Emilia-Romagna', country: 'Italia' },
    'rimini': { region: 'Emilia-Romagna', country: 'Italia' },

    // Sicilia
    'palermo': { region: 'Sicilia', country: 'Italia' },
    'catania': { region: 'Sicilia', country: 'Italia' },
    'messina': { region: 'Sicilia', country: 'Italia' },
    'siracusa': { region: 'Sicilia', country: 'Italia' },
    'syracuse': { region: 'Sicilia', country: 'Italia' },
    'agrigento': { region: 'Sicilia', country: 'Italia' },
    'caltanissetta': { region: 'Sicilia', country: 'Italia' },
    'enna': { region: 'Sicilia', country: 'Italia' },
    'ragusa': { region: 'Sicilia', country: 'Italia' },
    'trapani': { region: 'Sicilia', country: 'Italia' },
    'taormina': { region: 'Sicilia', country: 'Italia' },

    // Puglia
    'bari': { region: 'Puglia', country: 'Italia' },
    'brindisi': { region: 'Puglia', country: 'Italia' },
    'foggia': { region: 'Puglia', country: 'Italia' },
    'lecce': { region: 'Puglia', country: 'Italia' },
    'taranto': { region: 'Puglia', country: 'Italia' },

    // Sardegna
    'cagliari': { region: 'Sardegna', country: 'Italia' },
    'sassari': { region: 'Sardegna', country: 'Italia' },
    'nuoro': { region: 'Sardegna', country: 'Italia' },
    'oristano': { region: 'Sardegna', country: 'Italia' },
    'olbia': { region: 'Sardegna', country: 'Italia' },

    // Trentino-Alto Adige
    'trento': { region: 'Trentino-Alto Adige', country: 'Italia' },
    'bolzano': { region: 'Trentino-Alto Adige', country: 'Italia' },
    'bozen': { region: 'Trentino-Alto Adige', country: 'Italia' },
    'merano': { region: 'Trentino-Alto Adige', country: 'Italia' },

    // Friuli-Venezia Giulia
    'trieste': { region: 'Friuli-Venezia Giulia', country: 'Italia' },
    'udine': { region: 'Friuli-Venezia Giulia', country: 'Italia' },
    'gorizia': { region: 'Friuli-Venezia Giulia', country: 'Italia' },
    'pordenone': { region: 'Friuli-Venezia Giulia', country: 'Italia' },

    // Calabria
    'catanzaro': { region: 'Calabria', country: 'Italia' },
    'cosenza': { region: 'Calabria', country: 'Italia' },
    'crotone': { region: 'Calabria', country: 'Italia' },
    'reggio calabria': { region: 'Calabria', country: 'Italia' },
    'vibo valentia': { region: 'Calabria', country: 'Italia' },

    // Basilicata
    'potenza': { region: 'Basilicata', country: 'Italia' },
    'matera': { region: 'Basilicata', country: 'Italia' },

    // Molise
    'campobasso': { region: 'Molise', country: 'Italia' },
    'isernia': { region: 'Molise', country: 'Italia' },

    // Abruzzo
    "l'aquila": { region: 'Abruzzo', country: 'Italia' },
    'chieti': { region: 'Abruzzo', country: 'Italia' },
    'pescara': { region: 'Abruzzo', country: 'Italia' },
    'teramo': { region: 'Abruzzo', country: 'Italia' },

    // Marche
    'ancona': { region: 'Marche', country: 'Italia' },
    'ascoli piceno': { region: 'Marche', country: 'Italia' },
    'fermo': { region: 'Marche', country: 'Italia' },
    'macerata': { region: 'Marche', country: 'Italia' },
    'pesaro': { region: 'Marche', country: 'Italia' },
    'urbino': { region: 'Marche', country: 'Italia' },

    // Umbria
    'perugia': { region: 'Umbria', country: 'Italia' },
    'terni': { region: 'Umbria', country: 'Italia' },
    'assisi': { region: 'Umbria', country: 'Italia' },

    // Valle d'Aosta
    'aosta': { region: "Valle d'Aosta", country: 'Italia' },

    // ========== FRANCE ==========

    'paris': { region: '√éle-de-France', country: 'France' },
    'lyon': { region: 'Auvergne-Rh√¥ne-Alpes', country: 'France' },
    'marseille': { region: 'Provence-Alpes-C√¥te d\'Azur', country: 'France' },
    'nice': { region: 'Provence-Alpes-C√¥te d\'Azur', country: 'France' },
    'nizza': { region: 'Provence-Alpes-C√¥te d\'Azur', country: 'France' },
    'toulouse': { region: 'Occitanie', country: 'France' },
    'bordeaux': { region: 'Nouvelle-Aquitaine', country: 'France' },
    'nantes': { region: 'Pays de la Loire', country: 'France' },
    'strasbourg': { region: 'Grand Est', country: 'France' },
    'lille': { region: 'Hauts-de-France', country: 'France' },
    'rennes': { region: 'Bretagne', country: 'France' },
    'reims': { region: 'Grand Est', country: 'France' },
    'toulon': { region: 'Provence-Alpes-C√¥te d\'Azur', country: 'France' },
    'grenoble': { region: 'Auvergne-Rh√¥ne-Alpes', country: 'France' },
    'dijon': { region: 'Bourgogne-Franche-Comt√©', country: 'France' },
    'angers': { region: 'Pays de la Loire', country: 'France' },
    'nimes': { region: 'Occitanie', country: 'France' },
    'villeurbanne': { region: 'Auvergne-Rh√¥ne-Alpes', country: 'France' },
    'saint-etienne': { region: 'Auvergne-Rh√¥ne-Alpes', country: 'France' },
    'le havre': { region: 'Normandie', country: 'France' },
    'cannes': { region: 'Provence-Alpes-C√¥te d\'Azur', country: 'France' },
    'monaco': { region: 'Monaco', country: 'Monaco' },

    // ========== SPAIN ==========

    'madrid': { region: 'Community of Madrid', country: 'Spain' },
    'barcelona': { region: 'Catalonia', country: 'Spain' },
    'seville': { region: 'Andalusia', country: 'Spain' },
    'sevilla': { region: 'Andalusia', country: 'Spain' },
    'valencia': { region: 'Valencian Community', country: 'Spain' },
    'malaga': { region: 'Andalusia', country: 'Spain' },
    'murcia': { region: 'Region of Murcia', country: 'Spain' },
    'palma': { region: 'Balearic Islands', country: 'Spain' },
    'bilbao': { region: 'Basque Country', country: 'Spain' },
    'alicante': { region: 'Valencian Community', country: 'Spain' },
    'cordoba': { region: 'Andalusia', country: 'Spain' },
    'valladolid': { region: 'Castile and Le√≥n', country: 'Spain' },
    'vigo': { region: 'Galicia', country: 'Spain' },
    'gijon': { region: 'Asturias', country: 'Spain' },
    'granada': { region: 'Andalusia', country: 'Spain' },
    'toledo': { region: 'Castilla-La Mancha', country: 'Spain' },
    'san sebastian': { region: 'Basque Country', country: 'Spain' },
    'ibiza': { region: 'Balearic Islands', country: 'Spain' },

    // ========== GERMANY ==========

    'berlin': { region: 'Berlin', country: 'Germany' },
    'munich': { region: 'Bavaria', country: 'Germany' },
    'munchen': { region: 'Bavaria', country: 'Germany' },
    'hamburg': { region: 'Hamburg', country: 'Germany' },
    'cologne': { region: 'North Rhine-Westphalia', country: 'Germany' },
    'koln': { region: 'North Rhine-Westphalia', country: 'Germany' },
    'frankfurt': { region: 'Hesse', country: 'Germany' },
    'stuttgart': { region: 'Baden-W√ºrttemberg', country: 'Germany' },
    'dusseldorf': { region: 'North Rhine-Westphalia', country: 'Germany' },
    'dortmund': { region: 'North Rhine-Westphalia', country: 'Germany' },
    'essen': { region: 'North Rhine-Westphalia', country: 'Germany' },
    'leipzig': { region: 'Saxony', country: 'Germany' },
    'bremen': { region: 'Bremen', country: 'Germany' },
    'dresden': { region: 'Saxony', country: 'Germany' },
    'hanover': { region: 'Lower Saxony', country: 'Germany' },
    'nuremberg': { region: 'Bavaria', country: 'Germany' },
    'nurnberg': { region: 'Bavaria', country: 'Germany' },

    // ========== UK ==========

    'london': { region: 'England', country: 'United Kingdom' },
    'edinburgh': { region: 'Scotland', country: 'United Kingdom' },
    'manchester': { region: 'England', country: 'United Kingdom' },
    'birmingham': { region: 'England', country: 'United Kingdom' },
    'liverpool': { region: 'England', country: 'United Kingdom' },
    'glasgow': { region: 'Scotland', country: 'United Kingdom' },
    'bristol': { region: 'England', country: 'United Kingdom' },
    'cardiff': { region: 'Wales', country: 'United Kingdom' },
    'belfast': { region: 'Northern Ireland', country: 'United Kingdom' },
    'leeds': { region: 'England', country: 'United Kingdom' },
    'oxford': { region: 'England', country: 'United Kingdom' },
    'cambridge': { region: 'England', country: 'United Kingdom' },
    'bath': { region: 'England', country: 'United Kingdom' },

    // ========== PORTUGAL ==========

    'lisbon': { region: 'Lisbon', country: 'Portugal' },
    'lisboa': { region: 'Lisbon', country: 'Portugal' },
    'porto': { region: 'Norte', country: 'Portugal' },
    'faro': { region: 'Algarve', country: 'Portugal' },
    'braga': { region: 'Norte', country: 'Portugal' },
    'coimbra': { region: 'Centro', country: 'Portugal' },

    // ========== GREECE ==========

    'athens': { region: 'Attica', country: 'Greece' },
    'atene': { region: 'Attica', country: 'Greece' },
    'thessaloniki': { region: 'Central Macedonia', country: 'Greece' },
    'patras': { region: 'Western Greece', country: 'Greece' },
    'santorini': { region: 'South Aegean', country: 'Greece' },
    'mykonos': { region: 'South Aegean', country: 'Greece' },
    'rhodes': { region: 'South Aegean', country: 'Greece' },
    'crete': { region: 'Crete', country: 'Greece' },

    // ========== SWITZERLAND ==========

    'zurich': { region: 'Zurich', country: 'Switzerland' },
    'geneva': { region: 'Geneva', country: 'Switzerland' },
    'ginevra': { region: 'Geneva', country: 'Switzerland' },
    'basel': { region: 'Basel-Stadt', country: 'Switzerland' },
    'bern': { region: 'Bern', country: 'Switzerland' },
    'lausanne': { region: 'Vaud', country: 'Switzerland' },
    'lucerne': { region: 'Lucerne', country: 'Switzerland' },

    // ========== AUSTRIA ==========

    'vienna': { region: 'Vienna', country: 'Austria' },
    'wien': { region: 'Vienna', country: 'Austria' },
    'salzburg': { region: 'Salzburg', country: 'Austria' },
    'innsbruck': { region: 'Tyrol', country: 'Austria' },
    'graz': { region: 'Styria', country: 'Austria' },
    'linz': { region: 'Upper Austria', country: 'Austria' },

    // ========== NETHERLANDS ==========

    'amsterdam': { region: 'North Holland', country: 'Netherlands' },
    'rotterdam': { region: 'South Holland', country: 'Netherlands' },
    'the hague': { region: 'South Holland', country: 'Netherlands' },
    'utrecht': { region: 'Utrecht', country: 'Netherlands' },
    'eindhoven': { region: 'North Brabant', country: 'Netherlands' },
    'groningen': { region: 'Groningen', country: 'Netherlands' },

    // ========== BELGIUM ==========

    'brussels': { region: 'Brussels', country: 'Belgium' },
    'bruxelles': { region: 'Brussels', country: 'Belgium' },
    'antwerp': { region: 'Flemish Region', country: 'Belgium' },
    'ghent': { region: 'Flemish Region', country: 'Belgium' },
    'bruges': { region: 'Flemish Region', country: 'Belgium' },
    'liege': { region: 'Walloon Region', country: 'Belgium' },

    // ========== USA ==========

    'new york': { region: 'New York', country: 'USA' },
    'los angeles': { region: 'California', country: 'USA' },
    'chicago': { region: 'Illinois', country: 'USA' },
    'houston': { region: 'Texas', country: 'USA' },
    'phoenix': { region: 'Arizona', country: 'USA' },
    'philadelphia': { region: 'Pennsylvania', country: 'USA' },
    'san antonio': { region: 'Texas', country: 'USA' },
    'san diego': { region: 'California', country: 'USA' },
    'dallas': { region: 'Texas', country: 'USA' },
    'san jose': { region: 'California', country: 'USA' },
    'austin': { region: 'Texas', country: 'USA' },
    'san francisco': { region: 'California', country: 'USA' },
    'seattle': { region: 'Washington', country: 'USA' },
    'denver': { region: 'Colorado', country: 'USA' },
    'washington': { region: 'District of Columbia', country: 'USA' },
    'boston': { region: 'Massachusetts', country: 'USA' },
    'las vegas': { region: 'Nevada', country: 'USA' },
    'miami': { region: 'Florida', country: 'USA' },
    'orlando': { region: 'Florida', country: 'USA' },

    // ========== OTHER MAJOR TOURIST DESTINATIONS ==========

    // Turkey
    'istanbul': { region: 'Istanbul', country: 'Turkey' },
    'ankara': { region: 'Ankara', country: 'Turkey' },
    'antalya': { region: 'Antalya', country: 'Turkey' },

    // Egypt
    'cairo': { region: 'Cairo', country: 'Egypt' },
    'alexandria': { region: 'Alexandria', country: 'Egypt' },

    // Dubai
    'dubai': { region: 'Dubai', country: 'UAE' },
    'abu dhabi': { region: 'Abu Dhabi', country: 'UAE' },

    // Morocco
    'marrakech': { region: 'Marrakech-Safi', country: 'Morocco' },
    'casablanca': { region: 'Casablanca-Settat', country: 'Morocco' },

    // Croatia
    'zagreb': { region: 'Zagreb County', country: 'Croatia' },
    'split': { region: 'Split-Dalmatia County', country: 'Croatia' },
    'dubrovnik': { region: 'Dubrovnik-Neretva County', country: 'Croatia' },

    // Czech Republic
    'prague': { region: 'Prague', country: 'Czech Republic' },
    'praga': { region: 'Prague', country: 'Czech Republic' },

    // Poland
    'warsaw': { region: 'Masovian Voivodeship', country: 'Poland' },
    'krakow': { region: 'Lesser Poland Voivodeship', country: 'Poland' },
    'cracovia': { region: 'Lesser Poland Voivodeship', country: 'Poland' },

    // Hungary
    'budapest': { region: 'Budapest', country: 'Hungary' },

    // Romania
    'bucharest': { region: 'Bucharest', country: 'Romania' },

    // Ireland
    'dublin': { region: 'Leinster', country: 'Ireland' },
    'dublino': { region: 'Leinster', country: 'Ireland' },
    'cork': { region: 'Munster', country: 'Ireland' },

    // Denmark
    'copenhagen': { region: 'Capital Region', country: 'Denmark' },
    'copenaghen': { region: 'Capital Region', country: 'Denmark' },

    // Sweden
    'stockholm': { region: 'Stockholm County', country: 'Sweden' },
    'stoccolma': { region: 'Stockholm County', country: 'Sweden' },
    'gothenburg': { region: 'V√§stra G√∂taland County', country: 'Sweden' },

    // Norway
    'oslo': { region: 'Oslo', country: 'Norway' },
    'bergen': { region: 'Vestland', country: 'Norway' },

    // Finland
    'helsinki': { region: 'Uusimaa', country: 'Finland' },

    // Iceland
    'reykjavik': { region: 'Capital Region', country: 'Iceland' }
};

function setupCityAutofill(cityInputId, regionInputId, countryInputId) {
    const cityInput = document.getElementById(cityInputId);
    const regionInput = document.getElementById(regionInputId);
    const countryInput = document.getElementById(countryInputId);

    if (!cityInput) return;

    cityInput.addEventListener('input', (e) => {
        const city = e.target.value.toLowerCase().trim();
        const cityData = CITY_DATABASE[city];

        if (cityData && regionInput && countryInput) {
            regionInput.value = cityData.region;
            countryInput.value = cityData.country;

            // Visual feedback
            cityInput.classList.add('auto-filled');
            regionInput.classList.add('auto-filled');
            countryInput.classList.add('auto-filled');
        } else {
            if (regionInput) {
                regionInput.value = '';
                regionInput.classList.remove('auto-filled');
            }
            if (countryInput) {
                countryInput.value = '';
                countryInput.classList.remove('auto-filled');
            }
            cityInput.classList.remove('auto-filled');
        }
    });
}

// =====================================================
// PART 3: GESTURE SUPPORT (Swipe back)
// =====================================================

let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
}, {passive: true});

document.addEventListener('touchend', (e) => {
    const touchEndX = e.changedTouches[0].screenX;
    const touchEndY = e.changedTouches[0].screenY;
    const diffX = touchEndX - touchStartX;
    const diffY = touchEndY - touchStartY;

    // Swipe right (back gesture) - only if swiping from left edge
    if (diffX > 100 && Math.abs(diffY) < 50 && touchStartX < 50) {
        if (history.length > 1) {
            history.back();
        }
    }
}, {passive: true});

// =====================================================
// PART 4: NODE + TASTES INTEGRATION
// =====================================================

let allTastesRestaurants = [];

async function showTastesRestaurantPicker() {
    showSaveSpinner('Caricamento ristoranti TASTES...');

    try {
        const { data: tastesRestaurants, error } = await supabaseClient
            .from('blueriot_tastes')
            .select('*')
            .order('name', { ascending: true });

        if (error) throw error;

        allTastesRestaurants = tastesRestaurants || [];

        if (allTastesRestaurants.length === 0) {
            hideSaveSpinner();
            alert('üì≠ Il database TASTES √® ancora vuoto!\n\nAggiungi ristoranti nella sezione TASTES prima di usare questa funzione.');
            return;
        }

        populateTastesFilters();
        renderTastesRestaurants(allTastesRestaurants);
        openModal('tastesPickerModal');
        setupTastesFilters();
        hideSaveSpinner();
    } catch (error) {
        hideSaveSpinner();
        console.error('Load TASTES restaurants error:', error);
        alert('‚ùå Errore caricamento ristoranti TASTES');
    }
}

function populateTastesFilters() {
    const cities = [...new Set(allTastesRestaurants.map(r => r.city).filter(Boolean))].sort();
    const countries = [...new Set(allTastesRestaurants.map(r => r.country).filter(Boolean))].sort();

    const citySelect = document.getElementById('tastesFilterCity');
    const countrySelect = document.getElementById('tastesFilterCountry');

    if (citySelect) {
        const cityOptions = cities.map(city => '<option value="' + city + '">' + city + '</option>').join('');
        citySelect.innerHTML = '<option value="">Tutte le citt√†</option>' + cityOptions;
    }

    if (countrySelect) {
        const countryOptions = countries.map(country => '<option value="' + country + '">' + country + '</option>').join('');
        countrySelect.innerHTML = '<option value="">Tutti i paesi</option>' + countryOptions;
    }
}

function setupTastesFilters() {
    const searchInput = document.getElementById('tastesSearchInput');
    const cityFilter = document.getElementById('tastesFilterCity');
    const countryFilter = document.getElementById('tastesFilterCountry');
    const tlFreeFilter = document.getElementById('tastesFilterTLFree');
    const commissionFilter = document.getElementById('tastesFilterCommission');

    function applyFilters() {
        let filtered = [...allTastesRestaurants];

        // Search filter
        const searchTerm = searchInput?.value.toLowerCase().trim() || '';
        if (searchTerm) {
            filtered = filtered.filter(r =>
                r.name?.toLowerCase().includes(searchTerm) ||
                r.city?.toLowerCase().includes(searchTerm) ||
                r.address?.toLowerCase().includes(searchTerm)
            );
        }

        // City filter
        const selectedCity = cityFilter?.value || '';
        if (selectedCity) {
            filtered = filtered.filter(r => r.city === selectedCity);
        }

        // Country filter
        const selectedCountry = countryFilter?.value || '';
        if (selectedCountry) {
            filtered = filtered.filter(r => r.country === selectedCountry);
        }

        // TL Free filter
        if (tlFreeFilter?.checked) {
            filtered = filtered.filter(r => r.tl_free === true);
        }

        // Commission filter
        if (commissionFilter?.checked) {
            filtered = filtered.filter(r => r.commission && parseFloat(r.commission) > 0);
        }

        renderTastesRestaurants(filtered);
    }

    // Wire up event listeners
    searchInput?.addEventListener('input', applyFilters);
    cityFilter?.addEventListener('change', applyFilters);
    countryFilter?.addEventListener('change', applyFilters);
    tlFreeFilter?.addEventListener('change', applyFilters);
    commissionFilter?.addEventListener('change', applyFilters);
}

function renderTastesRestaurants(restaurants) {
    const container = document.getElementById('tastesRestaurantList');
    if (!container) return;

    if (restaurants.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Nessun ristorante trovato con questi filtri.</p>';
        return;
    }

    const cardsHtml = restaurants.map(restaurant => {
        const name = restaurant.name || 'Senza nome';
        const address = restaurant.address || 'N/A';
        const city = restaurant.city ? ', ' + restaurant.city : '';
        const countryHtml = restaurant.country ? '<p style="margin: 4px 0; color: #888; font-size: 14px;">üåç ' + restaurant.country + '</p>' : '';
        const tlFreeHtml = restaurant.tl_free ? '<span class="badge badge-success" style="margin-right: 8px;">TL FREE</span>' : '';
        const commissionHtml = (restaurant.commission && parseFloat(restaurant.commission) > 0) ? '<span class="badge badge-info">Commission: ' + restaurant.commission + '%</span>' : '';

        return '<div class="tastes-restaurant-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; background: var(--card-bg);">' +
            '<div style="display: flex; justify-content: space-between; align-items: start;">' +
                '<div style="flex: 1;">' +
                    '<h3 style="margin: 0 0 8px 0; color: var(--text-color);">' + name + '</h3>' +
                    '<p style="margin: 4px 0; color: #888; font-size: 14px;">üìç ' + address + city + '</p>' +
                    countryHtml +
                    tlFreeHtml +
                    commissionHtml +
                '</div>' +
                '<button class="btn btn-primary btn-sm" onclick="addTastesToTour(\'' + restaurant.id + '\')" style="white-space: nowrap;">‚ûï Aggiungi</button>' +
            '</div>' +
        '</div>';
    }).join('');

    container.innerHTML = cardsHtml;
}

async function addTastesToTour(tastesId) {
    if (!currentTourDetail || !currentTourDetail.id) {
        alert('‚ùå Errore: nessun tour selezionato');
        return;
    }

    const restaurant = allTastesRestaurants.find(r => r.id === tastesId);
    if (!restaurant) {
        alert('‚ùå Ristorante non trovato');
        return;
    }

    showSaveSpinner('Aggiunta ristorante al tour...');

    try {
        // Copy TASTES restaurant to tour_restaurants
        const newTourRestaurant = {
            tour_id: currentTourDetail.id,
            name: restaurant.name,
            address: restaurant.address,
            city: restaurant.city,
            region: restaurant.region,
            country: restaurant.country,
            phone: restaurant.phone,
            email: restaurant.email,
            website: restaurant.website,
            cuisine_type: restaurant.cuisine_type,
            price_range: restaurant.price_range,
            tl_free: restaurant.tl_free || false,
            commission: restaurant.commission,
            notes: restaurant.notes,
            plus_code: restaurant.plus_code,
            what3words: restaurant.what3words,
            google_maps_url: restaurant.google_maps_url
        };

        const { error } = await supabaseClient
            .from('tour_restaurants')
            .insert([newTourRestaurant]);

        if (error) throw error;

        hideSaveSpinner();
        alert(`‚úÖ ${restaurant.name} aggiunto al tour!`);

        // Refresh the tour restaurants list
        await loadTourRestaurants();

        closeTastesPicker();
    } catch (error) {
        hideSaveSpinner();
        console.error('Add TASTES to tour error:', error);
        alert('‚ùå Errore durante aggiunta ristorante');
    }
}

function closeTastesPicker() {
    closeModal('tastesPickerModal');

    // Reset filters
    const searchInput = document.getElementById('tastesSearchInput');
    const cityFilter = document.getElementById('tastesFilterCity');
    const countryFilter = document.getElementById('tastesFilterCountry');
    const tlFreeFilter = document.getElementById('tastesFilterTLFree');
    const commissionFilter = document.getElementById('tastesFilterCommission');

    if (searchInput) searchInput.value = '';
    if (cityFilter) cityFilter.value = '';
    if (countryFilter) countryFilter.value = '';
    if (tlFreeFilter) tlFreeFilter.checked = false;
    if (commissionFilter) commissionFilter.checked = false;
}

// =====================================================
// PART 5: PDF OCR ENGINE
// =====================================================

let extractedPdfData = null;

function openPdfUploadModal() {
    if (!currentTourDetail || !currentTourDetail.id) {
        alert('‚ùå Seleziona prima un tour!');
        return;
    }

    // Reset modal state
    document.getElementById('pdfFileInput').value = '';
    document.getElementById('pdfUploadProgress').style.display = 'none';
    document.getElementById('pdfExtractionResults').style.display = 'none';
    document.getElementById('pdfProgressBar').style.width = '0%';
    extractedPdfData = null;

    openModal('pdfUploadModal');
}

function closePdfUploadModal() {
    closeModal('pdfUploadModal');
    document.getElementById('pdfFileInput').value = '';
    extractedPdfData = null;
}

async function processPdfFile() {
    const fileInput = document.getElementById('pdfFileInput');
    const file = fileInput.files[0];

    if (!file) {
        alert('‚ùå Seleziona un file PDF!');
        return;
    }

    if (file.type !== 'application/pdf') {
        alert('‚ùå Il file deve essere un PDF!');
        return;
    }

    const progressDiv = document.getElementById('pdfUploadProgress');
    const progressBar = document.getElementById('pdfProgressBar');
    const progressText = document.getElementById('pdfProgressText');
    const resultsDiv = document.getElementById('pdfExtractionResults');

    progressDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    progressBar.style.width = '0%';
    progressText.textContent = 'Caricamento PDF...';

    try {
        // Read PDF file
        const arrayBuffer = await file.arrayBuffer();
        progressBar.style.width = '20%';
        progressText.textContent = 'Analisi PDF in corso...';

        // Load PDF with PDF.js
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        progressBar.style.width = '40%';
        progressText.textContent = `Estrazione testo (${pdf.numPages} pagine)...`;

        // Extract text from all pages
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n\n';

            // Update progress
            const progress = 40 + (i / pdf.numPages) * 40;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Estrazione pagina ${i}/${pdf.numPages}...`;
        }

        progressBar.style.width = '80%';
        progressText.textContent = 'Analisi contenuto...';

        // Parse extracted text
        extractedPdfData = parseTourItinerary(fullText);

        // Save raw OCR text to database
        await savePdfExtraction(file.name, fullText, extractedPdfData);

        progressBar.style.width = '100%';
        progressText.textContent = '‚úÖ Estrazione completata!';

        // Show results
        displayExtractionResults(extractedPdfData);
        resultsDiv.style.display = 'block';

    } catch (error) {
        console.error('PDF processing error:', error);
        progressDiv.style.display = 'none';
        alert('‚ùå Errore durante l\'elaborazione del PDF: ' + error.message);
    }
}

function parseTourItinerary(text) {
    const data = {
        days: [],
        hotels: [],
        restaurants: [],
        cities: []
    };

    // Patterns for extraction
    const dayPattern = /(?:giorno|day)\s*(\d+)[:\s]*([^\n]+)/gi;
    const hotelPattern = /(?:hotel|albergo)[:\s]*([^\n,]+)/gi;
    const restaurantPattern = /(?:ristorante|pranzo|cena|restaurant)[:\s]*([^\n,]+)/gi;
    const cityPattern = /(?:citt√†|city|localit√†)[:\s]*([^\n,]+)/gi;

    // Extract days
    let match;
    while ((match = dayPattern.exec(text)) !== null) {
        data.days.push({
            day_number: parseInt(match[1]),
            description: match[2].trim()
        });
    }

    // Extract hotels
    const hotelSet = new Set();
    while ((match = hotelPattern.exec(text)) !== null) {
        const hotelName = match[1].trim();
        if (hotelName.length > 3 && hotelName.length < 100) {
            hotelSet.add(hotelName);
        }
    }
    data.hotels = Array.from(hotelSet).map(name => ({ name }));

    // Extract restaurants
    const restaurantSet = new Set();
    while ((match = restaurantPattern.exec(text)) !== null) {
        const restaurantName = match[1].trim();
        if (restaurantName.length > 3 && restaurantName.length < 100) {
            restaurantSet.add(restaurantName);
        }
    }
    data.restaurants = Array.from(restaurantSet).map(name => ({ name }));

    // Extract cities (also check against CITY_DATABASE)
    const citySet = new Set();
    while ((match = cityPattern.exec(text)) !== null) {
        const cityName = match[1].trim();
        if (cityName.length > 2 && cityName.length < 50) {
            citySet.add(cityName);
        }
    }

    // Also scan for known cities in the database
    const textLower = text.toLowerCase();
    Object.keys(CITY_DATABASE).forEach(city => {
        if (textLower.includes(city)) {
            citySet.add(city.charAt(0).toUpperCase() + city.slice(1));
        }
    });

    data.cities = Array.from(citySet);

    return data;
}

async function savePdfExtraction(filename, rawText, extractedData) {
    if (!currentTourDetail || !currentTourDetail.id) {
        console.error('No current tour');
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_pdf_extractions')
            .upsert({
                tour_id: currentTourDetail.id,
                pdf_filename: filename,
                raw_ocr_text: rawText,
                extracted_data: extractedData,
                extraction_status: 'completed',
                extraction_date: new Date().toISOString()
            }, {
                onConflict: 'tour_id'
            });

        if (error) throw error;
        console.log('‚úÖ PDF extraction saved to database');
    } catch (error) {
        console.error('Error saving PDF extraction:', error);
    }
}

function displayExtractionResults(data) {
    const summaryDiv = document.getElementById('extractedDataSummary');

    // Build hotel list HTML
    let hotelListHtml = '';
    if (data.hotels.length > 0) {
        const hotelItems = data.hotels.slice(0, 5).map(h => '<li>' + h.name + '</li>').join('');
        const moreHotels = data.hotels.length > 5 ? '<li>...e altri ' + (data.hotels.length - 5) + '</li>' : '';
        hotelListHtml = '<ul class="extraction-results">' + hotelItems + moreHotels + '</ul>';
    }

    // Build restaurant list HTML
    let restaurantListHtml = '';
    if (data.restaurants.length > 0) {
        const restaurantItems = data.restaurants.slice(0, 5).map(r => '<li>' + r.name + '</li>').join('');
        const moreRestaurants = data.restaurants.length > 5 ? '<li>...e altri ' + (data.restaurants.length - 5) + '</li>' : '';
        restaurantListHtml = '<ul class="extraction-results">' + restaurantItems + moreRestaurants + '</ul>';
    }

    // Build cities HTML
    let citiesHtml = '';
    if (data.cities.length > 0) {
        const cityList = data.cities.slice(0, 10).join(', ');
        const moreCities = data.cities.length > 10 ? '...' : '';
        citiesHtml = '<p style="color: #888; margin-top: 8px;">' + cityList + moreCities + '</p>';
    }

    const html = '<div style="display: grid; gap: 16px;">' +
        '<div class="data-card">' +
            '<h4>üìÖ Giorni Trovati</h4>' +
            '<p style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">' + data.days.length + '</p>' +
        '</div>' +
        '<div class="data-card">' +
            '<h4>üè® Hotel Trovati</h4>' +
            '<p style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">' + data.hotels.length + '</p>' +
            hotelListHtml +
        '</div>' +
        '<div class="data-card">' +
            '<h4>üçΩ Ristoranti Trovati</h4>' +
            '<p style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">' + data.restaurants.length + '</p>' +
            restaurantListHtml +
        '</div>' +
        '<div class="data-card">' +
            '<h4>üìç Citt√† Trovate</h4>' +
            '<p style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">' + data.cities.length + '</p>' +
            citiesHtml +
        '</div>' +
    '</div>';

    summaryDiv.innerHTML = html;
}

async function applyExtractedData() {
    if (!extractedPdfData || !currentTourDetail) {
        alert('‚ùå Nessun dato da applicare');
        return;
    }

    showSaveSpinner('Applicazione dati estratti...');

    try {
        // Add hotels
        for (const hotel of extractedPdfData.hotels) {
            await supabaseClient
                .from('hotels')
                .insert({
                    tour_id: currentTourDetail.id,
                    name: hotel.name,
                    city: null,
                    region: null,
                    country: null
                });
        }

        // Add restaurants
        for (const restaurant of extractedPdfData.restaurants) {
            await supabaseClient
                .from('tour_restaurants')
                .insert({
                    tour_id: currentTourDetail.id,
                    name: restaurant.name,
                    city: null,
                    region: null,
                    country: null
                });
        }

        hideSaveSpinner();
        alert(`‚úÖ Dati applicati!\n\nüè® ${extractedPdfData.hotels.length} hotel aggiunti\nüçΩ ${extractedPdfData.restaurants.length} ristoranti aggiunti`);

        // Reload data
        await loadTourHotels();
        await loadTourRestaurants();

        closePdfUploadModal();
    } catch (error) {
        hideSaveSpinner();
        console.error('Error applying extracted data:', error);
        alert('‚ùå Errore durante l\'applicazione dei dati');
    }
}

    </script>
</body>
</html>
