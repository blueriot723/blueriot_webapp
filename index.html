<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueRiot Syndicate - TL Dashboard</title>
    <style>
/* ===== BLUERIOT CYBERPUNK THEME ===== */
:root {
    --primary-blue: #00F0FF;
    --secondary-blue: #0A7AFF;
    --dark-bg: #0A0E27;
    --card-bg: #13182E;
    --text-primary: #FFFFFF;
    --text-secondary: #8B9DC3;
    --error: #FF4757;
    --border-color: #1E2749;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #000000;
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

/* ===== SCREENS ===== */
.screen {
    display: none;
}

.screen.active {
    display: block;
}

/* ===== LOGIN ===== */
.login-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-header {
    text-align: center;
    margin-bottom: 40px;
}

.logo {
    width: 140px;
    height: auto;
    margin-bottom: 24px;
    filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.3));
}

.login-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 12px;
    text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
}

.login-header p {
    font-size: 15px;
    color: var(--text-secondary);
}

.login-form {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 14px 16px;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 15px;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
}

.form-group input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

.login-footer {
    margin-top: 24px;
    text-align: center;
}

.login-footer p {
    font-size: 14px;
    color: var(--text-secondary);
}

.login-footer a {
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
}

/* ===== BUTTONS ===== */
.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
    color: var(--dark-bg);
    width: 100%;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 240, 255, 0.4);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
}

/* ===== NAVBAR ===== */
.navbar {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.navbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-blue);
}

.navbar-logo {
    width: 40px;
    height: auto;
}

.navbar-menu {
    display: flex;
    align-items: center;
    gap: 20px;
}

.user-email {
    font-size: 14px;
    color: var(--text-secondary);
}

/* ===== DASHBOARD ===== */
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 24px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.dashboard-header h1 {
    font-size: 32px;
    font-weight: 700;
}

.dashboard-header .btn {
    width: auto;
}

/* ===== TOURS GRID ===== */
.tours-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
}

.tour-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
}

.tour-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 240, 255, 0.2);
}

.tour-code {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-blue);
    background: rgba(0, 240, 255, 0.1);
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 12px;
}

.tour-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 12px;
}

.tour-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    color: var(--text-secondary);
    font-size: 14px;
}

.loading {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px;
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 14, 39, 0.9);
    backdrop-filter: blur(8px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--dark-bg);
    color: var(--text-primary);
}

.modal-content form {
    padding: 24px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

.modal-actions .btn {
    flex: 1;
    width: auto;
}

/* ===== ERROR MESSAGE ===== */
.error-message {
    display: none;
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid var(--error);
    color: var(--error);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 16px;
}

.error-message.show {
    display: block;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .login-form {
        padding: 32px 24px;
    }

    .dashboard-container {
        padding: 24px 16px;
    }

    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .tours-grid {
        grid-template-columns: 1fr;
    }

    .navbar {
        flex-direction: column;
        gap: 16px;
    }

    .navbar-menu {
        width: 100%;
        justify-content: space-between;
    }
}
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-header">
                <img src="blueriot-logo.png" alt="BlueRiot Syndicate" class="logo">
                <h1>Tour Leader Dashboard</h1>
                <p>Accedi con le tue credenziali BlueRiot Syndicate</p>
            </div>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="tuo@email.com">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span class="btn-text">Accedi</span>
                </button>

                <div id="loginError" class="error-message"></div>
            </form>

            <div class="login-footer">
                <p>Problemi di accesso? Contatta <a href="https://t.me/blueriot">@blueriot</a></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>BlueRiot Syndicate</span>
            </div>
            <div class="navbar-menu">
                <span id="userEmail" class="user-email"></span>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>I Miei Tour</h1>
                <button id="newTourBtn" class="btn btn-primary">+ Nuovo Tour</button>
            </div>

            <div id="toursGrid" class="tours-grid">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- NEW TOUR MODAL -->
    <div id="newTourModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Tour</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>

            <form id="newTourForm">
                <div class="form-group">
                    <label for="tourCode">Codice Tour</label>
                    <input type="text" id="tourCode" required placeholder="es. ITALY001">
                </div>

                <div class="form-group">
                    <label for="tourName">Nome Tour</label>
                    <input type="text" id="tourName" required placeholder="es. Italia Classica">
                </div>

                <div class="form-group">
                    <label for="tourOperator">Operatore</label>
                    <select id="tourOperator" required>
                        <option value="">Seleziona operatore...</option>
                        <option value="Intrepid Travel">Intrepid Travel</option>
                        <option value="G Adventures">G Adventures</option>
                        <option value="OAT">OAT</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="startDate">Data Inizio</label>
                    <input type="date" id="startDate" required>
                </div>

                <div class="form-group">
                    <label for="endDate">Data Fine</label>
                    <input type="date" id="endDate" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelTour">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Tour</button>
                </div>

                <div id="tourError" class="error-message"></div>
            </form>
        </div>
    </div>

    <script type="module">
// ===== SUPABASE SETUP =====
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://kvomxtzcnczvbcscybcy.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2b214dHpjbmN6dmJjc2N5YmN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTIwOTMsImV4cCI6MjA3OTA2ODA5M30.2fd-urmPrcuWrDdZtR6lNaRsfyNQW64fwEvJv2KI9AE';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Global state
let currentUser = null;
let currentTL = null;

// DOM elements
let loginScreen, dashboardScreen, loginForm, loginError, loginBtn, logoutBtn, userEmail;
let toursGrid, newTourBtn, newTourModal, newTourForm, closeModal, cancelTour, tourError;

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', init);

function init() {
    console.log('üöÄ App loading...');

    // Initialize DOM elements
    loginScreen = document.getElementById('loginScreen');
    dashboardScreen = document.getElementById('dashboardScreen');
    loginForm = document.getElementById('loginForm');
    loginError = document.getElementById('loginError');
    loginBtn = document.getElementById('loginBtn');
    logoutBtn = document.getElementById('logoutBtn');
    userEmail = document.getElementById('userEmail');
    toursGrid = document.getElementById('toursGrid');
    newTourBtn = document.getElementById('newTourBtn');
    newTourModal = document.getElementById('newTourModal');
    newTourForm = document.getElementById('newTourForm');
    closeModal = document.getElementById('closeModal');
    cancelTour = document.getElementById('cancelTour');
    tourError = document.getElementById('tourError');

    // Check for missing elements
    if (!loginScreen || !dashboardScreen || !loginForm) {
        console.error('‚ùå Critical DOM elements missing!');
        alert('‚ùå ERRORE: Elementi pagina non trovati.');
        return;
    }

    console.log('‚úÖ DOM ready');

    // Set up event listeners
    setupEventListeners();

    // Check if user is already logged in
    checkAuth();
}

function setupEventListeners() {
    // Login
    loginForm.addEventListener('submit', handleLogin);

    // Logout
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            location.reload();
        });
    }

    // Tour modal
    if (newTourBtn) {
        newTourBtn.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.add('active');
            if (newTourForm) newTourForm.reset();
            hideTourError();
        });
    }

    if (closeModal) {
        closeModal.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.remove('active');
        });
    }

    if (cancelTour) {
        cancelTour.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.remove('active');
        });
    }

    if (newTourModal) {
        newTourModal.addEventListener('click', (e) => {
            if (e.target === newTourModal) {
                newTourModal.classList.remove('active');
            }
        });
    }

    if (newTourForm) {
        newTourForm.addEventListener('submit', handleCreateTour);
    }
}

async function checkAuth() {
    try {
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
            const { data: tlData, error: tlError } = await supabase
                .from('tl_users')
                .select('*')
                .eq('user_id', session.user.id)
                .single();

            if (tlError || !tlData) {
                console.error('TL profile not found:', tlError);
                showError('Profilo Tour Leader non trovato');
                await supabase.auth.signOut();
                return;
            }

            showDashboard(session.user, tlData);
        }
    } catch (error) {
        console.error('Auth check error:', error);
    }
}

async function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    console.log('üéØ Login attempt:', email);

    if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span class="btn-text">Caricamento...</span>';
    }
    hideError();

    // Show immediate feedback
    alert(`‚è≥ Tentativo login con:\n${email}\n\nPremi OK...`);

    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
        });

        if (error) {
            console.error('‚ùå Auth error:', error);
            throw new Error(`Auth: ${error.message}`);
        }

        console.log('‚úÖ Auth OK, user:', data.user?.id);

        const { data: tlData, error: tlError } = await supabase
            .from('tl_users')
            .select('*')
            .eq('user_id', data.user.id)
            .single();

        if (tlError) {
            console.error('‚ùå DB error:', tlError);
            throw new Error(`DB: ${tlError.message} (${tlError.code})`);
        }

        if (!tlData) {
            throw new Error('Profilo TL non trovato');
        }

        console.log('‚úÖ TL profile found');
        showDashboard(data.user, tlData);

    } catch (error) {
        console.error('üí• Login failed:', error);
        const errorMsg = error.message || 'Errore login';
        showError(errorMsg);

        setTimeout(() => {
            alert('‚ùå LOGIN FALLITO:\n\n' + errorMsg + '\n\nControlla Supabase!');
        }, 300);

        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<span class="btn-text">Accedi</span>';
        }
    }
}

function showDashboard(user, tlData) {
    if (!loginScreen || !dashboardScreen) {
        alert('Errore: impossibile mostrare dashboard');
        return;
    }

    currentUser = user;
    currentTL = tlData;

    loginScreen.classList.remove('active');
    dashboardScreen.classList.add('active');

    if (userEmail) {
        userEmail.textContent = user.email;
    }

    loadTours();
}

async function loadTours() {
    if (!currentTL || !currentTL.id) {
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore: Profilo TL non caricato</p>';
        }
        return;
    }

    try {
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading">Caricamento tour...</p>';
        }

        const { data: tours, error } = await supabase
            .from('tours')
            .select('*')
            .eq('tl_id', currentTL.id)
            .order('start_date', { ascending: false });

        if (error) {
            console.error('Error loading tours:', error);
            if (toursGrid) {
                toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore nel caricamento</p>';
            }
            return;
        }

        if (!tours || tours.length === 0) {
            if (toursGrid) {
                toursGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #8B9DC3;">
                        <h2 style="font-size: 24px; margin-bottom: 16px; color: #00F0FF;">Nessun tour ancora</h2>
                        <p style="font-size: 16px;">Clicca su "+ Nuovo Tour" per iniziare!</p>
                    </div>
                `;
            }
        } else {
            displayTours(tours);
        }
    } catch (error) {
        console.error('Load tours error:', error);
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore caricamento</p>';
        }
    }
}

function displayTours(tours) {
    if (!toursGrid) return;

    toursGrid.innerHTML = tours.map(tour => `
        <div class="tour-card">
            <span class="tour-code">${tour.code}</span>
            <h3 class="tour-name">${tour.name}</h3>
            <div class="tour-meta">
                <div>üìÖ ${formatDate(tour.start_date)} - ${formatDate(tour.end_date)}</div>
                <div>üè¢ ${tour.operator || 'N/A'}</div>
                <div>üìä ${tour.status === 'active' ? 'Attivo' : 'Archiviato'}</div>
            </div>
        </div>
    `).join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

async function handleCreateTour(e) {
    e.preventDefault();
    hideTourError();

    const tourData = {
        tl_id: currentTL.id,
        code: document.getElementById('tourCode').value.toUpperCase(),
        name: document.getElementById('tourName').value,
        operator: document.getElementById('tourOperator').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        status: 'active'
    };

    if (new Date(tourData.end_date) < new Date(tourData.start_date)) {
        showTourError('La data di fine deve essere dopo la data di inizio');
        return;
    }

    try {
        const { error } = await supabase
            .from('tours')
            .insert([tourData]);

        if (error) throw error;

        if (newTourModal) newTourModal.classList.remove('active');
        if (newTourForm) newTourForm.reset();
        loadTours();

    } catch (error) {
        console.error('Create tour error:', error);

        if (error.code === '23505') {
            showTourError('Codice tour gi√† esistente');
        } else {
            showTourError(error.message || 'Errore creazione tour');
        }
    }
}

function showError(message) {
    if (loginError) {
        loginError.textContent = message;
        loginError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideError() {
    if (loginError) {
        loginError.classList.remove('show');
    }
}

function showTourError(message) {
    if (tourError) {
        tourError.textContent = message;
        tourError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideTourError() {
    if (tourError) {
        tourError.classList.remove('show');
    }
}
    </script>
</body>
</html>
