<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueRiot Syndicate - TL Dashboard</title>
    <style>
/* ===== BLUERIOT CYBERPUNK THEME ===== */
:root {
    --primary-blue: #00F0FF;
    --secondary-blue: #0A7AFF;
    --dark-bg: #0A0E27;
    --card-bg: #13182E;
    --text-primary: #FFFFFF;
    --text-secondary: #8B9DC3;
    --error: #FF4757;
    --border-color: #1E2749;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #000000;
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

/* ===== SCREENS ===== */
.screen {
    display: none;
}

.screen.active {
    display: block;
}

/* ===== LOGIN ===== */
.login-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.login-header {
    text-align: center;
    margin-bottom: 40px;
}

.logo {
    width: 140px;
    height: auto;
    margin-bottom: 24px;
    filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.3));
}

.login-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 12px;
    text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
}

.login-header p {
    font-size: 15px;
    color: var(--text-secondary);
}

.login-form {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 14px 16px;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 15px;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
}

.form-group input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

.login-footer {
    margin-top: 24px;
    text-align: center;
}

.login-footer p {
    font-size: 14px;
    color: var(--text-secondary);
}

.login-footer a {
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
}

/* ===== BUTTONS ===== */
.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
    color: var(--dark-bg);
    width: 100%;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 240, 255, 0.4);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: var(--card-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
}

/* ===== NAVBAR ===== */
.navbar {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.navbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-blue);
}

.navbar-logo {
    width: 40px;
    height: auto;
}

.navbar-menu {
    display: flex;
    align-items: center;
    gap: 20px;
}

.user-email {
    font-size: 14px;
    color: var(--text-secondary);
}

/* ===== DASHBOARD ===== */
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 24px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.dashboard-header h1 {
    font-size: 32px;
    font-weight: 700;
}

.dashboard-header .btn {
    width: auto;
}

/* ===== TOURS GRID ===== */
.tours-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
}

.tour-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.tour-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 240, 255, 0.2);
}

.tour-code {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-blue);
    background: rgba(0, 240, 255, 0.1);
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 12px;
}

.tour-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 12px;
}

.tour-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    color: var(--text-secondary);
    font-size: 14px;
}

.loading {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px;
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 14, 39, 0.9);
    backdrop-filter: blur(8px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--dark-bg);
    color: var(--text-primary);
}

.modal-content form {
    padding: 24px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

.modal-actions .btn {
    flex: 1;
    width: auto;
}

/* ===== ERROR MESSAGE ===== */
.error-message {
    display: none;
    background: rgba(255, 71, 87, 0.1);
    border: 1px solid var(--error);
    color: var(--error);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 16px;
}

.error-message.show {
    display: block;
}

/* ===== TABS ===== */
.tabs {
    display: flex;
    gap: 8px;
    border-bottom: 1px solid var(--border-color);
    padding: 0 24px;
    overflow-x: auto;
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
    white-space: nowrap;
    font-size: 14px;
}

.tab-btn.active {
    color: var(--primary-blue);
    border-bottom-color: var(--primary-blue);
}

.tab-btn:hover {
    color: var(--text-primary);
}

.tab-content {
    padding: 24px;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

/* ===== CARDS FOR DATA ===== */
.data-card {
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
}

.data-card:hover {
    border-color: var(--primary-blue);
}

.data-card h4 {
    color: var(--primary-blue);
    margin-bottom: 8px;
}

.data-card .meta {
    color: var(--text-secondary);
    font-size: 13px;
    margin-bottom: 8px;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-right: 4px;
}

.badge-green {
    background: rgba(0, 255, 136, 0.1);
    color: #00FF88;
    border: 1px solid #00FF88;
}

.badge-blue {
    background: rgba(0, 240, 255, 0.1);
    color: var(--primary-blue);
    border: 1px solid var(--primary-blue);
}

.badge-yellow {
    background: rgba(255, 200, 0, 0.1);
    color: #FFC800;
    border: 1px solid #FFC800;
}

/* ===== WIDE MODAL ===== */
.modal-content.wide {
    max-width: 1000px;
}

/* ===== RATING STARS ===== */
.star-rating {
    cursor: pointer;
    opacity: 0.3;
    transition: opacity 0.2s;
}

.star-rating:hover,
.star-rating.selected {
    opacity: 1;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .login-form {
        padding: 32px 24px;
    }

    .dashboard-container {
        padding: 24px 16px;
    }

    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .tours-grid {
        grid-template-columns: 1fr;
    }

    .navbar {
        flex-direction: column;
        gap: 16px;
    }

    .navbar-menu {
        width: 100%;
        justify-content: space-between;
    }

    .tabs {
        padding: 0 12px;
    }

    .modal-content.wide {
        max-width: 100%;
    }
}
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-header">
                <img src="blueriot-logo.png" alt="BlueRiot Syndicate" class="logo">
                <h1>Tour Leader Dashboard</h1>
                <p>Accedi con le tue credenziali BlueRiot Syndicate</p>
            </div>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="tuo@email.com">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span class="btn-text">Accedi</span>
                </button>

                <div id="loginError" class="error-message"></div>
            </form>

            <div class="login-footer">
                <p>Problemi di accesso? Contatta <a href="https://t.me/blueriot">@blueriot</a></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>BlueRiot Syndicate</span>
            </div>
            <div class="navbar-menu">
                <button id="myToursBtn" class="btn btn-secondary">I Miei Tour</button>
                <button id="restaurantDbBtn" class="btn btn-secondary">üçΩÔ∏è Database Ristoranti</button>
                <span id="userEmail" class="user-email"></span>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>I Miei Tour</h1>
                <button id="newTourBtn" class="btn btn-primary">+ Nuovo Tour</button>
            </div>

            <div id="toursGrid" class="tours-grid">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- RESTAURANT DATABASE SCREEN -->
    <div id="restaurantDatabaseScreen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="blueriot-logo.png" alt="BlueRiot" class="navbar-logo">
                <span>BlueRiot Syndicate</span>
            </div>
            <div class="navbar-menu">
                <button id="myToursBtn2" class="btn btn-secondary">I Miei Tour</button>
                <button id="restaurantDbBtn2" class="btn btn-secondary">üçΩÔ∏è Database Ristoranti</button>
                <span id="userEmail2" class="user-email"></span>
                <button id="logoutBtn2" class="btn btn-secondary">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>üçΩÔ∏è Database Ristoranti Condiviso</h1>
                <button id="addSharedRestaurantBtn" class="btn btn-primary">+ Aggiungi Ristorante</button>
            </div>

            <!-- FILTERS -->
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">Filtri</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group" style="margin: 0;">
                        <label for="filterCity">Citt√†</label>
                        <input type="text" id="filterCity" placeholder="es. Roma">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="filterCuisine">Tipo Cucina</label>
                        <input type="text" id="filterCuisine" placeholder="es. Italiana">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="filterAdvantages">Vantaggi</label>
                        <select id="filterAdvantages">
                            <option value="">Tutti</option>
                            <option value="tl_free">TL Free</option>
                            <option value="commission">Commission</option>
                            <option value="discount">Discount</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button id="applyFiltersBtn" class="btn btn-primary" style="width: 100%;">üîç Cerca</button>
                    </div>
                </div>
            </div>

            <!-- SHARED RESTAURANTS LIST -->
            <div id="sharedRestaurantsList">
                <p class="loading">Caricamento...</p>
            </div>
        </div>
    </div>

    <!-- NEW TOUR MODAL -->
    <div id="newTourModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Tour</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>

            <form id="newTourForm">
                <div class="form-group">
                    <label for="tourCode">Codice Tour</label>
                    <input type="text" id="tourCode" required placeholder="es. ITALY001">
                </div>

                <div class="form-group">
                    <label for="tourName">Nome Tour</label>
                    <input type="text" id="tourName" required placeholder="es. Italia Classica">
                </div>

                <div class="form-group">
                    <label for="tourOperator">Operatore</label>
                    <select id="tourOperator" required>
                        <option value="">Seleziona operatore...</option>
                        <option value="Intrepid Travel">Intrepid Travel</option>
                        <option value="G Adventures">G Adventures</option>
                        <option value="OAT">OAT</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="startDate">Data Inizio</label>
                    <input type="date" id="startDate" required>
                </div>

                <div class="form-group">
                    <label for="endDate">Data Fine</label>
                    <input type="date" id="endDate" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelTour">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Tour</button>
                </div>

                <div id="tourError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- TOUR DETAIL MODAL WITH 8 TABS -->
    <div id="tourDetailModal" class="modal">
        <div class="modal-content wide">
            <div class="modal-header">
                <div>
                    <h2 id="modalTourName">Tour</h2>
                    <span id="modalTourCode" class="tour-code" style="margin-left: 12px;"></span>
                </div>
                <button class="modal-close" id="closeTourDetail">&times;</button>
            </div>

            <!-- TABS NAVIGATION -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="ristoranti">üçΩÔ∏è Ristoranti</button>
                <button class="tab-btn" data-tab="hotel">üè® Hotel</button>
                <button class="tab-btn" data-tab="programma">üìÖ Programma</button>
                <button class="tab-btn" data-tab="emergenze">üö® Emergenze</button>
                <button class="tab-btn" data-tab="file">üìÑ File</button>
                <button class="tab-btn" data-tab="link">üîó Link</button>
                <button class="tab-btn" data-tab="templates">üìã Templates</button>
            </div>

            <!-- TAB CONTENTS -->
            <div class="tab-content">
                <!-- DASHBOARD TAB -->
                <div id="tabDashboard" class="tab-pane active">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="data-card">
                            <h4>üìä Feedback Ricevuti</h4>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 20px; width: 40px;" onclick="decrementFeedback()">‚àí</button>
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary-blue);" id="feedbackCount">0</div>
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 20px; width: 40px;" onclick="incrementFeedback()">+</button>
                            </div>
                            <div class="meta">di <span id="totalPassengers">0</span> passeggeri</div>
                        </div>
                        <div class="data-card">
                            <h4>üìà Percentuale</h4>
                            <div style="font-size: 32px; font-weight: 700; color: #00FF88;" id="feedbackPercentage">0%</div>
                            <div class="meta">feedback ricevuti</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="totalPassengersInput">Totale Passeggeri</label>
                        <input type="number" id="totalPassengersInput" min="1" placeholder="Inserisci numero passeggeri">
                        <button class="btn btn-primary" style="margin-top: 8px; width: 100%;" onclick="saveDashboardData()">üíæ Salva Dati</button>
                    </div>

                    <div style="margin: 24px 0; padding: 24px; background: var(--dark-bg); border-radius: 8px;">
                        <canvas id="feedbackChart" style="max-height: 200px;"></canvas>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="editTourInfoBtn">‚úèÔ∏è Modifica Info Tour</button>
                        <button type="button" class="btn btn-secondary" id="uploadPdfBtn">üìÑ Carica PDF</button>
                        <button type="button" class="btn btn-secondary" id="publishSiteBtn">üåê Pubblica Mini-Site</button>
                        <button type="button" class="btn btn-secondary" style="background: var(--error); border-color: var(--error);" id="deleteTourBtn">üóëÔ∏è Cancella Tour</button>
                    </div>
                </div>

                <!-- RISTORANTI TAB -->
                <div id="tabRistoranti" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Ristoranti del Tour</h3>
                        <button class="btn btn-primary" id="addRestaurantBtn">+ Aggiungi</button>
                    </div>
                    <div id="restaurantsList">
                        <p class="loading">Nessun ristorante ancora</p>
                    </div>
                </div>

                <!-- HOTEL TAB -->
                <div id="tabHotel" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Hotel del Tour</h3>
                        <button class="btn btn-primary" id="addHotelBtn">+ Aggiungi</button>
                    </div>
                    <div id="hotelsList">
                        <p class="loading">Nessun hotel ancora</p>
                    </div>
                </div>

                <!-- PROGRAMMA TAB -->
                <div id="tabProgramma" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Programma Giornaliero</h3>
                        <button class="btn btn-secondary" id="generateDaysBtn">üîÑ Genera Giorni</button>
                    </div>
                    <div id="daysList">
                        <p class="loading">Clicca "Genera Giorni" per creare il programma</p>
                    </div>
                </div>

                <!-- EMERGENZE TAB -->
                <div id="tabEmergenze" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Contatti di Emergenza</h3>
                        <button class="btn btn-primary" id="addEmergencyBtn">+ Aggiungi</button>
                    </div>
                    <div id="emergencyList">
                        <p class="loading">Nessun contatto ancora</p>
                    </div>
                </div>

                <!-- FILE TAB -->
                <div id="tabFile" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Documenti del Tour</h3>
                        <button class="btn btn-primary" id="addFileBtn">+ Aggiungi</button>
                    </div>
                    <div id="filesList">
                        <p class="loading">Nessun file ancora</p>
                    </div>
                </div>

                <!-- LINK TAB -->
                <div id="tabLink" class="tab-pane">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Link Utili</h3>
                        <button class="btn btn-primary" id="addLinkBtn">+ Aggiungi</button>
                    </div>
                    <div id="linksList">
                        <p class="loading">Nessun link ancora</p>
                    </div>
                </div>

                <!-- TEMPLATES TAB -->
                <div id="tabTemplates" class="tab-pane">
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px;">üíæ Salva come Template</h3>
                        <div class="form-group">
                            <label for="templateName">Nome Template</label>
                            <input type="text" id="templateName" placeholder="es. Tour Italia Classica">
                        </div>
                        <button class="btn btn-primary" id="saveTemplateBtn">üíæ Salva Template</button>
                    </div>

                    <hr style="border: 1px solid var(--border-color); margin: 24px 0;">

                    <div>
                        <h3 style="margin-bottom: 16px;">üìã Carica da Template</h3>
                        <div id="templatesList">
                            <p class="loading">Nessun template disponibile</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESTAURANT FORM MODAL -->
    <div id="restaurantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="restaurantModalTitle">Aggiungi Ristorante</h2>
                <button class="modal-close" id="closeRestaurantModal">&times;</button>
            </div>

            <div style="padding: 16px 24px 0; border-bottom: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" id="searchDatabaseBtn" style="width: 100%; margin-bottom: 16px;">üîç Cerca nel Database Condiviso</button>
            </div>

            <form id="restaurantForm">
                <div class="form-group">
                    <label for="restaurantDay">Giorno Tour *</label>
                    <input type="number" id="restaurantDay" required min="1" max="30" placeholder="es. 3">
                </div>

                <div class="form-group">
                    <label for="restaurantName">Nome Ristorante *</label>
                    <input type="text" id="restaurantName" required placeholder="es. Trattoria da Mario">
                </div>

                <div class="form-group">
                    <label for="restaurantCity">Citt√† *</label>
                    <input type="text" id="restaurantCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="restaurantAddress">Indirizzo</label>
                    <input type="text" id="restaurantAddress" placeholder="es. Via Roma 123">
                </div>

                <div class="form-group">
                    <label for="restaurantPhone">Telefono</label>
                    <input type="tel" id="restaurantPhone" placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label>Vantaggi</label>
                    <div style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="advTlFree">
                            <span>üéÅ TL Free - Descrizione:</span>
                        </label>
                        <input type="text" id="advTlFreeDesc" placeholder="es. Pranzo gratuito per il TL" style="margin-left: 24px; margin-bottom: 12px;">

                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="advCommission">
                            <span>üí∞ Commission - Descrizione:</span>
                        </label>
                        <input type="text" id="advCommissionDesc" placeholder="es. 10% commissione sul gruppo" style="margin-left: 24px; margin-bottom: 12px;">

                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="advDiscount">
                            <span>üè∑Ô∏è Discount - Descrizione:</span>
                        </label>
                        <input type="text" id="advDiscountDesc" placeholder="es. 15% sconto sul conto" style="margin-left: 24px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="restaurantNotes">Note</label>
                    <input type="text" id="restaurantNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRestaurant">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="restaurantError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- SHARED RESTAURANT FORM MODAL -->
    <div id="sharedRestaurantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Aggiungi al Database Condiviso</h2>
                <button class="modal-close" id="closeSharedRestaurantModal">&times;</button>
            </div>

            <form id="sharedRestaurantForm">
                <div class="form-group">
                    <label for="sharedRestaurantName">Nome Ristorante *</label>
                    <input type="text" id="sharedRestaurantName" required placeholder="es. Trattoria da Mario">
                </div>

                <div class="form-group">
                    <label for="sharedRestaurantCity">Citt√† *</label>
                    <input type="text" id="sharedRestaurantCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="sharedRestaurantAddress">Indirizzo</label>
                    <input type="text" id="sharedRestaurantAddress" placeholder="es. Via Roma 123">
                </div>

                <div class="form-group">
                    <label for="sharedRestaurantPhone">Telefono</label>
                    <input type="tel" id="sharedRestaurantPhone" placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label for="sharedCuisineType">Tipo Cucina</label>
                    <input type="text" id="sharedCuisineType" placeholder="es. Italiana, Pizzeria, Trattoria">
                </div>

                <div class="form-group">
                    <label for="sharedPriceRange">Fascia Prezzo</label>
                    <select id="sharedPriceRange">
                        <option value="">Seleziona...</option>
                        <option value="‚Ç¨">‚Ç¨ - Economico</option>
                        <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ - Medio</option>
                        <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ - Alto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Vantaggi TL</label>
                    <div style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="sharedTlFree">
                            <span>üéÅ TL Free</span>
                        </label>

                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="sharedHasCommission">
                            <span>üí∞ Commission</span>
                        </label>
                        <input type="number" id="sharedCommissionPerc" min="0" max="100" placeholder="% commissione" style="margin-left: 24px; margin-bottom: 12px; width: calc(100% - 24px);">

                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="sharedHasDiscount">
                            <span>üè∑Ô∏è Discount</span>
                        </label>
                        <input type="number" id="sharedDiscountPerc" min="0" max="100" placeholder="% sconto" style="margin-left: 24px; width: calc(100% - 24px);">
                    </div>
                </div>

                <div class="form-group">
                    <label for="sharedNotes">Note</label>
                    <textarea id="sharedNotes" rows="3" placeholder="Note utili per altri TL..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelSharedRestaurant">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Aggiungi al Database</button>
                </div>

                <div id="sharedRestaurantError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- RESTAURANT SEARCH MODAL -->
    <div id="restaurantSearchModal" class="modal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h2>üîç Cerca Ristorante nel Database</h2>
                <button class="modal-close" id="closeRestaurantSearchModal">&times;</button>
            </div>

            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="searchCity" placeholder="Citt√†..." style="width: 100%; padding: 12px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                    <input type="text" id="searchCuisine" placeholder="Tipo cucina..." style="width: 100%; padding: 12px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                    <button class="btn btn-primary" id="searchRestaurantsBtn">üîç Cerca</button>
                </div>

                <div id="searchResultsList" style="max-height: 400px; overflow-y: auto;">
                    <p class="loading">Usa i filtri per cercare</p>
                </div>
            </div>
        </div>
    </div>

    <!-- RATING MODAL -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Valuta Ristorante</h2>
                <button class="modal-close" id="closeRatingModal">&times;</button>
            </div>

            <form id="ratingForm" style="padding: 24px;">
                <div class="form-group">
                    <label>Valutazione *</label>
                    <div style="display: flex; gap: 8px; font-size: 32px; margin-top: 8px;">
                        <span class="star-rating" data-rating="1">‚≠ê</span>
                        <span class="star-rating" data-rating="2">‚≠ê</span>
                        <span class="star-rating" data-rating="3">‚≠ê</span>
                        <span class="star-rating" data-rating="4">‚≠ê</span>
                        <span class="star-rating" data-rating="5">‚≠ê</span>
                    </div>
                    <input type="hidden" id="ratingValue" required>
                    <input type="hidden" id="ratingRestaurantId">
                </div>

                <div class="form-group">
                    <label for="ratingNotes">Note (facoltative)</label>
                    <textarea id="ratingNotes" rows="3" placeholder="Racconta la tua esperienza..." style="width: 100%; padding: 14px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRating">Annulla</button>
                    <button type="submit" class="btn btn-primary">‚≠ê Invia Valutazione</button>
                </div>

                <div id="ratingError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- HOTEL MODAL -->
    <div id="hotelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="hotelModalTitle">Aggiungi Hotel</h2>
                <button class="modal-close" id="closeHotelModal">&times;</button>
            </div>

            <form id="hotelForm">
                <div class="form-group">
                    <label for="hotelDay">Giorno Tour *</label>
                    <input type="number" id="hotelDay" required min="1" max="30" placeholder="es. 1">
                </div>

                <div class="form-group">
                    <label for="hotelName">Nome Hotel *</label>
                    <input type="text" id="hotelName" required placeholder="es. Hotel Colosseo">
                </div>

                <div class="form-group">
                    <label for="hotelCity">Citt√† *</label>
                    <input type="text" id="hotelCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="hotelAddress">Indirizzo</label>
                    <input type="text" id="hotelAddress" placeholder="es. Via del Corso 123">
                </div>

                <div class="form-group">
                    <label for="hotelPhone">Telefono</label>
                    <input type="tel" id="hotelPhone" placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label for="hotelWifiPassword">üîê Password WiFi</label>
                    <input type="text" id="hotelWifiPassword" placeholder="es. GuestWiFi2024">
                </div>

                <div class="form-group">
                    <label for="hotelNotes">Note</label>
                    <input type="text" id="hotelNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelHotel">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="hotelError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- EMERGENCY CONTACT MODAL -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="emergencyModalTitle">Aggiungi Contatto di Emergenza</h2>
                <button class="modal-close" id="closeEmergencyModal">&times;</button>
            </div>

            <form id="emergencyForm">
                <div class="form-group">
                    <label for="emergencyCity">Citt√† *</label>
                    <input type="text" id="emergencyCity" required placeholder="es. Roma">
                </div>

                <div class="form-group">
                    <label for="emergencyType">Tipo Contatto *</label>
                    <select id="emergencyType" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="police">üöì Polizia</option>
                        <option value="hospital">üè• Ospedale</option>
                        <option value="embassy">üèõÔ∏è Ambasciata/Consolato</option>
                        <option value="fire">üöí Vigili del Fuoco</option>
                        <option value="taxi">üöï Taxi</option>
                        <option value="other">üìû Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="emergencyName">Nome/Organizzazione *</label>
                    <input type="text" id="emergencyName" required placeholder="es. Ospedale Santo Spirito">
                </div>

                <div class="form-group">
                    <label for="emergencyPhone">Telefono *</label>
                    <input type="tel" id="emergencyPhone" required placeholder="es. +39 06 1234567">
                </div>

                <div class="form-group">
                    <label for="emergencyAddress">Indirizzo</label>
                    <input type="text" id="emergencyAddress" placeholder="es. Via Roma 123">
                </div>

                <div class="form-group">
                    <label for="emergencyNotes">Note</label>
                    <input type="text" id="emergencyNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEmergency">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="emergencyError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- FILE MODAL -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="fileModalTitle">Aggiungi Documento</h2>
                <button class="modal-close" id="closeFileModal">&times;</button>
            </div>

            <form id="fileForm">
                <div class="form-group">
                    <label for="fileName">Nome File *</label>
                    <input type="text" id="fileName" required placeholder="es. Itinerario Completo">
                </div>

                <div class="form-group">
                    <label for="fileType">Tipo Documento *</label>
                    <select id="fileType" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="itinerary">üìÖ Itinerario</option>
                        <option value="voucher">üé´ Voucher</option>
                        <option value="contract">üìã Contratto</option>
                        <option value="insurance">üõ°Ô∏è Assicurazione</option>
                        <option value="passport">üõÇ Documento Identit√†</option>
                        <option value="map">üó∫Ô∏è Mappa</option>
                        <option value="other">üìÑ Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fileUrl">Link al File *</label>
                    <input type="url" id="fileUrl" required placeholder="https://...">
                    <small style="color: var(--text-secondary); font-size: 12px;">Inserisci un link a Google Drive, Dropbox, o altro servizio</small>
                </div>

                <div class="form-group">
                    <label for="fileNotes">Note</label>
                    <input type="text" id="fileNotes" placeholder="Note aggiuntive...">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelFile">Annulla</button>
                    <button type="submit" class="btn btn-primary">üíæ Salva</button>
                </div>

                <div id="fileError" class="error-message"></div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
// ===== SUPABASE SETUP =====
const { createClient } = supabase;

const SUPABASE_URL = 'https://kvomxtzcnczvbcscybcy.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2b214dHpjbmN6dmJjc2N5YmN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTIwOTMsImV4cCI6MjA3OTA2ODA5M30.2fd-urmPrcuWrDdZtR6lNaRsfyNQW64fwEvJv2KI9AE';
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Global state
let currentUser = null;
let currentTL = null;
let currentTourDetail = null;
let currentRestaurantEdit = null;
let currentHotelEdit = null;
let currentEmergencyEdit = null;
let currentFileEdit = null;

// DOM elements
let loginScreen, dashboardScreen, restaurantDatabaseScreen, loginForm, loginError, loginBtn, logoutBtn, userEmail;
let toursGrid, newTourBtn, newTourModal, newTourForm, closeModal, cancelTour, tourError;
let tourDetailModal, closeTourDetail, deleteTourBtn;
let tabButtons, tabPanes;
let restaurantModal, restaurantForm, closeRestaurantModal, cancelRestaurant, restaurantError;
let sharedRestaurantModal, sharedRestaurantForm, closeSharedRestaurantModal, cancelSharedRestaurant, sharedRestaurantError;
let restaurantSearchModal, closeRestaurantSearchModal, searchRestaurantsBtn, searchResultsList;
let ratingModal, ratingForm, closeRatingModal, cancelRating, ratingError;
let hotelModal, hotelForm, closeHotelModal, cancelHotel, hotelError;
let emergencyModal, emergencyForm, closeEmergencyModal, cancelEmergency, emergencyError;
let fileModal, fileForm, closeFileModal, cancelFile, fileError;

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', init);

function init() {
    console.log('üöÄ App loading...');

    // Initialize DOM elements
    loginScreen = document.getElementById('loginScreen');
    dashboardScreen = document.getElementById('dashboardScreen');
    restaurantDatabaseScreen = document.getElementById('restaurantDatabaseScreen');
    loginForm = document.getElementById('loginForm');
    loginError = document.getElementById('loginError');
    loginBtn = document.getElementById('loginBtn');
    logoutBtn = document.getElementById('logoutBtn');
    userEmail = document.getElementById('userEmail');
    toursGrid = document.getElementById('toursGrid');
    newTourBtn = document.getElementById('newTourBtn');
    newTourModal = document.getElementById('newTourModal');
    newTourForm = document.getElementById('newTourForm');
    closeModal = document.getElementById('closeModal');
    cancelTour = document.getElementById('cancelTour');
    tourError = document.getElementById('tourError');

    // Tour detail modal elements
    tourDetailModal = document.getElementById('tourDetailModal');
    closeTourDetail = document.getElementById('closeTourDetail');
    deleteTourBtn = document.getElementById('deleteTourBtn');

    // Tab elements
    tabButtons = document.querySelectorAll('.tab-btn');
    tabPanes = document.querySelectorAll('.tab-pane');

    // Restaurant modal elements
    restaurantModal = document.getElementById('restaurantModal');
    restaurantForm = document.getElementById('restaurantForm');
    closeRestaurantModal = document.getElementById('closeRestaurantModal');
    cancelRestaurant = document.getElementById('cancelRestaurant');
    restaurantError = document.getElementById('restaurantError');

    // Shared restaurant modal elements
    sharedRestaurantModal = document.getElementById('sharedRestaurantModal');
    sharedRestaurantForm = document.getElementById('sharedRestaurantForm');
    closeSharedRestaurantModal = document.getElementById('closeSharedRestaurantModal');
    cancelSharedRestaurant = document.getElementById('cancelSharedRestaurant');
    sharedRestaurantError = document.getElementById('sharedRestaurantError');

    // Restaurant search modal elements
    restaurantSearchModal = document.getElementById('restaurantSearchModal');
    closeRestaurantSearchModal = document.getElementById('closeRestaurantSearchModal');
    searchRestaurantsBtn = document.getElementById('searchRestaurantsBtn');
    searchResultsList = document.getElementById('searchResultsList');

    // Rating modal elements
    ratingModal = document.getElementById('ratingModal');
    ratingForm = document.getElementById('ratingForm');
    closeRatingModal = document.getElementById('closeRatingModal');
    cancelRating = document.getElementById('cancelRating');
    ratingError = document.getElementById('ratingError');

    // Hotel modal elements
    hotelModal = document.getElementById('hotelModal');
    hotelForm = document.getElementById('hotelForm');
    closeHotelModal = document.getElementById('closeHotelModal');
    cancelHotel = document.getElementById('cancelHotel');
    hotelError = document.getElementById('hotelError');

    // Emergency modal elements
    emergencyModal = document.getElementById('emergencyModal');
    emergencyForm = document.getElementById('emergencyForm');
    closeEmergencyModal = document.getElementById('closeEmergencyModal');
    cancelEmergency = document.getElementById('cancelEmergency');
    emergencyError = document.getElementById('emergencyError');

    // File modal elements
    fileModal = document.getElementById('fileModal');
    fileForm = document.getElementById('fileForm');
    closeFileModal = document.getElementById('closeFileModal');
    cancelFile = document.getElementById('cancelFile');
    fileError = document.getElementById('fileError');

    // Check for missing elements
    if (!loginScreen || !dashboardScreen || !loginForm) {
        console.error('‚ùå Critical DOM elements missing!');
        alert('‚ùå ERRORE: Elementi pagina non trovati.');
        return;
    }

    console.log('‚úÖ DOM ready');

    // Set up event listeners
    setupEventListeners();

    // Check if user is already logged in
    checkAuth();
}

function setupEventListeners() {
    // Login
    loginForm.addEventListener('submit', handleLogin);

    // Logout
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            location.reload();
        });
    }

    // Tour modal
    if (newTourBtn) {
        newTourBtn.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.add('active');
            if (newTourForm) newTourForm.reset();
            hideTourError();
        });
    }

    if (closeModal) {
        closeModal.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.remove('active');
        });
    }

    if (cancelTour) {
        cancelTour.addEventListener('click', () => {
            if (newTourModal) newTourModal.classList.remove('active');
        });
    }

    if (newTourModal) {
        newTourModal.addEventListener('click', (e) => {
            if (e.target === newTourModal) {
                newTourModal.classList.remove('active');
            }
        });
    }

    if (newTourForm) {
        newTourForm.addEventListener('submit', handleCreateTour);
    }

    // Tour detail modal
    if (closeTourDetail) {
        closeTourDetail.addEventListener('click', () => {
            if (tourDetailModal) tourDetailModal.classList.remove('active');
        });
    }

    if (tourDetailModal) {
        tourDetailModal.addEventListener('click', (e) => {
            if (e.target === tourDetailModal) {
                tourDetailModal.classList.remove('active');
            }
        });
    }

    // Tab switching
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;
            switchTab(targetTab);
        });
    });

    // Restaurant modal
    if (closeRestaurantModal) {
        closeRestaurantModal.addEventListener('click', () => {
            if (restaurantModal) restaurantModal.classList.remove('active');
        });
    }

    if (cancelRestaurant) {
        cancelRestaurant.addEventListener('click', () => {
            if (restaurantModal) restaurantModal.classList.remove('active');
        });
    }

    if (restaurantModal) {
        restaurantModal.addEventListener('click', (e) => {
            if (e.target === restaurantModal) {
                restaurantModal.classList.remove('active');
            }
        });
    }

    if (restaurantForm) {
        restaurantForm.addEventListener('submit', handleSaveRestaurant);
    }

    // Navigation buttons
    const myToursBtn = document.getElementById('myToursBtn');
    const myToursBtn2 = document.getElementById('myToursBtn2');
    const restaurantDbBtn = document.getElementById('restaurantDbBtn');
    const restaurantDbBtn2 = document.getElementById('restaurantDbBtn2');
    const logoutBtn2 = document.getElementById('logoutBtn2');

    if (myToursBtn) myToursBtn.addEventListener('click', () => showScreen('dashboard'));
    if (myToursBtn2) myToursBtn2.addEventListener('click', () => showScreen('dashboard'));
    if (restaurantDbBtn) restaurantDbBtn.addEventListener('click', () => showScreen('restaurantDatabase'));
    if (restaurantDbBtn2) restaurantDbBtn2.addEventListener('click', () => showScreen('restaurantDatabase'));
    if (logoutBtn2) {
        logoutBtn2.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            location.reload();
        });
    }

    // Search database button in restaurant form
    const searchDatabaseBtn = document.getElementById('searchDatabaseBtn');
    if (searchDatabaseBtn) {
        searchDatabaseBtn.addEventListener('click', openRestaurantSearchModal);
    }

    // Shared restaurant modal
    if (closeSharedRestaurantModal) {
        closeSharedRestaurantModal.addEventListener('click', () => {
            if (sharedRestaurantModal) sharedRestaurantModal.classList.remove('active');
        });
    }

    if (cancelSharedRestaurant) {
        cancelSharedRestaurant.addEventListener('click', () => {
            if (sharedRestaurantModal) sharedRestaurantModal.classList.remove('active');
        });
    }

    if (sharedRestaurantModal) {
        sharedRestaurantModal.addEventListener('click', (e) => {
            if (e.target === sharedRestaurantModal) {
                sharedRestaurantModal.classList.remove('active');
            }
        });
    }

    if (sharedRestaurantForm) {
        sharedRestaurantForm.addEventListener('submit', handleSaveSharedRestaurant);
    }

    // Restaurant search modal
    if (closeRestaurantSearchModal) {
        closeRestaurantSearchModal.addEventListener('click', () => {
            if (restaurantSearchModal) restaurantSearchModal.classList.remove('active');
        });
    }

    if (restaurantSearchModal) {
        restaurantSearchModal.addEventListener('click', (e) => {
            if (e.target === restaurantSearchModal) {
                restaurantSearchModal.classList.remove('active');
            }
        });
    }

    if (searchRestaurantsBtn) {
        searchRestaurantsBtn.addEventListener('click', performRestaurantSearch);
    }

    // Rating modal
    if (closeRatingModal) {
        closeRatingModal.addEventListener('click', () => {
            if (ratingModal) ratingModal.classList.remove('active');
        });
    }

    if (cancelRating) {
        cancelRating.addEventListener('click', () => {
            if (ratingModal) ratingModal.classList.remove('active');
        });
    }

    if (ratingModal) {
        ratingModal.addEventListener('click', (e) => {
            if (e.target === ratingModal) {
                ratingModal.classList.remove('active');
            }
        });
    }

    if (ratingForm) {
        ratingForm.addEventListener('submit', handleSubmitRating);
    }

    // Star rating clicks
    document.querySelectorAll('.star-rating').forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            document.getElementById('ratingValue').value = rating;

            // Update visual feedback
            document.querySelectorAll('.star-rating').forEach((s, idx) => {
                if (idx < rating) {
                    s.classList.add('selected');
                } else {
                    s.classList.remove('selected');
                }
            });
        });
    });

    // Hotel modal
    if (closeHotelModal) {
        closeHotelModal.addEventListener('click', () => {
            if (hotelModal) hotelModal.classList.remove('active');
        });
    }

    if (cancelHotel) {
        cancelHotel.addEventListener('click', () => {
            if (hotelModal) hotelModal.classList.remove('active');
        });
    }

    if (hotelModal) {
        hotelModal.addEventListener('click', (e) => {
            if (e.target === hotelModal) {
                hotelModal.classList.remove('active');
            }
        });
    }

    if (hotelForm) {
        hotelForm.addEventListener('submit', handleSaveHotel);
    }

    // Emergency contact modal
    if (closeEmergencyModal) {
        closeEmergencyModal.addEventListener('click', () => {
            if (emergencyModal) emergencyModal.classList.remove('active');
        });
    }

    if (cancelEmergency) {
        cancelEmergency.addEventListener('click', () => {
            if (emergencyModal) emergencyModal.classList.remove('active');
        });
    }

    if (emergencyModal) {
        emergencyModal.addEventListener('click', (e) => {
            if (e.target === emergencyModal) {
                emergencyModal.classList.remove('active');
            }
        });
    }

    if (emergencyForm) {
        emergencyForm.addEventListener('submit', handleSaveEmergency);
    }

    // File modal
    if (closeFileModal) {
        closeFileModal.addEventListener('click', () => {
            if (fileModal) fileModal.classList.remove('active');
        });
    }

    if (cancelFile) {
        cancelFile.addEventListener('click', () => {
            if (fileModal) fileModal.classList.remove('active');
        });
    }

    if (fileModal) {
        fileModal.addEventListener('click', (e) => {
            if (e.target === fileModal) {
                fileModal.classList.remove('active');
            }
        });
    }

    if (fileForm) {
        fileForm.addEventListener('submit', handleSaveFile);
    }

    // Add shared restaurant button
    const addSharedRestaurantBtn = document.getElementById('addSharedRestaurantBtn');
    if (addSharedRestaurantBtn) {
        addSharedRestaurantBtn.addEventListener('click', () => {
            if (sharedRestaurantForm) sharedRestaurantForm.reset();
            if (sharedRestaurantModal) sharedRestaurantModal.classList.add('active');
        });
    }

    // Apply filters button
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', loadSharedRestaurants);
    }

    // Delete tour button (will be reattached when modal opens)
    // Other buttons will be handled in openTourDetail()
}

async function checkAuth() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
            const { data: tlData, error: tlError } = await supabaseClient
                .from('tl_users')
                .select('*')
                .eq('user_id', session.user.id)
                .single();

            if (tlError || !tlData) {
                console.error('TL profile not found:', tlError);
                showError('Profilo Tour Leader non trovato');
                await supabaseClient.auth.signOut();
                return;
            }

            showDashboard(session.user, tlData);
        }
    } catch (error) {
        console.error('Auth check error:', error);
    }
}

async function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    console.log('üéØ Login attempt:', email);

    if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span class="btn-text">Caricamento...</span>';
    }
    hideError();

    // Show immediate feedback
    alert(`‚è≥ Tentativo login con:\n${email}\n\nPremi OK...`);

    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
        });

        if (error) {
            console.error('‚ùå Auth error:', error);
            throw new Error(`Auth: ${error.message}`);
        }

        console.log('‚úÖ Auth OK, user:', data.user?.id);

        const { data: tlData, error: tlError } = await supabaseClient
            .from('tl_users')
            .select('*')
            .eq('user_id', data.user.id)
            .single();

        if (tlError) {
            console.error('‚ùå DB error:', tlError);
            throw new Error(`DB: ${tlError.message} (${tlError.code})`);
        }

        if (!tlData) {
            throw new Error('Profilo TL non trovato');
        }

        console.log('‚úÖ TL profile found');
        showDashboard(data.user, tlData);

    } catch (error) {
        console.error('üí• Login failed:', error);
        const errorMsg = error.message || 'Errore login';
        showError(errorMsg);

        setTimeout(() => {
            alert('‚ùå LOGIN FALLITO:\n\n' + errorMsg + '\n\nControlla Supabase!');
        }, 300);

        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<span class="btn-text">Accedi</span>';
        }
    }
}

function showDashboard(user, tlData) {
    if (!loginScreen || !dashboardScreen) {
        alert('Errore: impossibile mostrare dashboard');
        return;
    }

    currentUser = user;
    currentTL = tlData;

    loginScreen.classList.remove('active');
    dashboardScreen.classList.add('active');

    if (userEmail) {
        userEmail.textContent = user.email;
    }

    loadTours();
}

async function loadTours() {
    if (!currentTL || !currentTL.id) {
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore: Profilo TL non caricato</p>';
        }
        return;
    }

    try {
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading">Caricamento tour...</p>';
        }

        const { data: tours, error } = await supabaseClient
            .from('tours')
            .select('*')
            .eq('tl_id', currentTL.id)
            .order('start_date', { ascending: false });

        if (error) {
            console.error('Error loading tours:', error);
            if (toursGrid) {
                toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore nel caricamento</p>';
            }
            return;
        }

        if (!tours || tours.length === 0) {
            if (toursGrid) {
                toursGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #8B9DC3;">
                        <h2 style="font-size: 24px; margin-bottom: 16px; color: #00F0FF;">Nessun tour ancora</h2>
                        <p style="font-size: 16px;">Clicca su "+ Nuovo Tour" per iniziare!</p>
                    </div>
                `;
            }
        } else {
            displayTours(tours);
        }
    } catch (error) {
        console.error('Load tours error:', error);
        if (toursGrid) {
            toursGrid.innerHTML = '<p class="loading" style="color: #FF4757;">Errore caricamento</p>';
        }
    }
}

function displayTours(tours) {
    if (!toursGrid) return;

    toursGrid.innerHTML = tours.map(tour => `
        <div class="tour-card" data-tour-id="${tour.id}" onclick="openTourDetail('${tour.id}')">
            <span class="tour-code">${tour.code}</span>
            <h3 class="tour-name">${tour.name}</h3>
            <div class="tour-meta">
                <div>üìÖ ${formatDate(tour.start_date)} - ${formatDate(tour.end_date)}</div>
                <div>üè¢ ${tour.operator || 'N/A'}</div>
                <div>üìä ${tour.status === 'active' ? 'Attivo' : 'Archiviato'}</div>
            </div>
        </div>
    `).join('');

    // Store tours in memory for quick access
    window.allTours = tours;
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

async function handleCreateTour(e) {
    e.preventDefault();
    hideTourError();

    const tourData = {
        tl_id: currentTL.id,
        code: document.getElementById('tourCode').value.toUpperCase(),
        name: document.getElementById('tourName').value,
        operator: document.getElementById('tourOperator').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        status: 'active'
    };

    if (new Date(tourData.end_date) < new Date(tourData.start_date)) {
        showTourError('La data di fine deve essere dopo la data di inizio');
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tours')
            .insert([tourData]);

        if (error) throw error;

        if (newTourModal) newTourModal.classList.remove('active');
        if (newTourForm) newTourForm.reset();
        loadTours();

    } catch (error) {
        console.error('Create tour error:', error);

        if (error.code === '23505') {
            showTourError('Codice tour gi√† esistente');
        } else {
            showTourError(error.message || 'Errore creazione tour');
        }
    }
}

function showError(message) {
    if (loginError) {
        loginError.textContent = message;
        loginError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideError() {
    if (loginError) {
        loginError.classList.remove('show');
    }
}

function showTourError(message) {
    if (tourError) {
        tourError.textContent = message;
        tourError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideTourError() {
    if (tourError) {
        tourError.classList.remove('show');
    }
}

// ===== TAB SWITCHING =====

function switchTab(tabName) {
    // Update tab buttons
    tabButtons.forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // Update tab panes
    tabPanes.forEach(pane => {
        if (pane.id === `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`) {
            pane.classList.add('active');
        } else {
            pane.classList.remove('active');
        }
    });

    // Load data when switching to tabs
    if (tabName === 'ristoranti') {
        loadRestaurants();
    } else if (tabName === 'hotel') {
        loadHotels();
    } else if (tabName === 'emergenze') {
        loadEmergencyContacts();
    } else if (tabName === 'file') {
        loadFiles();
    }
}

// ===== TOUR DETAIL FUNCTIONS =====

function openTourDetail(tourId) {
    // Find tour in stored tours
    const tour = window.allTours?.find(t => t.id === tourId);

    if (!tour) {
        alert('‚ùå Tour non trovato');
        return;
    }

    currentTourDetail = tour;

    // Populate modal header
    document.getElementById('modalTourName').textContent = tour.name;
    document.getElementById('modalTourCode').textContent = tour.code;

    // Switch to dashboard tab
    switchTab('dashboard');

    // Load dashboard data
    loadDashboardData();

    // Set up button listeners (need to be reattached each time modal opens)
    setupModalButtons();

    // Open modal
    if (tourDetailModal) tourDetailModal.classList.add('active');
}

function setupModalButtons() {
    // Delete tour button
    const deleteBtn = document.getElementById('deleteTourBtn');
    if (deleteBtn) {
        deleteBtn.onclick = handleDeleteTour;
    }

    // Edit tour info button
    const editInfoBtn = document.getElementById('editTourInfoBtn');
    if (editInfoBtn) {
        editInfoBtn.onclick = () => alert('üöß Modifica info tour in arrivo!');
    }

    // Upload PDF button
    const uploadPdfBtn = document.getElementById('uploadPdfBtn');
    if (uploadPdfBtn) {
        uploadPdfBtn.onclick = () => alert('üöß Upload PDF in arrivo! (Phase 3)');
    }

    // Publish site button
    const publishSiteBtn = document.getElementById('publishSiteBtn');
    if (publishSiteBtn) {
        publishSiteBtn.onclick = () => alert('üöß Mini-Site in arrivo!');
    }

    // Add restaurant button
    const addRestaurantBtn = document.getElementById('addRestaurantBtn');
    if (addRestaurantBtn) {
        addRestaurantBtn.onclick = openAddRestaurantForm;
    }

    // Add hotel button
    const addHotelBtn = document.getElementById('addHotelBtn');
    if (addHotelBtn) {
        addHotelBtn.onclick = openAddHotelForm;
    }

    // Generate days button
    const generateDaysBtn = document.getElementById('generateDaysBtn');
    if (generateDaysBtn) {
        generateDaysBtn.onclick = () => alert('üöß Genera giorni in arrivo!');
    }

    // Add emergency button
    const addEmergencyBtn = document.getElementById('addEmergencyBtn');
    if (addEmergencyBtn) {
        addEmergencyBtn.onclick = openAddEmergencyForm;
    }

    // Add file button
    const addFileBtn = document.getElementById('addFileBtn');
    if (addFileBtn) {
        addFileBtn.onclick = openAddFileForm;
    }

    // Add link button
    const addLinkBtn = document.getElementById('addLinkBtn');
    if (addLinkBtn) {
        addLinkBtn.onclick = () => alert('üöß Aggiungi link in arrivo!');
    }

    // Save template button
    const saveTemplateBtn = document.getElementById('saveTemplateBtn');
    if (saveTemplateBtn) {
        saveTemplateBtn.onclick = () => alert('üöß Salva template in arrivo!');
    }

    // Total passengers input
    const totalPassengersInput = document.getElementById('totalPassengersInput');
    if (totalPassengersInput) {
        totalPassengersInput.onchange = handlePassengersChange;
    }
}

function loadDashboardData() {
    if (!currentTourDetail) return;

    // Load from tour data
    const feedbackCount = currentTourDetail.feedback_count || 0;
    const totalPassengers = currentTourDetail.total_passengers || 0;

    document.getElementById('feedbackCount').textContent = feedbackCount;
    document.getElementById('totalPassengers').textContent = totalPassengers;
    document.getElementById('totalPassengersInput').value = totalPassengers || '';

    // Calculate percentage
    const percentage = totalPassengers > 0 ? Math.round((feedbackCount / totalPassengers) * 100) : 0;
    document.getElementById('feedbackPercentage').textContent = percentage + '%';
}

function incrementFeedback() {
    const currentCount = parseInt(document.getElementById('feedbackCount').textContent) || 0;
    const newCount = currentCount + 1;
    document.getElementById('feedbackCount').textContent = newCount;
    updatePercentage();
    // Auto-save
    saveFeedbackCount(newCount);
}

function decrementFeedback() {
    const currentCount = parseInt(document.getElementById('feedbackCount').textContent) || 0;
    if (currentCount > 0) {
        const newCount = currentCount - 1;
        document.getElementById('feedbackCount').textContent = newCount;
        updatePercentage();
        // Auto-save
        saveFeedbackCount(newCount);
    }
}

function updatePercentage() {
    const feedbackCount = parseInt(document.getElementById('feedbackCount').textContent) || 0;
    const totalPassengers = parseInt(document.getElementById('totalPassengers').textContent) || 0;
    const percentage = totalPassengers > 0 ? Math.round((feedbackCount / totalPassengers) * 100) : 0;
    document.getElementById('feedbackPercentage').textContent = percentage + '%';
}

async function saveFeedbackCount(count) {
    if (!currentTourDetail || !currentTourDetail.id) return;

    try {
        const { error } = await supabaseClient
            .from('tours')
            .update({ feedback_count: count })
            .eq('id', currentTourDetail.id);

        if (error) throw error;

        // Update current tour detail
        currentTourDetail.feedback_count = count;

    } catch (error) {
        console.error('Save feedback error:', error);
        alert('‚ùå Errore salvataggio feedback:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function saveDashboardData() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const totalPassengers = parseInt(document.getElementById('totalPassengersInput').value) || 0;

    if (totalPassengers < 1) {
        alert('‚ùå Inserisci un numero di passeggeri valido');
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tours')
            .update({ total_passengers: totalPassengers })
            .eq('id', currentTourDetail.id);

        if (error) throw error;

        // Update current tour detail and display
        currentTourDetail.total_passengers = totalPassengers;
        document.getElementById('totalPassengers').textContent = totalPassengers;
        updatePercentage();

        alert('‚úÖ Dati salvati!');

    } catch (error) {
        console.error('Save dashboard data error:', error);
        alert('‚ùå Errore salvataggio:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function handlePassengersChange(e) {
    // Deprecated - now using saveDashboardData button
    const total = parseInt(e.target.value) || 0;
    document.getElementById('totalPassengers').textContent = total;
    updatePercentage();
}

async function handleDeleteTour() {
    if (!currentTourDetail) return;

    // Confirm deletion
    const confirmed = confirm(
        `‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler cancellare il tour:\n\n"${currentTourDetail.code} - ${currentTourDetail.name}"\n\nQuesta azione √® IRREVERSIBILE!`
    );

    if (!confirmed) return;

    try {
        const { error } = await supabaseClient
            .from('tours')
            .delete()
            .eq('id', currentTourDetail.id);

        if (error) throw error;

        // Success
        alert('‚úÖ Tour cancellato con successo!');

        // Close modal
        if (tourDetailModal) tourDetailModal.classList.remove('active');

        // Reload tours
        loadTours();

    } catch (error) {
        console.error('Delete tour error:', error);
        alert('‚ùå Errore nella cancellazione:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

// ===== RESTAURANT FUNCTIONS =====

async function loadRestaurants() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const restaurantsList = document.getElementById('restaurantsList');
    if (!restaurantsList) return;

    try {
        restaurantsList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: restaurants, error } = await supabaseClient
            .from('tour_restaurants')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('city', { ascending: true });

        if (error) throw error;

        if (!restaurants || restaurants.length === 0) {
            restaurantsList.innerHTML = '<p class="loading">Nessun ristorante ancora</p>';
        } else {
            displayRestaurants(restaurants);
        }
    } catch (error) {
        console.error('Load restaurants error:', error);
        restaurantsList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento ristoranti:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayRestaurants(restaurants) {
    const restaurantsList = document.getElementById('restaurantsList');
    if (!restaurantsList) return;

    restaurantsList.innerHTML = restaurants.map(restaurant => {
        const advantages = restaurant.advantages || [];
        const badgesHtml = advantages.map(adv => {
            if (adv.type === 'tl_free') {
                return `<span class="badge badge-green">üéÅ TL Free</span>`;
            } else if (adv.type === 'commission') {
                return `<span class="badge badge-yellow">üí∞ Commission</span>`;
            } else if (adv.type === 'discount') {
                return `<span class="badge badge-blue">üè∑Ô∏è Discount</span>`;
            }
            return '';
        }).join('');

        return `
            <div class="data-card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <h4 style="margin: 0;">${restaurant.name} <span class="badge badge-blue" style="font-size: 11px;">Giorno ${restaurant.day_number || '?'}</span></h4>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="openEditRestaurantForm('${restaurant.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; background: var(--error); border-color: var(--error);" onclick="handleDeleteRestaurant('${restaurant.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="meta">üìç ${restaurant.city || 'N/A'}${restaurant.address ? ' - ' + restaurant.address : ''}</div>
                ${restaurant.phone ? `<div class="meta">üìû ${restaurant.phone}</div>` : ''}
                ${badgesHtml ? `<div style="margin-top: 8px;">${badgesHtml}</div>` : ''}
                ${restaurant.notes ? `<div class="meta" style="margin-top: 8px;">üí¨ ${restaurant.notes}</div>` : ''}
            </div>
        `;
    }).join('');

    // Store restaurants in memory
    window.currentRestaurants = restaurants;
}

function openAddRestaurantForm() {
    currentRestaurantEdit = null;

    // Reset form
    if (restaurantForm) restaurantForm.reset();

    // Set title
    document.getElementById('restaurantModalTitle').textContent = 'Aggiungi Ristorante';

    // Clear error
    hideRestaurantError();

    // Open modal
    if (restaurantModal) restaurantModal.classList.add('active');
}

function openEditRestaurantForm(restaurantId) {
    const restaurant = window.currentRestaurants?.find(r => r.id === restaurantId);
    if (!restaurant) {
        alert('‚ùå Ristorante non trovato');
        return;
    }

    currentRestaurantEdit = restaurant;

    // Populate form
    document.getElementById('restaurantDay').value = restaurant.day_number || '';
    document.getElementById('restaurantName').value = restaurant.name || '';
    document.getElementById('restaurantCity').value = restaurant.city || '';
    document.getElementById('restaurantAddress').value = restaurant.address || '';
    document.getElementById('restaurantPhone').value = restaurant.phone || '';
    document.getElementById('restaurantNotes').value = restaurant.notes || '';

    // Clear all advantages first
    document.getElementById('advTlFree').checked = false;
    document.getElementById('advTlFreeDesc').value = '';
    document.getElementById('advCommission').checked = false;
    document.getElementById('advCommissionDesc').value = '';
    document.getElementById('advDiscount').checked = false;
    document.getElementById('advDiscountDesc').value = '';

    // Populate advantages
    const advantages = restaurant.advantages || [];
    advantages.forEach(adv => {
        if (adv.type === 'tl_free') {
            document.getElementById('advTlFree').checked = true;
            document.getElementById('advTlFreeDesc').value = adv.description || '';
        } else if (adv.type === 'commission') {
            document.getElementById('advCommission').checked = true;
            document.getElementById('advCommissionDesc').value = adv.description || '';
        } else if (adv.type === 'discount') {
            document.getElementById('advDiscount').checked = true;
            document.getElementById('advDiscountDesc').value = adv.description || '';
        }
    });

    // Set title
    document.getElementById('restaurantModalTitle').textContent = 'Modifica Ristorante';

    // Clear error
    hideRestaurantError();

    // Open modal
    if (restaurantModal) restaurantModal.classList.add('active');
}

async function handleSaveRestaurant(e) {
    e.preventDefault();
    hideRestaurantError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showRestaurantError('Tour non selezionato');
        return;
    }

    // Collect form data
    const restaurantData = {
        tour_id: currentTourDetail.id,
        day_number: parseInt(document.getElementById('restaurantDay').value),
        name: document.getElementById('restaurantName').value,
        city: document.getElementById('restaurantCity').value,
        address: document.getElementById('restaurantAddress').value || null,
        phone: document.getElementById('restaurantPhone').value || null,
        notes: document.getElementById('restaurantNotes').value || null,
        advantages: []
    };

    // Collect advantages
    if (document.getElementById('advTlFree').checked) {
        restaurantData.advantages.push({
            type: 'tl_free',
            description: document.getElementById('advTlFreeDesc').value || ''
        });
    }
    if (document.getElementById('advCommission').checked) {
        restaurantData.advantages.push({
            type: 'commission',
            description: document.getElementById('advCommissionDesc').value || ''
        });
    }
    if (document.getElementById('advDiscount').checked) {
        restaurantData.advantages.push({
            type: 'discount',
            description: document.getElementById('advDiscountDesc').value || ''
        });
    }

    try {
        if (currentRestaurantEdit) {
            // Update
            const { error } = await supabaseClient
                .from('tour_restaurants')
                .update(restaurantData)
                .eq('id', currentRestaurantEdit.id);

            if (error) throw error;

            alert('‚úÖ Ristorante aggiornato!');
        } else {
            // Insert
            const { error } = await supabaseClient
                .from('tour_restaurants')
                .insert([restaurantData]);

            if (error) throw error;

            alert('‚úÖ Ristorante aggiunto!');
        }

        // Close modal
        if (restaurantModal) restaurantModal.classList.remove('active');

        // Reload restaurants
        loadRestaurants();

    } catch (error) {
        console.error('Save restaurant error:', error);
        showRestaurantError(error.message || 'Errore nel salvataggio');
    }
}

async function handleDeleteRestaurant(restaurantId) {
    const restaurant = window.currentRestaurants?.find(r => r.id === restaurantId);
    if (!restaurant) return;

    const confirmed = confirm(
        `‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler cancellare:\n\n"${restaurant.name}"\n\nQuesta azione √® IRREVERSIBILE!`
    );

    if (!confirmed) return;

    try {
        const { error } = await supabaseClient
            .from('tour_restaurants')
            .delete()
            .eq('id', restaurantId);

        if (error) throw error;

        alert('‚úÖ Ristorante cancellato!');
        loadRestaurants();

    } catch (error) {
        console.error('Delete restaurant error:', error);
        alert('‚ùå Errore nella cancellazione:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showRestaurantError(message) {
    if (restaurantError) {
        restaurantError.textContent = message;
        restaurantError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideRestaurantError() {
    if (restaurantError) {
        restaurantError.classList.remove('show');
    }
}

// ===== HOTEL FUNCTIONS =====

async function loadHotels() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const hotelsList = document.getElementById('hotelsList');
    if (!hotelsList) return;

    try {
        hotelsList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: hotels, error } = await supabaseClient
            .from('tour_hotels')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('day_number', { ascending: true });

        if (error) throw error;

        if (!hotels || hotels.length === 0) {
            hotelsList.innerHTML = '<p class="loading">Nessun hotel ancora</p>';
        } else {
            displayHotels(hotels);
        }
    } catch (error) {
        console.error('Load hotels error:', error);
        hotelsList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento hotel:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayHotels(hotels) {
    const hotelsList = document.getElementById('hotelsList');
    if (!hotelsList) return;

    hotelsList.innerHTML = hotels.map(hotel => `
        <div class="data-card" style="margin-bottom: 12px; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary-blue);">Giorno ${hotel.day_number}</span>
                        <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${hotel.name}</h4>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                        üìç ${hotel.city}
                        ${hotel.address ? `<br>üìß ${hotel.address}` : ''}
                        ${hotel.phone ? `<br>üìû ${hotel.phone}` : ''}
                    </div>
                    ${hotel.wifi_password ? `
                        <div style="margin-top: 8px; padding: 8px 12px; background: rgba(0, 240, 255, 0.1); border: 1px solid var(--primary-blue); border-radius: 6px;">
                            <span style="font-weight: 600; color: var(--primary-blue);">üîê WiFi:</span> ${hotel.wifi_password}
                        </div>
                    ` : ''}
                    ${hotel.notes ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${hotel.notes}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-left: 12px;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditHotelForm(${hotel.id})">‚úèÔ∏è</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteHotel(${hotel.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddHotelForm() {
    currentHotelEdit = null;

    if (hotelForm) hotelForm.reset();

    document.getElementById('hotelModalTitle').textContent = 'Aggiungi Hotel';

    hideHotelError();

    if (hotelModal) hotelModal.classList.add('active');
}

async function openEditHotelForm(hotelId) {
    try {
        const { data: hotel, error } = await supabaseClient
            .from('tour_hotels')
            .select('*')
            .eq('id', hotelId)
            .single();

        if (error) throw error;
        if (!hotel) throw new Error('Hotel non trovato');

        currentHotelEdit = hotel;

        // Fill form
        document.getElementById('hotelDay').value = hotel.day_number;
        document.getElementById('hotelName').value = hotel.name;
        document.getElementById('hotelCity').value = hotel.city;
        document.getElementById('hotelAddress').value = hotel.address || '';
        document.getElementById('hotelPhone').value = hotel.phone || '';
        document.getElementById('hotelWifiPassword').value = hotel.wifi_password || '';
        document.getElementById('hotelNotes').value = hotel.notes || '';

        document.getElementById('hotelModalTitle').textContent = 'Modifica Hotel';

        hideHotelError();

        if (hotelModal) hotelModal.classList.add('active');

    } catch (error) {
        console.error('Load hotel error:', error);
        alert('‚ùå Errore caricamento hotel:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveHotel(e) {
    e.preventDefault();
    hideHotelError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showHotelError('Tour non selezionato');
        return;
    }

    const hotelData = {
        tour_id: currentTourDetail.id,
        day_number: parseInt(document.getElementById('hotelDay').value),
        name: document.getElementById('hotelName').value,
        city: document.getElementById('hotelCity').value,
        address: document.getElementById('hotelAddress').value || null,
        phone: document.getElementById('hotelPhone').value || null,
        wifi_password: document.getElementById('hotelWifiPassword').value || null,
        notes: document.getElementById('hotelNotes').value || null
    };

    try {
        if (currentHotelEdit && currentHotelEdit.id) {
            // Update existing hotel
            const { error } = await supabaseClient
                .from('tour_hotels')
                .update(hotelData)
                .eq('id', currentHotelEdit.id);

            if (error) throw error;
        } else {
            // Create new hotel
            const { error } = await supabaseClient
                .from('tour_hotels')
                .insert([hotelData]);

            if (error) throw error;
        }

        if (hotelModal) hotelModal.classList.remove('active');

        loadHotels();

    } catch (error) {
        console.error('Save hotel error:', error);
        showHotelError(error.message || 'Errore salvataggio hotel');
    }
}

async function deleteHotel(hotelId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo hotel?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_hotels')
            .delete()
            .eq('id', hotelId);

        if (error) throw error;

        loadHotels();

    } catch (error) {
        console.error('Delete hotel error:', error);
        alert('‚ùå Errore eliminazione hotel:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showHotelError(message) {
    if (hotelError) {
        hotelError.textContent = message;
        hotelError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideHotelError() {
    if (hotelError) {
        hotelError.classList.remove('show');
    }
}

// ===== EMERGENCY CONTACT FUNCTIONS =====

const emergencyTypeIcons = {
    police: 'üöì',
    hospital: 'üè•',
    embassy: 'üèõÔ∏è',
    fire: 'üöí',
    taxi: 'üöï',
    other: 'üìû'
};

const emergencyTypeNames = {
    police: 'Polizia',
    hospital: 'Ospedale',
    embassy: 'Ambasciata/Consolato',
    fire: 'Vigili del Fuoco',
    taxi: 'Taxi',
    other: 'Altro'
};

async function loadEmergencyContacts() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const emergencyList = document.getElementById('emergencyList');
    if (!emergencyList) return;

    try {
        emergencyList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: contacts, error } = await supabaseClient
            .from('tour_emergency_contacts')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('city', { ascending: true });

        if (error) throw error;

        if (!contacts || contacts.length === 0) {
            emergencyList.innerHTML = '<p class="loading">Nessun contatto ancora</p>';
        } else {
            displayEmergencyContacts(contacts);
        }
    } catch (error) {
        console.error('Load emergency contacts error:', error);
        emergencyList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento contatti emergenza:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayEmergencyContacts(contacts) {
    const emergencyList = document.getElementById('emergencyList');
    if (!emergencyList) return;

    // Group contacts by city
    const contactsByCity = contacts.reduce((acc, contact) => {
        if (!acc[contact.city]) {
            acc[contact.city] = [];
        }
        acc[contact.city].push(contact);
        return acc;
    }, {});

    emergencyList.innerHTML = Object.keys(contactsByCity).sort().map(city => `
        <div style="margin-bottom: 24px;">
            <h4 style="font-size: 18px; font-weight: 700; color: var(--primary-blue); margin-bottom: 12px;">üìç ${city}</h4>
            ${contactsByCity[city].map(contact => `
                <div class="data-card" style="margin-bottom: 12px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">${emergencyTypeIcons[contact.contact_type] || 'üìû'}</span>
                                <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${contact.name}</h4>
                                <span style="font-size: 13px; color: var(--text-secondary);">(${emergencyTypeNames[contact.contact_type] || contact.contact_type})</span>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                                üìû <a href="tel:${contact.phone}" style="color: var(--primary-blue); text-decoration: none;">${contact.phone}</a>
                                ${contact.address ? `<br>üìß ${contact.address}` : ''}
                            </div>
                            ${contact.notes ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${contact.notes}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 12px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditEmergencyForm(${contact.id})">‚úèÔ∏è</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteEmergencyContact(${contact.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `).join('');
}

function openAddEmergencyForm() {
    currentEmergencyEdit = null;

    if (emergencyForm) emergencyForm.reset();

    document.getElementById('emergencyModalTitle').textContent = 'Aggiungi Contatto di Emergenza';

    hideEmergencyError();

    if (emergencyModal) emergencyModal.classList.add('active');
}

async function openEditEmergencyForm(contactId) {
    try {
        const { data: contact, error } = await supabaseClient
            .from('tour_emergency_contacts')
            .select('*')
            .eq('id', contactId)
            .single();

        if (error) throw error;
        if (!contact) throw new Error('Contatto non trovato');

        currentEmergencyEdit = contact;

        // Fill form
        document.getElementById('emergencyCity').value = contact.city;
        document.getElementById('emergencyType').value = contact.contact_type;
        document.getElementById('emergencyName').value = contact.name;
        document.getElementById('emergencyPhone').value = contact.phone;
        document.getElementById('emergencyAddress').value = contact.address || '';
        document.getElementById('emergencyNotes').value = contact.notes || '';

        document.getElementById('emergencyModalTitle').textContent = 'Modifica Contatto di Emergenza';

        hideEmergencyError();

        if (emergencyModal) emergencyModal.classList.add('active');

    } catch (error) {
        console.error('Load emergency contact error:', error);
        alert('‚ùå Errore caricamento contatto:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveEmergency(e) {
    e.preventDefault();
    hideEmergencyError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showEmergencyError('Tour non selezionato');
        return;
    }

    const contactData = {
        tour_id: currentTourDetail.id,
        city: document.getElementById('emergencyCity').value,
        contact_type: document.getElementById('emergencyType').value,
        name: document.getElementById('emergencyName').value,
        phone: document.getElementById('emergencyPhone').value,
        address: document.getElementById('emergencyAddress').value || null,
        notes: document.getElementById('emergencyNotes').value || null
    };

    try {
        if (currentEmergencyEdit && currentEmergencyEdit.id) {
            // Update existing contact
            const { error } = await supabaseClient
                .from('tour_emergency_contacts')
                .update(contactData)
                .eq('id', currentEmergencyEdit.id);

            if (error) throw error;
        } else {
            // Create new contact
            const { error } = await supabaseClient
                .from('tour_emergency_contacts')
                .insert([contactData]);

            if (error) throw error;
        }

        if (emergencyModal) emergencyModal.classList.remove('active');

        loadEmergencyContacts();

    } catch (error) {
        console.error('Save emergency contact error:', error);
        showEmergencyError(error.message || 'Errore salvataggio contatto');
    }
}

async function deleteEmergencyContact(contactId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo contatto?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_emergency_contacts')
            .delete()
            .eq('id', contactId);

        if (error) throw error;

        loadEmergencyContacts();

    } catch (error) {
        console.error('Delete emergency contact error:', error);
        alert('‚ùå Errore eliminazione contatto:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showEmergencyError(message) {
    if (emergencyError) {
        emergencyError.textContent = message;
        emergencyError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideEmergencyError() {
    if (emergencyError) {
        emergencyError.classList.remove('show');
    }
}

// ===== FILE FUNCTIONS =====

const fileTypeIcons = {
    itinerary: 'üìÖ',
    voucher: 'üé´',
    contract: 'üìã',
    insurance: 'üõ°Ô∏è',
    passport: 'üõÇ',
    map: 'üó∫Ô∏è',
    other: 'üìÑ'
};

const fileTypeNames = {
    itinerary: 'Itinerario',
    voucher: 'Voucher',
    contract: 'Contratto',
    insurance: 'Assicurazione',
    passport: 'Documento Identit√†',
    map: 'Mappa',
    other: 'Altro'
};

async function loadFiles() {
    if (!currentTourDetail || !currentTourDetail.id) return;

    const filesList = document.getElementById('filesList');
    if (!filesList) return;

    try {
        filesList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: files, error } = await supabaseClient
            .from('tour_files')
            .select('*')
            .eq('tour_id', currentTourDetail.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!files || files.length === 0) {
            filesList.innerHTML = '<p class="loading">Nessun file ancora</p>';
        } else {
            displayFiles(files);
        }
    } catch (error) {
        console.error('Load files error:', error);
        filesList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento file:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displayFiles(files) {
    const filesList = document.getElementById('filesList');
    if (!filesList) return;

    filesList.innerHTML = files.map(file => `
        <div class="data-card" style="margin-bottom: 12px; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 20px;">${fileTypeIcons[file.file_type] || 'üìÑ'}</span>
                        <h4 style="font-size: 16px; font-weight: 700; margin: 0;">${file.name}</h4>
                        <span style="font-size: 13px; color: var(--text-secondary);">(${fileTypeNames[file.file_type] || file.file_type})</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <a href="${file.url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); text-decoration: none; font-size: 14px;">
                            üîó Apri documento ‚Üí
                        </a>
                    </div>
                    ${file.notes ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">üìù ${file.notes}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px; margin-left: 12px;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="openEditFileForm(${file.id})">‚úèÔ∏è</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px; background: var(--error); border-color: var(--error);" onclick="deleteFile(${file.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddFileForm() {
    currentFileEdit = null;

    if (fileForm) fileForm.reset();

    document.getElementById('fileModalTitle').textContent = 'Aggiungi Documento';

    hideFileError();

    if (fileModal) fileModal.classList.add('active');
}

async function openEditFileForm(fileId) {
    try {
        const { data: file, error } = await supabaseClient
            .from('tour_files')
            .select('*')
            .eq('id', fileId)
            .single();

        if (error) throw error;
        if (!file) throw new Error('File non trovato');

        currentFileEdit = file;

        // Fill form
        document.getElementById('fileName').value = file.name;
        document.getElementById('fileType').value = file.file_type;
        document.getElementById('fileUrl').value = file.url;
        document.getElementById('fileNotes').value = file.notes || '';

        document.getElementById('fileModalTitle').textContent = 'Modifica Documento';

        hideFileError();

        if (fileModal) fileModal.classList.add('active');

    } catch (error) {
        console.error('Load file error:', error);
        alert('‚ùå Errore caricamento file:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function handleSaveFile(e) {
    e.preventDefault();
    hideFileError();

    if (!currentTourDetail || !currentTourDetail.id) {
        showFileError('Tour non selezionato');
        return;
    }

    const fileData = {
        tour_id: currentTourDetail.id,
        name: document.getElementById('fileName').value,
        file_type: document.getElementById('fileType').value,
        url: document.getElementById('fileUrl').value,
        notes: document.getElementById('fileNotes').value || null
    };

    try {
        if (currentFileEdit && currentFileEdit.id) {
            // Update existing file
            const { error } = await supabaseClient
                .from('tour_files')
                .update(fileData)
                .eq('id', currentFileEdit.id);

            if (error) throw error;
        } else {
            // Create new file
            const { error } = await supabaseClient
                .from('tour_files')
                .insert([fileData]);

            if (error) throw error;
        }

        if (fileModal) fileModal.classList.remove('active');

        loadFiles();

    } catch (error) {
        console.error('Save file error:', error);
        showFileError(error.message || 'Errore salvataggio file');
    }
}

async function deleteFile(fileId) {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo file?')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('tour_files')
            .delete()
            .eq('id', fileId);

        if (error) throw error;

        loadFiles();

    } catch (error) {
        console.error('Delete file error:', error);
        alert('‚ùå Errore eliminazione file:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function showFileError(message) {
    if (fileError) {
        fileError.textContent = message;
        fileError.classList.add('show');
    } else {
        alert('Errore: ' + message);
    }
}

function hideFileError() {
    if (fileError) {
        fileError.classList.remove('show');
    }
}

// ===== SCREEN NAVIGATION =====

function showScreen(screenName) {
    if (screenName === 'dashboard') {
        dashboardScreen.classList.add('active');
        restaurantDatabaseScreen.classList.remove('active');
        loadTours();
    } else if (screenName === 'restaurantDatabase') {
        dashboardScreen.classList.remove('active');
        restaurantDatabaseScreen.classList.add('active');
        loadSharedRestaurants();
    }
}

// ===== SHARED RESTAURANT DATABASE FUNCTIONS =====

async function loadSharedRestaurants() {
    const sharedRestaurantsList = document.getElementById('sharedRestaurantsList');
    if (!sharedRestaurantsList) return;

    try {
        sharedRestaurantsList.innerHTML = '<p class="loading">Caricamento...</p>';

        const { data: restaurants, error } = await supabaseClient
            .from('shared_restaurants')
            .select('*')
            .order('city', { ascending: true });

        if (error) throw error;

        if (!restaurants || restaurants.length === 0) {
            sharedRestaurantsList.innerHTML = '<p class="loading">Nessun ristorante nel database ancora. Sii il primo ad aggiungerne uno!</p>';
        } else {
            displaySharedRestaurants(restaurants);
        }
    } catch (error) {
        console.error('Load shared restaurants error:', error);
        sharedRestaurantsList.innerHTML = '<p class="loading" style="color: var(--error);">Errore caricamento</p>';
        alert('‚ùå Errore caricamento database ristoranti:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function displaySharedRestaurants(restaurants) {
    const sharedRestaurantsList = document.getElementById('sharedRestaurantsList');
    if (!sharedRestaurantsList) return;

    sharedRestaurantsList.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">` +
        restaurants.map(restaurant => {
            const stars = '‚≠ê'.repeat(Math.round(restaurant.rating_avg || 0));
            return `
                <div class="data-card">
                    <h4 style="margin: 0 0 8px 0;">${restaurant.restaurant_name}</h4>
                    <div class="meta">üìç ${restaurant.city}${restaurant.address ? ' - ' + restaurant.address : ''}</div>
                    ${restaurant.cuisine_type ? `<div class="meta">üçΩÔ∏è ${restaurant.cuisine_type}</div>` : ''}
                    ${restaurant.price_range ? `<div class="meta">${restaurant.price_range}</div>` : ''}
                    ${restaurant.phone ? `<div class="meta">üìû ${restaurant.phone}</div>` : ''}
                    <div style="margin-top: 8px;">
                        ${restaurant.tl_free ? '<span class="badge badge-green">üéÅ TL Free</span>' : ''}
                        ${restaurant.has_commission ? '<span class="badge badge-yellow">üí∞ Commission ' + (restaurant.commission_percentage || '') + '%</span>' : ''}
                        ${restaurant.discount_percentage ? '<span class="badge badge-blue">üè∑Ô∏è Discount ' + restaurant.discount_percentage + '%</span>' : ''}
                    </div>
                    ${stars ? `<div style="margin-top: 8px;">${stars} (${restaurant.total_ratings || 0})</div>` : ''}
                    ${restaurant.notes ? `<div class="meta" style="margin-top: 8px;">üí¨ ${restaurant.notes}</div>` : ''}
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 13px;" onclick="openRatingModal('${restaurant.id}')">‚≠ê Vota</button>
                    </div>
                </div>
            `;
        }).join('') + '</div>';

    window.allSharedRestaurants = restaurants;
}

async function handleSaveSharedRestaurant(e) {
    e.preventDefault();

    if (!currentTL || !currentTL.id) {
        alert('‚ùå Errore: TL non identificato');
        return;
    }

    const restaurantData = {
        restaurant_name: document.getElementById('sharedRestaurantName').value,
        city: document.getElementById('sharedRestaurantCity').value,
        address: document.getElementById('sharedRestaurantAddress').value || null,
        phone: document.getElementById('sharedRestaurantPhone').value || null,
        cuisine_type: document.getElementById('sharedCuisineType').value || null,
        price_range: document.getElementById('sharedPriceRange').value || null,
        tl_free: document.getElementById('sharedTlFree').checked,
        has_commission: document.getElementById('sharedHasCommission').checked,
        commission_percentage: document.getElementById('sharedCommissionPerc').value ? parseInt(document.getElementById('sharedCommissionPerc').value) : null,
        discount_percentage: document.getElementById('sharedDiscountPerc').value ? parseInt(document.getElementById('sharedDiscountPerc').value) : null,
        notes: document.getElementById('sharedNotes').value || null,
        added_by_tl_id: currentTL.id
    };

    try {
        const { error } = await supabaseClient
            .from('shared_restaurants')
            .insert([restaurantData]);

        if (error) throw error;

        alert('‚úÖ Ristorante aggiunto al database condiviso!');

        if (sharedRestaurantModal) sharedRestaurantModal.classList.remove('active');
        if (sharedRestaurantForm) sharedRestaurantForm.reset();

        loadSharedRestaurants();

    } catch (error) {
        console.error('Save shared restaurant error:', error);
        alert('‚ùå Errore:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

function openRestaurantSearchModal() {
    if (restaurantModal) restaurantModal.classList.remove('active');
    if (restaurantSearchModal) restaurantSearchModal.classList.add('active');
}

async function performRestaurantSearch() {
    const city = document.getElementById('searchCity').value;
    const cuisine = document.getElementById('searchCuisine').value;

    if (!city && !cuisine) {
        alert('Inserisci almeno un filtro');
        return;
    }

    try {
        searchResultsList.innerHTML = '<p class="loading">Ricerca...</p>';

        let query = supabaseClient.from('shared_restaurants').select('*');

        if (city) query = query.ilike('city', `%${city}%`);
        if (cuisine) query = query.ilike('cuisine_type', `%${cuisine}%`);

        const { data: restaurants, error } = await query.order('rating_avg', { ascending: false });

        if (error) throw error;

        if (!restaurants || restaurants.length === 0) {
            searchResultsList.innerHTML = '<p class="loading">Nessun risultato</p>';
            return;
        }

        searchResultsList.innerHTML = restaurants.map(r => `
            <div class="data-card">
                <h4>${r.restaurant_name}</h4>
                <div class="meta">üìç ${r.city}</div>
                ${r.cuisine_type ? `<div class="meta">üçΩÔ∏è ${r.cuisine_type}</div>` : ''}
                <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="copyRestaurantToTour('${r.id}')">‚ûï Aggiungi al Tour</button>
            </div>
        `).join('');

    } catch (error) {
        console.error('Search error:', error);
        alert('‚ùå Errore ricerca:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}

async function copyRestaurantToTour(restaurantId) {
    const restaurant = window.allSharedRestaurants?.find(r => r.id === restaurantId);
    if (!restaurant || !currentTourDetail) {
        alert('‚ùå Errore');
        return;
    }

    // Pre-populate form
    document.getElementById('restaurantDay').value = '';
    document.getElementById('restaurantName').value = restaurant.restaurant_name;
    document.getElementById('restaurantCity').value = restaurant.city;
    document.getElementById('restaurantAddress').value = restaurant.address || '';
    document.getElementById('restaurantPhone').value = restaurant.phone || '';
    document.getElementById('restaurantNotes').value = restaurant.notes || '';

    // Close search modal
    if (restaurantSearchModal) restaurantSearchModal.classList.remove('active');
    // Open restaurant form
    if (restaurantModal) restaurantModal.classList.add('active');

    alert('‚úÖ Dati copiati! Seleziona il giorno e salva.');
}

function openRatingModal(restaurantId) {
    document.getElementById('ratingRestaurantId').value = restaurantId;
    document.getElementById('ratingValue').value = '';
    document.getElementById('ratingNotes').value = '';

    // Reset stars
    document.querySelectorAll('.star-rating').forEach(s => s.classList.remove('selected'));

    if (ratingModal) ratingModal.classList.add('active');
}

async function handleSubmitRating(e) {
    e.preventDefault();

    const restaurantId = document.getElementById('ratingRestaurantId').value;
    const rating = parseInt(document.getElementById('ratingValue').value);
    const notes = document.getElementById('ratingNotes').value;

    if (!rating || !currentTL) {
        alert('‚ùå Seleziona una valutazione');
        return;
    }

    try {
        // Insert rating
        const { error: ratingError } = await supabaseClient
            .from('restaurant_ratings')
            .upsert([{
                restaurant_id: restaurantId,
                tl_id: currentTL.id,
                rating: rating,
                notes: notes || null
            }], { onConflict: 'restaurant_id,tl_id' });

        if (ratingError) throw ratingError;

        // Recalculate average
        const { data: ratings } = await supabaseClient
            .from('restaurant_ratings')
            .select('rating')
            .eq('restaurant_id', restaurantId);

        const avg = ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length;

        await supabaseClient
            .from('shared_restaurants')
            .update({
                rating_avg: avg,
                total_ratings: ratings.length
            })
            .eq('id', restaurantId);

        alert('‚úÖ Valutazione inviata!');

        if (ratingModal) ratingModal.classList.remove('active');
        loadSharedRestaurants();

    } catch (error) {
        console.error('Rating error:', error);
        alert('‚ùå Errore:\n\n' + (error.message || 'Errore sconosciuto'));
    }
}
    </script>
</body>
</html>
